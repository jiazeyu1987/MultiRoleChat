多角色对话系统后端需求说明书（Flask）
====================================

一、文档目的与范围
------------------

- 本文档基于《多角色对话系统业务需求说明书》与整体技术架构，明确后端（Flask 服务）的功能需求与设计约束。
- 重点内容：
  - 服务模块划分与职责；
  - REST 接口端点列表（不含具体字段格式，详见通信文档）；
  - 数据库实体模型与关系；
  - 会话执行与流程引擎的关键行为；
  - 非功能性要求（性能、日志、安全等）。


二、整体后端结构与模块
----------------------

1. 技术栈与运行环境
- 使用 Flask 作为 Web 框架，提供 REST 风格接口。
- 使用 SQLAlchemy（或兼容 ORM）访问关系型数据库：
  - 开发环境可用 SQLite；
  - 生产环境可扩展为 MySQL/PostgreSQL。

2. 模块划分（逻辑）
- API 层（Blueprint）：
  - `roles` 模块：角色管理相关接口。
  - `flows` 模块：流程模板及步骤管理接口。
  - `sessions` 模块：会话管理与执行接口。
  - `messages` 模块：消息历史查询与导出接口。
  - （可选）`auth` 模块：鉴权与用户管理接口。
- 服务层（Service）：
  - `RoleService`：角色的创建、编辑、复制、删除、查询。
  - `FlowService`：流程模板的创建、编辑、删除、版本管理，步骤的增删改查。
  - `SessionService`：会话创建、状态流转、保存/加载/分支、结束/暂停。
  - `FlowEngineService`：对话流程执行引擎，负责任务编排和大模型调用。
  - `MessageService`（可合并在 SessionService 中）：消息的存储、查询与导出。
  - `LLMService`：统一封装对外部大模型 API 的调用。
  - `HistoryService`：复杂历史查询与导出逻辑。
- 基础设施层：
  - 配置管理；
  - 数据库连接管理；
  - 日志与监控；
  - （可选）异步任务队列（如 Celery）。


三、数据库实体模型需求
----------------------

1. Role（角色）
- 字段需求：
  - `id`：主键，自增。
  - `name`：角色名称，唯一或至少在同一用户空间内不重复。
  - `type`：角色类型标签（教师/学生/专家/官员/律师等，可选）。
  - `description`：身份描述文字。
  - `style`：发言风格描述。
  - `constraints`：言论边界说明（文本）。
  - `focus_points`：默认关注点（如 JSON 数组）。
  - `created_at`、`updated_at`：时间戳。
  - （可选）`is_builtin`：是否为系统预置角色。

2. FlowTemplate（流程模板）
- 字段需求：
  - `id`：主键。
  - `name`：模板名称。
  - `type`：模板类型（教学/评审/辩论等）。
  - `description`：模板描述。
  - `version`：版本号。
  - `is_active`：是否启用。
  - `termination_config`：会话结束条件配置（JSON），包含如：
    - `max_steps`：最大步骤数；
    - `max_rounds`：最大轮数；
    - `end_step_ids`：结束节点步骤 ID 列表；
    - `on_error`：错误策略（如 stop/retry/skip_step）。
  - `created_at`、`updated_at`。

3. FlowStep（流程步骤）
- 字段需求：
  - `id`：主键。
  - `flow_template_id`：所属模板 ID。
  - `order`：步骤执行顺序或优先级。
  - `speaker_role_ref`：发言角色引用（模板内角色标识，如“teacher”）。
  - `target_role_ref`：目标角色引用（可空）。
  - `task_type`：发言任务类型（提问/回答/质疑/总结等）。
  - `context_scope`：上下文策略（枚举，例如 last_n_messages/last_round/all/custom）。
  - `context_param`：上下文策略参数（如 N 值）。
  - `loop_config`：循环配置（JSON），如最大循环次数。
  - `condition_config`：条件跳转配置（JSON），包括条件类型、条件分支等。
  - `next_step_id`：缺省情况下的后续步骤 ID（线性流程使用）。

4. Session（会话）
- 字段需求：
  - `id`：主键。
  - `user_id`：所属用户 ID（如有多用户需求）。
  - `topic`：会话主题。
  - `flow_template_id`：所使用的模板 ID。
  - `flow_snapshot`：模板快照（JSON，保存创建会话时模板版本与步骤信息）。
  - `roles_snapshot`：参与角色及其映射关系快照（JSON）。
  - `status`：会话状态（未开始/进行中/暂停/已结束/异常终止）。
  - `current_step_id`：当前执行到的流程步骤 ID。
  - `current_round`：当前轮次序号。
  - `executed_steps_count`：已执行步骤计数。
  - `error_reason`：异常终止时的错误原因。
  - `created_at`、`updated_at`、`ended_at`。

5. SessionRole（会话角色）
- 字段需求：
  - `id`：主键。
  - `session_id`：所属会话 ID。
  - `role_ref`：模板内角色标识（如“teacher”）。
  - `role_id`：实际 Role 实体 ID。

6. Message（消息）
- 字段需求：
  - `id`：主键。
  - `session_id`：所属会话。
  - `speaker_session_role_id`：发言会话角色 ID。
  - `target_session_role_id`：目标会话角色 ID（可空）。
  - `reply_to_message_id`：所回应的消息 ID（可空）。
  - `content`：消息正文。
  - `content_summary`：内容摘要，用于检索、条件判断。
  - `round_index`：第几轮对话（从 1 开始）。
  - `section`：话题阶段标识（如“问题提出”“方案讨论”“总结”）。
  - `created_at`：时间戳。

7. 用户与鉴权（如需要）
- 可选 User 表：
  - `id`、`username`、`password_hash`、`created_at` 等。
- 为简化，本阶段可使用单一用户或简单 token 机制。


四、REST 接口端点列表（概要）
----------------------------

> 注：本节仅列出端点与功能说明；请求/响应字段详见《多角色对话系统通信协议说明》。

1. 角色管理相关
- `GET /api/roles`：
  - 功能：分页查询角色列表，可按名称、类型筛选。
- `POST /api/roles`：
  - 功能：创建新角色。
- `GET /api/roles/{id}`：
  - 功能：获取指定角色详情。
- `PUT /api/roles/{id}`：
  - 功能：更新指定角色信息。
- `DELETE /api/roles/{id}`：
  - 功能：删除指定角色（如为系统预置角色，可限制删除）。

2. 流程模板与步骤相关
- `GET /api/flows`：
  - 功能：查询流程模板列表，支持按名称、类型筛选。
- `POST /api/flows`：
  - 功能：创建新的流程模板及其步骤列表。
- `GET /api/flows/{id}`：
  - 功能：获取模板详情及步骤列表。
- `PUT /api/flows/{id}`：
  - 功能：更新模板基本信息及步骤列表（整体覆盖式更新）。
- `DELETE /api/flows/{id}`：
  - 功能：删除模板（如已绑定会话，需考虑限制或软删除）。

3. 会话管理与执行相关
- `GET /api/sessions`：
  - 功能：按条件查询会话列表（主题关键字、状态、时间范围等）。
- `POST /api/sessions`：
  - 功能：创建新会话。
  - 逻辑：
    - 读取指定模板与角色配置；
    - 生成 `flow_snapshot` 与 `roles_snapshot`；
    - 初始化会话状态（未开始，current_step 从模板的起始步骤开始）。
- `GET /api/sessions/{id}`：
  - 功能：获取会话详细信息（不含或只含简略消息列表）。
- `POST /api/sessions/{id}/run-next-step`：
  - 功能：执行当前会话的下一流程步骤。
  - 核心逻辑：
    - 校验会话状态为“进行中”或“未开始”，且无步骤处于运行中；
    - 根据 `current_step_id` 与 `flow_snapshot` 查找当前步骤定义；
    - 根据步骤定义从 Message 中抽取上下文（依照 `context_scope` 和参数）；
    - 组织对 LLMService 的请求（包含角色信息、任务类型、目标对象、上下文摘要）；
    - 调用 LLMService 获取生成内容；
    - 写入 Message 记录；
    - 更新 Session 的当前步骤/轮次/执行计数；
    - 根据步骤的 `condition_config` 和模板的 `termination_config` 判断是否结束或跳转到下一个步骤。
- `POST /api/sessions/{id}/finish`：
  - 功能：主动结束会话，状态置为“已结束”，不再允许执行下一步。
- （可选）`POST /api/sessions/{id}/pause`：
  - 功能：将会话状态置为“暂停”，用于中途中止自动执行。

4. 消息与历史相关
- `GET /api/sessions/{id}/messages`：
  - 功能：查询某会话的消息历史；
  - 支持按角色、关键字、时间、轮次等过滤；
  - 支持分页。
- `GET /api/sessions/{id}/export`：
  - 功能：导出会话记录为文本或 Markdown。

5. 鉴权（如需要）
- `POST /api/auth/login`：
  - 功能：用户登录，获取访问 token。
- 可选刷新 token/登出接口。


五、流程引擎与业务规则
----------------------

1. 单步执行规则
- FlowEngineService 执行 `run-next-step` 时需保证：
  - 同一会话在任一时刻仅有一个步骤处于执行中；
  - 若上次执行已经完成且客户端因网络问题重试请求，应能检测到重复请求并返回已有结果（幂等性）。

2. 上下文选择与提示词构造
- 根据 FlowStep 的 `context_scope` 与参数，选择合适的历史消息：
  - `last_n_messages`：取最近 N 条消息；
  - `last_round`：取最近一轮完整对话消息；
  - `all`：取当前会话全部消息（适合短会话）；
  - `custom`：预留扩展。
- LLM 请求中需包含的信息：
  - 当前角色的身份描述、发言风格、言论边界、默认关注点；
  - 当前会话主题、流程阶段（task_type、section）；
  - 正在回应的目标角色/目标消息摘要；
  - 已达成共识与尚存分歧的摘要（可选）。

3. 条件跳转与循环控制
- 根据步骤的 `condition_config` 实现条件分支：
  - 支持人工选择分支；
  - 支持根据消息标签或摘要进行简单自动分支。
- 根据 `loop_config` 与全局 `termination_config` 控制循环：
  - 若循环次数达到上限或满足结束条件，应停止循环并进入下一逻辑片段或结束会话。

4. 结束条件与异常处理
- 满足以下任意条件之一时会话结束：
  - 执行步骤数达到 `termination_config.max_steps`；
  - 轮次达到 `termination_config.max_rounds`；
  - 当前步骤 ID 在 `termination_config.end_step_ids` 中；
  - 用户主动结束会话；
  - LLM 服务持续失败或超时且策略为 `stop`。
- 异常记录：
  - 在会话记录中写入 `error_reason`；
  - 将状态标记为“异常终止”。


六、非功能性要求
----------------

1. 性能与并发
- 系统应支持多个会话并行执行：
  - 同一会话内保证顺序执行（单步锁或状态检查）；
  - 不同会话之间允许并发。
- 对 LLM 调用应设置合理的超时时间，并限制并发数以防止资源耗尽。

2. 日志与监控
- 为每次会话执行步骤记录日志：
  - 会话 ID、步骤 ID、发言角色、目标角色；
  - 使用的上下文条数；
  - LLM 请求时间与响应时间；
  - 失败原因（如有）。

3. 安全与合规
- 在 LLM 提示词中注入角色言论边界，限制产生不合规内容；
- 对于涉及专业领域（法律、医疗等）的角色，对外在界面和导出内容中给出“仅供参考”的提示。
七、补充说明
----------------

1. 分支会话支持
- 后端应提供 `POST /api/sessions/{id}/branch` 接口，用于基于现有会话创建分支会话，具体字段与返回格式详见通信文档。
- 分支逻辑示例：
  - 从指定的 `from_message_id`（或默认最新消息）截取历史，生成新的 Session 记录；
  - 复制 `flow_snapshot` 与 `roles_snapshot`，并将新会话的执行位置设置为该消息之后的步骤；
  - 新会话拥有独立的消息流与状态，不影响原始会话。

2. 会话自动保存语义
- 每次执行 `run-next-step`、`finish`、`branch`、`pause` 等操作时，后端应立即将最新状态持久化到数据库，无需前端显式调用“保存会话”接口。
- 业务需求中的“保存会话”可以理解为：“系统保证会话过程和状态在关键操作后被可靠保存，并可通过查询接口重新加载或继续执行”。
