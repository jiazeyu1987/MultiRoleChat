多角色对话系统技术架构设计（React + Flask）
===========================================

一、总体架构
------------

1. 技术栈概述
- 前端：React 单页应用（SPA），负责角色管理、流程编排、会话执行、历史浏览等交互界面。
- 后端：Flask Web 服务，提供 REST API（可预留 WebSocket/SSE 通道），负责业务编排、上下文管理、与大模型服务对接和数据持久化。
- 存储层：关系型数据库（开发阶段可使用 SQLite，生产环境可扩展为 MySQL/PostgreSQL），通过 ORM（如 SQLAlchemy）对核心业务实体建模。
- 模型服务：通过独立的大模型服务抽象（LLMService）访问外部模型，业务逻辑与具体模型厂商/接口解耦。

2. 逻辑分层
- 表现层（前端 React）：
  - 渲染角色、流程、会话和消息等数据；
  - 提供可视化流程配置与对话控制操作；
  - 通过统一的 API 客户端与后端交互。
- 应用层（Flask API + Service）：
  - 接收前端请求、进行参数校验与权限检查；
  - 调用领域服务（FlowEngineService、SessionService 等）完成业务操作；
  - 组织返回前端所需的视图数据。
- 领域层（领域服务 + ORM 模型）：
  - 定义 Role、FlowTemplate、FlowStep、Session、Message 等核心业务模型；
  - 实现对话流程编排、上下文选择、历史管理等业务规则。
- 基础设施层：
  - 数据库访问（ORM）、配置管理、日志与监控；
  - 外部大模型接口封装（LLMService）、异步任务队列（可选）。


二、后端技术架构（Flask）
-------------------------

1. 项目结构（示例）
- `app/__init__.py`：应用工厂、配置加载、蓝图注册。
- `app/config.py`：环境配置（数据库连接、模型服务地址、鉴权配置等）。
- `app/models/`：ORM 模型定义，如：
  - `role.py`：角色实体；
  - `flow.py`：流程模板与流程步骤实体；
  - `session.py`：会话与会话角色实体；
  - `message.py`：消息实体。
- `app/api/`：REST 接口层，按业务域划分蓝图：
  - `roles`：角色管理接口；
  - `flows`：流程模板与步骤管理接口；
  - `sessions`：会话管理与执行接口；
  - `messages`：消息查询接口。
- `app/services/`：领域服务层：
  - `FlowEngineService`：对话流程编排与执行；
  - `SessionService`：会话生命周期管理；
  - `RoleService`：角色配置管理；
  - `LLMService`：大模型调用封装；
  - `HistoryService`：历史记录与导出。
- `app/schemas/`：请求/响应的数据结构与校验（如基于 Marshmallow/Pydantic）。

2. 核心服务职责
- FlowEngineService（流程引擎服务）
  - 根据已保存的 FlowTemplate 和 FlowStep，驱动多角色对话流程：
    - 确定当前应执行的步骤（发言角色、任务类型、上下文范围、循环/条件配置等）；
    - 根据上下文配置选择需要提供给模型的历史消息（如最近 N 条、上一轮对话、全部历史等）；
    - 组织模型提示词（包含角色身份、当前任务、目标对象等信息），调用 LLMService 生成回复；
    - 将生成的消息持久化到 Message 表中，并更新会话当前步骤/轮次；
    - 根据循环与条件配置判断是否进入下一步骤或结束会话。
- SessionService（会话服务）
  - 创建会话：绑定用户、选择流程模板与具体角色，生成会话级快照（当时的角色与流程配置）；
  - 控制会话状态：确保同一时间仅有一个步骤在执行，维护会话状态（进行中、已结束、异常终止等）；
  - 提供继续对话、终止会话、加载历史会话并续聊等操作。
- LLMService（大模型服务）
  - 负责与外部大模型服务进行 HTTP 调用；
  - 统一封装请求参数：角色身份/风格、当前任务描述、上下文消息文本或摘要等；
  - 支持为不同场景/角色配置不同的模型或参数（如温度、最大生成长度等）。
- HistoryService（历史服务）
  - 按会话、角色、时间范围、关键字等条件查询历史消息；
  - 提供对话历史导出能力（文本/Markdown 等格式）。

3. 基础设施与非功能
- 鉴权与用户管理：
  - 使用简单的 token 或 JWT 实现用户鉴权；
  - 后续可扩展为不同权限级别（普通用户/高级用户/管理员）。
- 日志与监控：
  - 记录关键业务事件（创建会话、执行步骤、调用模型、异常情况等）；
  - 记录大模型调用的参数摘要与返回结果摘要（注意隐私与安全）。
- 异步执行（可选）：
  - 对于耗时较长的生成任务，可接入 Celery + Redis 等；
  - 前端通过轮询或 SSE 获取任务执行结果。


三、前端技术架构（React）
-------------------------

1. 技术选型
- 框架：React + React Router 实现单页应用和多页面导航。
- 数据请求与缓存：React Query（或 SWR），统一管理 API 请求状态和缓存。
- UI 组件库：可选用 Ant Design 或 Material UI，提升表单/表格/对话框等常用组件开发效率。
- API 客户端：封装统一的 API 调用模块（基于 fetch/axios），处理基础 URL、鉴权 token 注入、错误统一提示等。

2. 主要页面与功能
- 角色管理页面
  - 角色列表：展示角色名称、身份描述、发言风格、言论边界、默认关注点等；
  - 角色编辑/新增弹窗：配置角色详细信息，并支持将常用角色保存为模板。
- 流程模板管理与编辑页面
  - 流程模板列表：展示模板名称、用途类型（教学/评审/辩论等）、版本号、启用状态等；
  - 流程模板详情：展示流程的步骤列表及流程基本信息；
  - 流程步骤编辑组件：
    - 配置发言角色、目标角色/目标消息、发言任务类型（如提问、回答、质疑、总结等）；
    - 配置上下文范围（最近 N 条消息、上一轮完整对话、全部历史等）；
    - 配置循环设置（如最大循环次数）和条件设置（如跳转到哪个步骤）。
  - 初期可采用“列表 + 右侧表单”的形式编辑步骤，后续可升级为可视化流程图编辑器。
- 会话管理与执行页面（对话剧场）
  - 会话列表：展示会话主题、使用流程模板、参与角色、当前状态（进行中/已结束）、创建时间等。
  - 会话详情/执行视图：
    - 左侧：展示会话中实际参与的角色及其配置快照；
    - 中间：按时间顺序展示消息时间线，明确标出“谁对谁说了什么”，支持按角色过滤；
    - 右侧：展示当前流程步骤信息（当前轮次、当前执行步骤、结束条件等）以及控制操作（执行下一步、暂停、结束会话）。
- 历史浏览与导出页面
  - 支持按会话、角色、关键字等条件过滤；
  - 提供导出按钮，调用后端接口导出对话记录。


四、核心数据模型设计（ORM 概念）
-------------------------------

1. Role（角色）
- 关键字段：
  - `id`：唯一标识；
  - `name`：角色名称（如“老师A”、“学生代表”）；
  - `description`：身份描述（背景、职责、专业领域、立场等）；
  - `style`：发言风格（严谨、鼓励式、质疑式、官方表述等）；
  - `constraints`：言论边界（不涉隐私、不做专业诊断等）；
  - `focus_points`：默认关注点（安全性、合规性、学习效果等）；
  - `extra_config`：扩展字段（JSON）。

2. FlowTemplate（流程模板）
- 关键字段：
  - `id`、`name`、`description`；
  - `type`：模板类型（教学/评审/辩论等）；
  - `version`：版本号；
  - `is_active`：是否启用。

3. FlowStep（流程步骤）
- 关键字段：
  - `id`、`flow_template_id`；
  - `order`：执行顺序；
  - `speaker_role_ref`：发言角色引用（模板内角色占位符，如“teacher”、“student”）；
  - `target_role_ref`：目标角色引用（可空）；
  - `task_type`：发言任务类型（提问、回答、质疑、总结等）；
  - `context_scope`：上下文取用范围（最近 N 条、上一轮、全部历史等）；
  - `loop_config`：循环配置（最大轮数等，JSON）；
  - `condition_config`：条件跳转配置（JSON）；
  - `next_step_id`：下一步骤 ID（线性流程使用）。

4. Session（会话）
- 关键字段：
  - `id`、`user_id`、`topic`（主题）；
  - `flow_template_id`：所使用的流程模板；
  - `flow_snapshot`：流程模板快照（JSON）；
  - `roles_snapshot`：参与角色配置快照（JSON）；
  - `status`：状态（进行中、已结束、异常）；
  - `created_at`、`ended_at`。

5. SessionRole（会话角色）
- 用于将流程模板中的角色引用（如“teacher”）映射到实际的 Role 实体。
- 关键字段：`id`、`session_id`、`role_ref`、`role_id`。

6. Message（消息）
- 关键字段：
  - `id`、`session_id`；
  - `speaker_session_role_id`：发言角色（会话内角色）；
  - `target_session_role_id`：目标角色（可空）；
  - `content`：消息正文；
  - `content_summary`：内容摘要（用于检索和条件判断）；
  - `reply_to_message_id`：针对的消息 ID（可空）；
  - `round_index`：第几轮对话；
  - `section`：所处小节（如“问题提出”、“方案讨论”、“总结”）；
  - `created_at`：创建时间。


五、接口设计示例（REST）
------------------------

1. 角色管理
- `GET /api/roles`：分页查询角色列表；
- `POST /api/roles`：创建角色；
- `GET /api/roles/{id}`：获取角色详情；
- `PUT /api/roles/{id}`：更新角色；
- `DELETE /api/roles/{id}`：删除角色。

2. 流程模板与步骤
- `GET /api/flows`：查询流程模板列表；
- `POST /api/flows`：创建流程模板；
- `GET /api/flows/{id}`：获取流程模板详情（含步骤列表）；
- `POST /api/flows/{id}/steps`：为流程模板新增步骤；
- `PUT /api/flows/{id}/steps/{stepId}`：更新指定步骤；
- `DELETE /api/flows/{id}/steps/{stepId}`：删除步骤。

3. 会话与执行
- `POST /api/sessions`：
  - 创建会话，入参包括：选用流程模板 ID、会话主题、用户与模板角色的映射关系等；
- `GET /api/sessions`：查询会话列表；
- `GET /api/sessions/{id}`：获取会话详情；
- `POST /api/sessions/{id}/run-next-step`：
  - 执行当前会话的下一流程步骤；
  - 内部完成上下文选取、模型调用、消息保存和流程推进；
  - 返回新生成的消息以及当前会话状态。
- `POST /api/sessions/{id}/finish`：主动结束会话。

4. 历史与导出
- `GET /api/sessions/{id}/messages`：
  - 查询某会话的消息历史；
  - 支持按角色、关键字等过滤。
- `GET /api/sessions/{id}/export`：
  - 导出会话记录（文本或 Markdown 格式），方便教学案例汇编、评审记录归档等。


六、实施步骤建议
----------------

1. 后端第一阶段
- 完成 Flask 项目初始化、配置管理与数据库连接；
- 定义核心 ORM 模型（Role、FlowTemplate、FlowStep、Session、SessionRole、Message）；
- 搭建基础 REST API 结构（蓝图、错误处理、简单鉴权），实现角色管理和流程模板基本增删改查。

2. 前端第一阶段
- 搭建 React 应用基本框架与路由结构；
- 实现角色管理页面（列表 + 新增/编辑）；
- 实现流程模板列表与详情展示，与后端接口打通。

3. 对话执行最小可用版本
- 在后端实现简化版 FlowEngineService，只支持线性顺序流程（不含循环与条件跳转）；
- 在前端实现会话创建页面与简单执行页面（手动触发“执行下一步”按钮，查看生成消息）；
- 验证端到端流程：配置角色 → 配置流程 → 创建会话 → 执行多角色轮流发言 → 查看历史。

4. 后续迭代方向
- 在流程引擎中逐步增加循环结构、条件跳转等高级能力；
- 完善上下文选择策略与提示词构造策略，以提高多轮对话的连贯性与针对性；
- 增强历史浏览与导出能力，支持更多过滤和可视化展示；
- 在前端增加可视化流程编辑（如流程图拖拽）、更友好的向导式配置体验。
七、需求适配性与架构评估
------------------------

1. 与业务需求的匹配性
- 角色管理：Role/SessionRole 模型和角色管理接口支持配置多角色的人设、风格、边界与关注点，能够满足“角色粒度的身份与行为管理”要求。
- 流程编排：FlowTemplate/FlowStep + FlowEngineService 可以表达顺序、循环与条件逻辑，并通过流程模板机制满足“对话剧本”与“流程模板库”的需求。
- 上下文与对话执行：FlowStep 中的上下文范围配置、Message 的上下文字段以及 FlowEngineService 的上下文选取逻辑，可以支撑“有上下文关联的发言”“同一时刻仅执行一个步骤”等业务要求。
- 历史与回放：Session + Message + HistoryService 支持快照保存、会话加载与续聊、按时间/角色/关键字查询和导出，满足“完整可追溯的对话历史”和“可回放”的目标。
- 非功能需求：通过 LLMService 解耦具体大模型服务，满足“不直接管理底层算力”；通过角色边界字段与 UI 提示满足“安全与合规”的约束；通过分层架构保证可扩展性。

2. 需要补充和明确的设计点
- 会话结束条件
  - 在 FlowTemplate 层增加“结束条件配置（termination_config）”的设计：如最大轮数/步数、明确的结束节点标识（某步执行后必然终止）、异常终止策略等（实现时可用 JSON 字段承载）。
  - FlowEngineService 在执行 `run-next-step` 时，需同时检查步骤级循环/条件配置与 FlowTemplate 的全局结束条件，决定是否继续推进还是标记 Session 为“已结束/异常终止”。
- 普通用户与高级用户模式
  - 在前端交互层明确两种模式：
    - 向导式（面向普通用户）：以“选择角色 → 选择模板 → 填写少量关键参数 → 开始对话”的流程为主，隐藏复杂的循环和条件配置，仅暴露常用选项（如轮次数量、参与角色）。
    - 高级模式（面向专业用户）：在流程模板编辑页面中展开所有高级字段（循环结构、条件跳转、复杂上下文策略等），支持精细化控制和模板复用。
  - 两种模式共享同一套后端接口和数据模型，仅在前端控制“展示哪些字段/默认值”。
- “谁在对谁说”的精细表达
  - 虽然 Message 中已经预留 `target_session_role_id` 和 `reply_to_message_id`，在 FlowStep 设计和 FlowEngineService 实现时需要明确：
    - 步骤可以显式指定回应的目标角色或具体上一条消息；
    - 模型提示词中要带上“你正在回应谁/哪条发言”，以增强对话感和业务可解释性。

3. 针对需求的结论性判断
- 从架构角度看，当前 React + Flask 分层设计、数据模型和服务划分能够覆盖业务需求文档中提出的核心能力（多角色管理、流程编排、上下文关联、历史回放等）。
- 通过在实现阶段落实上文补充的“结束条件配置”“双模式前端交互”“精细的目标消息引用”等设计细节，可以较好地满足普通用户与专业用户的双重使用场景，并降低后期演进成本。
- 因此，总体架构是可行且符合需求的，建议在后续详细设计与开发任务拆分时，以本架构为基础进一步细化各服务的接口与数据约束。 
