# ä¼šè¯å‰§åœº (Session Theater) å®Œæ•´é€»è¾‘åˆ†æ

## ğŸ“‹ æ¦‚è¿°

ä¼šè¯å‰§åœºæ˜¯ä¸€ä¸ªé«˜åº¦æ™ºèƒ½åŒ–çš„å¤šè§’è‰²å¯¹è¯æ‰§è¡Œç³»ç»Ÿï¼Œå°†æµç¨‹æ¨¡æ¿è½¬æ¢ä¸ºäº¤äº’å¼å¯¹è¯ã€‚å®ƒæä¾›ä»æ¨¡æ¿é€‰æ‹©åˆ°å¯¹è¯æ‰§è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œå…·å¤‡**æ— éœ€è§’è‰²æ˜ å°„çš„ç®€åŒ–æ¨¡å¼**å’Œä¼ ç»Ÿå¤æ‚æ¨¡å¼ï¼Œå…·æœ‰é«˜çº§åŠŸèƒ½å¦‚æ™ºèƒ½è§’è‰²è¯†åˆ«ã€å¤šç±»å‹ä¸Šä¸‹æ–‡ç®¡ç†å’Œå®æ—¶åˆ†æ­¥æ‰§è¡Œã€‚

## ğŸŒŸ æ ¸å¿ƒåˆ›æ–°

### ç®€åŒ–ç”¨æˆ·ä½“éªŒ
- **é›¶é…ç½®å¯åŠ¨**: é€‰æ‹©æµç¨‹æ¨¡æ¿ â†’ è¾“å…¥è®®é¢˜ â†’ å¼€å§‹å¯¹è¯
- **æ™ºèƒ½è§’è‰²è¯†åˆ«**: è‡ªåŠ¨åŒ¹é…é¢„å®šä¹‰è§’è‰²ï¼Œæ— éœ€æ‰‹åŠ¨æ˜ å°„
- **è‡ªåŠ¨ä¼šè¯å¯åŠ¨**: åˆ›å»ºåç«‹å³è¿›å…¥å¯æ‰§è¡ŒçŠ¶æ€

### æŠ€æœ¯æ¶æ„å‡çº§
- **å¤šæ¨¡å¼æ”¯æŒ**: ä¼ ç»Ÿè§’è‰²æ˜ å°„ + æ— éœ€è§’è‰²æ˜ å°„åŒæ¨¡å¼
- **å¤šç±»å‹ä¸Šä¸‹æ–‡**: å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å­—å…¸æ ¼å¼å…¨é¢æ”¯æŒ
- **é˜²å¾¡æ€§ç¼–ç¨‹**: å®Œæ•´çš„ç±»å‹éªŒè¯å’Œé”™è¯¯é™çº§å¤„ç†
- **æ™ºèƒ½é”™è¯¯æ¢å¤**: è‡ªåŠ¨å¤„ç†æ•°æ®ç±»å‹ä¸åŒ¹é…é—®é¢˜

## ğŸ”„ æ–‡æ¡£æ›´æ–°è¯´æ˜

**é‡è¦**: æœ¬æ–‡æ¡£å·²æ ¹æ®å®é™…ä»£ç å®ç°è¿›è¡Œä»¥ä¸‹å…³é”®ä¿®æ­£ï¼š

### 1. **æ•°æ®æ¨¡å‹ä¿®æ­£**
- `Session.user_id`: ç¡®è®¤ä¸ºæ™®é€šIntegerå­—æ®µï¼ˆéForeignKeyï¼‰
- æ˜ç¡®`flow_snapshot_dict`å’Œ`roles_snapshot_dict`å±æ€§æ–¹æ³•çš„å­˜åœ¨
- ç§»é™¤äº†ä¸å­˜åœ¨çš„cascadeå…³ç³»æè¿°
- `Message.speaker_session_role_id`: æ”¯æŒå¯ç©ºä»¥é€‚åº”æ— è§’è‰²æ˜ å°„æ¨¡å¼

### 2. **æœåŠ¡å±‚å®ç°ä¿®æ­£**
- `SessionService.create_session`: æ›´æ–°ä¸ºå®é™…å®ç°ï¼Œç§»é™¤`current_step_id`åˆå§‹åŒ–
- ä½¿ç”¨`flow_snapshot_dict`å±æ€§è€Œéç›´æ¥å­—æ®µæ“ä½œ
- æ›´æ–°å¼‚å¸¸ç±»å‹ä¸º`SessionNotFoundError`
- æ–°å¢`get_role_for_execution`æ–¹æ³•æ”¯æŒç›´æ¥è§’è‰²åç§°åŒ¹é…
- æ— è§’è‰²æ˜ å°„æ¨¡å¼ä¸‹è‡ªåŠ¨åˆ›å»ºä¸´æ—¶SessionRoleè®°å½•

### 3. **æµç¨‹å¼•æ“æ¶æ„ä¿®æ­£**
- **å…³é”®ä¿®æ­£**: `execute_next_step`ï¼ˆå¼‚æ­¥ï¼‰æ˜¯ä¸»æ–¹æ³•ï¼Œ`execute_next_step_sync`ä»…ä¸ºåŒ…è£…å™¨
- ä¿®æ­£äº†æ–‡æ¡£ä¸­å¯¹æ–¹æ³•ä¼˜å…ˆçº§çš„é”™è¯¯æè¿°
- æ›´æ–°äº†å®é™…çš„è°ƒç”¨æµç¨‹å’Œäº‹ä»¶å¾ªç¯å¤„ç†
- **æ–°å¢**: æ™ºèƒ½ä¸Šä¸‹æ–‡èŒƒå›´å¤„ç†ï¼Œæ”¯æŒå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å­—å…¸å¤šç§æ ¼å¼
- **æ–°å¢**: å®Œæ•´çš„ç±»å‹éªŒè¯å’Œé˜²å¾¡æ€§ç¼–ç¨‹æœºåˆ¶

### 4. **APIç«¯ç‚¹ä¿®æ­£**
- æ›´æ–°æ‰§è¡Œç«¯ç‚¹ä¸ºå®é™…è·¯å¾„ï¼š`POST /api/sessions/{id}/run-next-step`
- ä¿®æ­£ä¸ºè°ƒç”¨`execute_next_step(session_id)`å¼‚æ­¥æ–¹æ³•
- æ›´æ–°æ•°æ®éªŒè¯å’ŒSchemaåºåˆ—åŒ–æè¿°
- æ–°å¢ä¼šè¯è‡ªåŠ¨å¯åŠ¨åŠŸèƒ½ï¼šåˆ›å»ºåè‡ªåŠ¨è°ƒç”¨`start_session`

### 5. **å‰ç«¯å®ç°ä¿®æ­£**
- æ¶ˆæ¯æ¸²æŸ“ä½¿ç”¨`msg.id`ä½œä¸ºkeyï¼ˆé`index`ï¼‰
- æ›´æ–°ä¸ºå®é™…çš„åŠ¨æ€ä¸»é¢˜ç³»ç»Ÿå®ç°
- ä¿®æ­£äº†æ¡ä»¶æ¸²æŸ“é€»è¾‘
- **æ–°å¢**: æ™ºèƒ½è§’è‰²æ˜ å°„æ£€æµ‹ï¼Œè‡ªåŠ¨è¯†åˆ«æ— éœ€è§’è‰²æ˜ å°„çš„æµç¨‹ç±»å‹
- **æ–°å¢**: æ— è§’è‰²æ˜ å°„æµç¨‹çš„ç®€åŒ–UIç•Œé¢

### 6. **é”™è¯¯ä¿®å¤è®°å½•**
- **ä¿®å¤**: `'str' object has no attribute 'get'` - è§’è‰²æ˜ å°„æ•°æ®ç±»å‹ä¸åŒ¹é…
- **ä¿®å¤**: `NOT NULL constraint failed` - æ•°æ®åº“å­—æ®µçº¦æŸé—®é¢˜
- **ä¿®å¤**: `unhashable type: 'list'` - ä¸Šä¸‹æ–‡èŒƒå›´å¤„ç†ä¸­çš„åˆ—è¡¨ä½œä¸ºå­—å…¸é”®é—®é¢˜

---

---

## ğŸ¯ 1. å‰ç«¯ç»„ä»¶æ¶æ„

### 1.1 SessionCreator ç»„ä»¶
**ä½ç½®**: `fronted/src/MultiRoleDialogSystem.tsx:1173-1303`

#### æ ¸å¿ƒåŠŸèƒ½
- **æ¨¡æ¿é€‰æ‹©**: ä»APIè·å–æµç¨‹æ¨¡æ¿åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
- **è§’è‰²æ˜ å°„**: è‡ªåŠ¨æˆ–æ‰‹åŠ¨å°†æ¨¡æ¿è§’è‰²æ˜ å°„åˆ°å®é™…è§’è‰²å®ä¾‹
- **è¡¨å•éªŒè¯**: ç¡®ä¿æ‰€æœ‰å¿…å¡«å­—æ®µæ­£ç¡®å¡«å†™
- **ä¼šè¯åˆ›å»º**: è°ƒç”¨åç«¯APIåˆ›å»ºæ–°ä¼šè¯

#### å…³é”®å®ç°é€»è¾‘
```typescript
// æµç¨‹æ¨¡æ¿åŠ è½½
const [flows, setFlows] = useState<FlowTemplate[]>([]);
useEffect(() => {
  flowApi.getFlows().then(res => setFlows(res.items));
}, []);

// è§’è‰²æ˜ å°„é€»è¾‘
const refs = Array.from(new Set((flow.steps || []).map(s => s.speaker_role_ref).filter(Boolean)));
setFormData(prev => ({
  ...prev,
  role_mappings: refs.map(ref => ({
    role_ref: ref,
    role_id: matchedRole ? matchedRole.id : ''
  }))
}));

// ä¼šè¯åˆ›å»ºAPIè°ƒç”¨
const sessionData: CreateSessionRequest = {
  topic: formData.topic,
  flow_template_id: selectedFlow!.id,
  role_mappings: formData.role_mappings.reduce((acc, mapping) => {
    acc[mapping.role_ref] = Number(mapping.role_id);
    return acc;
  }, {} as Record<string, number>)
};
```

#### ç”¨æˆ·ç•Œé¢ç»“æ„
- **å¤´éƒ¨**: åˆ›å»ºå‘å¯¼æ ‡é¢˜å’Œæ­¥éª¤æŒ‡ç¤ºå™¨
- **æ¨¡æ¿é€‰æ‹©**: ä¸‹æ‹‰åˆ—è¡¨æ˜¾ç¤ºå¯ç”¨æµç¨‹æ¨¡æ¿
- **ä¸»é¢˜è¾“å…¥**: æ–‡æœ¬æ¡†è¾“å…¥ä¼šè¯ä¸»é¢˜
- **è§’è‰²æ˜ å°„**: è¡¨æ ¼å½¢å¼å±•ç¤ºè§’è‰²å¯¹åº”å…³ç³»
- **æ“ä½œæŒ‰é’®**: åˆ›å»ºå’Œå–æ¶ˆæ“ä½œ

### 1.2 SessionTheater ç»„ä»¶
**ä½ç½®**: `fronted/src/MultiRoleDialogSystem.tsx:1305-1499`

#### æ ¸å¿ƒåŠŸèƒ½
- **å®æ—¶æ¶ˆæ¯æ˜¾ç¤º**: æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºå¯¹è¯æ¶ˆæ¯
- **åˆ†æ­¥æ‰§è¡Œæ§åˆ¶**: ç”¨æˆ·æ§åˆ¶æ¯ä¸€æ­¥çš„æ‰§è¡Œ
- **ä¼šè¯çŠ¶æ€ç®¡ç†**: è·Ÿè¸ªä¼šè¯è¿›åº¦å’ŒçŠ¶æ€
- **æ¼”å‘˜ä¿¡æ¯å±•ç¤º**: ä¾§è¾¹æ æ˜¾ç¤ºå‚ä¸è§’è‰²

#### çŠ¶æ€ç®¡ç†
```typescript
const [session, setSession] = useState<Session | null>(null);
const [messages, setMessages] = useState<Message[]>([]);
const [generating, setGenerating] = useState(false);
```

#### UIç»„ä»¶ç»“æ„
- **å¤´éƒ¨åŒºåŸŸ**: ä¼šè¯ä¸»é¢˜ã€çŠ¶æ€å¾½ç« ã€æ¨¡æ¿IDã€è½®æ¬¡è®¡æ•°å™¨
- **ä¾§è¾¹æ **: è§’è‰²æ¼”å‘˜åˆ—è¡¨ï¼ˆå¤´åƒã€åç§°ã€çŠ¶æ€ï¼‰
- **ä¸»å¯¹è¯åŒº**: å†…è”æ¶ˆæ¯æ°”æ³¡ï¼ˆè§’è‰²å¤´åƒã€å†…å®¹ã€æ—¶é—´æˆ³ï¼‰
- **æ§åˆ¶é¢æ¿**: æ‰§è¡Œä¸‹ä¸€æ­¥ã€æš‚åœã€æ¢å¤ã€ç»ˆæ­¢æŒ‰é’®
- **åº•éƒ¨æ“ä½œ**: å¯¼å‡ºã€ç»Ÿè®¡ç­‰é¢å¤–åŠŸèƒ½

#### æ¶ˆæ¯æ˜¾ç¤ºé€»è¾‘
```typescript
// å®é™…çš„å†…è”æ¶ˆæ¯æ¸²æŸ“å®ç°ï¼ˆèŠ‚é€‰è‡ª SessionTheaterï¼‰
{messages.map(msg => {
  // ç®€åŒ–çš„è§’è‰²åˆ¤æ–­é€»è¾‘ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•
  const isTeacher = msg.speaker_role_name?.includes('è€å¸ˆ') || false;
  // Dynamic bubble color for teacher
  const roleColor = isTeacher ? `${theme.bgSoft} ${theme.text}` : 'bg-gray-100 text-gray-900';
  return (
    <div key={msg.id} className={`flex gap-4 max-w-3xl`}>
      <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center shrink-0 font-bold text-gray-600 text-sm">
        {msg.speaker_role_name?.[0] || '?'}
      </div>
      <div className="space-y-1">
        <div className="flex items-baseline gap-2">
          <span className="font-bold text-sm text-gray-900">{msg.speaker_role_name || 'æœªçŸ¥è§’è‰²'}</span>
          <span className="text-xs text-gray-400">{new Date(msg.created_at).toLocaleTimeString()}</span>
          {msg.target_role_name && <span className="text-xs text-gray-400">to {msg.target_role_name}</span>}
        </div>
        <div className={`px-4 py-3 rounded-2xl rounded-tl-none ${roleColor} text-sm leading-relaxed shadow-sm`}>
          {msg.content}
        </div>
        <div className="flex gap-2 opacity-0 hover:opacity-100 transition-opacity">
          <button className={`text-xs ${theme.text} hover:underline flex items-center gap-1`}>
            <GitBranch size={10} /> åˆ›å»ºåˆ†æ”¯
          </button>
        </div>
      </div>
    </div>
  );
})}
```

**å…³é”®å®ç°ç‰¹å¾**ï¼š
- **Keyå±æ€§**: ä½¿ç”¨ `msg.id` ä½œä¸ºReact key
- **ä¸»é¢˜ç³»ç»Ÿ**: ä½¿ç”¨åŠ¨æ€ä¸»é¢˜é¢œè‰² (`theme.bgSoft`, `theme.text`)
- **è§’è‰²é«˜äº®**: æ•™å¸ˆè§’è‰²ä½¿ç”¨ä¸»é¢˜è‰²é«˜äº®
- **æ¶ˆæ¯æ°”æ³¡**: æ”¯æŒåŠ¨æ€é¢œè‰²é…ç½®ã€é˜´å½±å’Œåˆ†æ”¯åˆ›å»ºå…¥å£

#### æ‰§è¡Œæ§åˆ¶é€»è¾‘
```typescript
// æ‰§è¡Œä¸‹ä¸€æ­¥éª¤ï¼ˆSessionTheater ä¸­çš„ handleNextStepï¼‰
const handleNextStep = async () => {
  if (!session) return;
  setGenerating(true);
  try {
    // è°ƒç”¨çœŸå®çš„APIæ‰§è¡Œä¸‹ä¸€æ­¥
    const result = await sessionApi.executeNextStep(session.id);

    // æ·»åŠ æ–°æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
    if (result.message) {
      setMessages(prev => [...prev, result.message]);
    }

    // æ›´æ–°ä¼šè¯çŠ¶æ€ï¼ˆå¦‚æœåç«¯è¿”å›äº†æ›´æ–°çš„ä¼šè¯ä¿¡æ¯ï¼‰
    if (result.execution_info && result.execution_info.is_finished) {
      setSession(prev => prev ? {
        ...prev,
        status: 'finished',
        updated_at: new Date().toISOString()
      } : null);
    }
  } catch (error) {
    handleError(error);
  } finally {
    setGenerating(false);
  }
};
```

---

## ğŸ”„ 2. æµç¨‹æ¨¡æ¿Stepæœºåˆ¶æ·±åº¦è§£æ

### 2.1 FlowTemplateå’ŒFlowStepçš„å…³ç³»ç»“æ„

#### FlowTemplateæ¨¡å‹
**ä½ç½®**: `backend/app/models/flow.py`

```python
class FlowTemplate(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    topic = db.Column(db.String(200), nullable=True)
    type = db.Column(db.String(50), nullable=False)
    description = db.Column(db.Text, nullable=True)
    version = db.Column(db.String(20), nullable=True)
    is_active = db.Column(db.Boolean, nullable=True, default=None)
    _termination_config = db.Column('termination_config', db.Text, nullable=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    # å…³ç³»ï¼šæ‰€æœ‰æ­¥éª¤æŒ‰orderæ’åº
    steps = db.relationship('FlowStep', lazy='dynamic', order_by='FlowStep.order')
```

#### FlowStepæ¨¡å‹
**ä½ç½®**: `backend/app/models/flow.py`

```python
class FlowStep(db.Model):
    # åŸºæœ¬å­—æ®µ
    id = db.Column(db.Integer, primary_key=True)
    flow_template_id = db.Column(db.Integer, db.ForeignKey('flow_templates.id'), nullable=False)
    order = db.Column(db.Integer, nullable=False)  # æ­¥éª¤é¡ºåº

    # è§’è‰²é…ç½®
    speaker_role_ref = db.Column(db.String(50), nullable=False)  # å‘è¨€è§’è‰²å¼•ç”¨
    target_role_ref = db.Column(db.String(50), nullable=True)    # ç›®æ ‡è§’è‰²å¼•ç”¨

    # ä»»åŠ¡é…ç½®
    task_type = db.Column(db.String(50), nullable=False)          # ä»»åŠ¡ç±»å‹
    description = db.Column(db.String(500), nullable=True)       # ä»»åŠ¡æè¿°

    # ä¸Šä¸‹æ–‡é…ç½®
    _context_scope = db.Column('context_scope', db.Text, nullable=False)
    _context_param = db.Column('context_param', db.Text, nullable=True)

    # é€»è¾‘é…ç½®ï¼ˆåŒ…å«å¾ªç¯é…ç½®ï¼‰
    _logic_config = db.Column('logic_config', db.Text, nullable=True)

    # æµç¨‹æ§åˆ¶
    next_step_id = db.Column(db.Integer, db.ForeignKey('flow_steps.id'), nullable=True)
```

### 2.2 Stepç»“åˆæœºåˆ¶

#### æ­¥éª¤æ‰§è¡Œé¡ºåº
```python
# é¡ºåºæ‰§è¡Œæœºåˆ¶
steps = flow_template.steps.order_by(FlowStep.order).all()

# ç¤ºä¾‹æ•°æ®ç»“æ„
{
  "flow_template": {
    "id": 1,
    "name": "æ•™å­¦å¯¹è¯æ¨¡æ¿",
    "steps": [
      {
        "id": 1,
        "order": 1,
        "speaker_role_ref": "teacher",
        "target_role_ref": "student",
        "task_type": "ask_question",
        "description": "å‘å­¦ç”Ÿæé—®"
      },
      {
        "id": 2,
        "order": 2,
        "speaker_role_ref": "student",
        "target_role_ref": "teacher",
        "task_type": "answer_question",
        "description": "å›ç­”è€å¸ˆçš„é—®é¢˜"
      }
    ]
  }
}
```

#### æ­¥éª¤æ¨è¿›é€»è¾‘
**ä½ç½®**: `backend/app/services/flow_engine_service.py:_determine_next_step`

```python
@staticmethod
def _determine_next_step(session: Session, current_step: FlowStep) -> Optional[int]:
    """
    ç¡®å®šä¸‹ä¸€æ­¥éª¤ID

    Args:
        session: ä¼šè¯å¯¹è±¡
        current_step: å½“å‰æ­¥éª¤

    Returns:
        Optional[int]: ä¸‹ä¸€æ­¥éª¤IDï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›None
    """
    # è·å–æµç¨‹æ¨¡æ¿çš„æ‰€æœ‰æ­¥éª¤
    flow_template = FlowTemplate.query.get(session.flow_template_id)
    if not flow_template:
        return None

    all_steps = flow_template.steps.order_by(FlowStep.order).all()

    # æŸ¥æ‰¾å½“å‰æ­¥éª¤åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
    current_index = None
    for i, step in enumerate(all_steps):
        if step.id == current_step.id:
            current_index = i
            break

    if current_index is None:
        return None

    # æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€æ­¥éª¤
    if current_index < len(all_steps) - 1:
        return all_steps[current_index + 1].id

    # æ£€æŸ¥å¾ªç¯é…ç½®
    loop_config = current_step.loop_config_dict
    if loop_config.get('enabled', False):
        max_loops = loop_config.get('max_loops', 1)
        if session.current_round < max_loops:
            # è¿”å›å¾ªç¯å¼€å§‹æ­¥éª¤
            loop_start_step_ref = loop_config.get('loop_start_role_ref')
            if loop_start_step_ref:
                for step in all_steps:
                    if step.speaker_role_ref == loop_start_step_ref:
                        return step.id
            # å¦‚æœæ²¡æœ‰æŒ‡å®šå¾ªç¯å¼€å§‹ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ­¥éª¤
            return all_steps[0].id if all_steps else None

    return None
```

### 2.3 å‘è¨€è€…æç¤ºè¯ç»„è£…æœºåˆ¶

#### è§’è‰²ä¿¡æ¯è·å–
```python
# Roleæ¨¡å‹ç»“æ„
class Role(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False, unique=True)
    prompt = db.Column(db.Text, nullable=False)  # ç»Ÿä¸€å­—æ®µï¼ŒåŒ…å«æ‰€æœ‰è§’è‰²ä¿¡æ¯
```

#### å¤æ‚ç‰ˆæç¤ºè¯æ„å»ºï¼ˆä¿ç•™ç‰ˆæœ¬ï¼‰
**ä½ç½®**: `backend/app/services/flow_engine_service.py:_build_prompt`

```python
@staticmethod
def _build_prompt(role: Role, step: FlowStep, context: Dict[str, Any]) -> str:
    # è§’è‰²ä¿¡æ¯
    role_info = f"""
ä½ æ˜¯{role.name}ã€‚
è§’è‰²æè¿°ï¼š{role.description}
å‘è¨€é£æ ¼ï¼š{role.style}
å…³æ³¨ç‚¹ï¼š{', '.join(role.focus_points_list)}
""".strip()

    # ä»»åŠ¡ä¿¡æ¯
    task_info = f"""
ä»»åŠ¡ç±»å‹ï¼š{step.task_type}
ä»»åŠ¡æè¿°ï¼š{step.description if step.description else 'æ— '}
""".strip()

    # ä¸Šä¸‹æ–‡ä¿¡æ¯
    context_info = f"""
ä¼šè¯ä¸»é¢˜ï¼š{context['session_topic']}
å½“å‰è½®æ¬¡ï¼š{context['current_round']}
å·²æ‰§è¡Œæ­¥éª¤æ•°ï¼š{context['step_count']}
""".strip()

    # å†å²æ¶ˆæ¯
    history_info = ""
    if context['history_messages']:
        history_info = "\nä¹‹å‰çš„å¯¹è¯ï¼š\n"
        for msg in context['history_messages']:
            speaker = msg['speaker_role'] or 'æœªçŸ¥è§’è‰²'
            content = msg['content'][:100] + "..." if len(msg['content']) > 100 else msg['content']
            history_info += f"{speaker}: {content}\n"

    # ç»„åˆå®Œæ•´æç¤ºè¯
    prompt = f"""{role_info}

{task_info}

{context_info}

{history_info}

è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šå’Œå½“å‰ä»»åŠ¡ï¼Œå‘è¡¨ä½ çš„è§‚ç‚¹ã€‚"""

    return prompt
```

#### ç®€åŒ–ç‰ˆæç¤ºè¯æ„å»ºï¼ˆå½“å‰ä½¿ç”¨ï¼‰
**ä½ç½®**: `backend/app/services/flow_engine_service.py:_build_simple_prompt`

```python
@staticmethod
def _build_simple_prompt(role: Role, step: FlowStep, context: Dict[str, Any]) -> str:
    prompt_parts = []

    # åŸºæœ¬è§’è‰²ä¿¡æ¯
    if role and hasattr(role, 'name'):
        role_desc = f"ä½ æ˜¯{role.name}"
        if hasattr(role, 'prompt') and role.prompt:
            role_desc += f"ã€‚{role.prompt}"
        prompt_parts.append(role_desc)

    # ä¼šè¯ä¸»é¢˜
    session_topic = context.get('session_topic', '')
    if session_topic:
        prompt_parts.append(f"ä¼šè¯ä¸»é¢˜ï¼š{session_topic}")

    # å½“å‰ä»»åŠ¡
    if step:
        task_desc = step.description if step.description else step.task_type
        prompt_parts.append(f"ä»»åŠ¡ï¼š{task_desc}")

    # å½“å‰è½®æ¬¡ä¿¡æ¯
    current_round = context.get('current_round', 1)
    step_count = context.get('step_count', 0)
    prompt_parts.append(f"ç¬¬{current_round}è½®å¯¹è¯ï¼Œç¬¬{step_count + 1}ä¸ªæ­¥éª¤")

    # ç®€å•çš„æŒ‡ä»¤
    prompt_parts.append("è¯·ä»¥è¯¥è§’è‰²çš„èº«ä»½è¿›è¡Œå›åº”ã€‚")

    return " ".join(prompt_parts)
```

### 2.4 ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶

#### ä¸Šä¸‹æ–‡èŒƒå›´é…ç½®
**ä½ç½®**: `backend/app/services/flow_engine_service.py:_select_context_messages`

```python
@staticmethod
def _select_context_messages(session: Session, current_step: FlowStep) -> List[Message]:
    base_query = Message.query.filter_by(session_id=session.id)

    # æ ¹æ®ä¸Šä¸‹æ–‡èŒƒå›´é€‰æ‹©æ¶ˆæ¯
    if current_step.context_scope == 'none':
        return []

    elif current_step.context_scope == 'last_message':
        return base_query.order_by(Message.created_at.desc()).limit(1).all()

    elif current_step.context_scope == 'last_round':
        return base_query.filter(
            Message.round_index == session.current_round - 1
        ).order_by(Message.created_at.asc()).all()

    elif current_step.context_scope == 'last_n_messages':
        n = current_step.context_param.get('n', 5)
        return base_query.order_by(Message.created_at.desc()).limit(n).all()

    elif current_step.context_scope == 'all':
        return base_query.order_by(Message.created_at.asc()).all()

    # æ”¯æŒè§’è‰²ç­›é€‰
    else:
        # æ„å»ºè§’è‰²åç§°åˆ°ä¼šè¯è§’è‰²IDçš„æ˜ å°„
        role_name_to_session_ids = {}
        session_roles = SessionService.get_role_mapping(session.id)
        for role_ref, role_info in session_roles.items():
            role_name_to_session_ids[role_ref] = role_info.get('session_role_id')

        role_names = []
        try:
            # å°è¯•è§£æä¸ºJSONæ•°ç»„
            parsed_scope = json.loads(current_step.context_scope) if current_step.context_scope else []
            if isinstance(parsed_scope, list):
                role_names = [name for name in parsed_scope if name in role_name_to_session_ids]
        except (json.JSONDecodeError, TypeError):
            # å¤„ç†å•ä¸ªè§’è‰²åç§°
            if current_step.context_scope in role_name_to_session_ids:
                role_names = [current_step.context_scope]

        # ç­›é€‰ç‰¹å®šè§’è‰²çš„æ¶ˆæ¯
        if role_names:
            all_session_role_ids = []
            for role_name in role_names:
                all_session_role_ids.extend(role_name_to_session_ids[role_name])

            return base_query.filter(
                Message.speaker_session_role_id.in_(all_session_role_ids)
            ).order_by(Message.created_at.asc()).all()

        return []
```

#### ä¸Šä¸‹æ–‡æ„å»ºæµç¨‹
```python
@staticmethod
def _build_context(session: Session, current_step: FlowStep) -> Dict[str, Any]:
    # è·å–ä¼šè¯è§’è‰²æ˜ å°„
    session_roles = SessionService.get_role_mapping(session.id)

    # è·å–å†å²æ¶ˆæ¯
    history_messages = FlowEngineService._select_context_messages(session, current_step)

    # æ„å»ºå®Œæ•´ä¸Šä¸‹æ–‡
    context = {
        'session_topic': session.topic,
        'current_round': session.current_round,
        'step_count': session.executed_steps_count,
        'session_roles': session_roles,
        'history_messages': [msg.to_dict() for msg in history_messages],
        'flow_template': {
            'id': session.flow_template_id,
            'name': session.flow_template.name if session.flow_template else None,
            'total_steps': len(session.flow_template.steps.all()) if session.flow_template else 0
        }
    }

    return context
```

### 2.5 æµè½¬é€»è¾‘æœºåˆ¶

#### é€€å‡ºæ¡ä»¶ + å¾ªç¯é…ç½®ç»“æ„
```python
@staticmethod
def _determine_next_step(session: Session, current_step: FlowStep) -> Optional[int]:
    """
    ç¡®å®šä¸‹ä¸€æ­¥éª¤IDï¼Œæ”¯æŒï¼š
    1ï¼‰åŸºäºLLMç»“æ„åŒ–è¾“å‡ºçš„é€€å‡ºæ¡ä»¶ï¼ˆexit_conditionï¼‰
    2ï¼‰çº¿æ€§æ¨è¿›ï¼ˆorderï¼‰
    3ï¼‰åŸºäºloop_configçš„å¾ªç¯æ§åˆ¶
    """
    # 1. ä¼˜å…ˆæ£€æŸ¥é€€å‡ºæ¡ä»¶ï¼šè‹¥æ»¡è¶³åˆ™ç›´æ¥ç»“æŸä¼šè¯
    if FlowEngineService._check_exit_condition(session, current_step):
        return None

    # 2. è·å–æµç¨‹æ¨¡æ¿çš„æ‰€æœ‰æ­¥éª¤
    flow_template = FlowTemplate.query.get(session.flow_template_id)
    if not flow_template:
        return None

    all_steps = flow_template.steps.order_by(FlowStep.order).all()

    # 3. æŸ¥æ‰¾å½“å‰æ­¥éª¤åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®
    current_index = None
    for i, step in enumerate(all_steps):
        if step.id == current_step.id:
            current_index = i
            break

    if current_index is None:
        return None

    # 4. é»˜è®¤çº¿æ€§æ¨è¿›
    if current_index < len(all_steps) - 1:
        return all_steps[current_index + 1].id

    # 5. æ£€æŸ¥å¾ªç¯é…ç½®ï¼ˆä»…åœ¨åˆ°è¾¾æœ€åä¸€æ­¥ä¸”æœªæ»¡è¶³é€€å‡ºæ¡ä»¶æ—¶ç”Ÿæ•ˆï¼‰
    loop_config = current_step.loop_config_dict
    if loop_config.get('enabled', False):
        max_loops = loop_config.get('max_loops', 1)
        if session.current_round < max_loops:
            # è¿”å›å¾ªç¯å¼€å§‹æ­¥éª¤
            loop_start_step_ref = loop_config.get('loop_start_role_ref')
            if loop_start_step_ref:
                for step in all_steps:
                    if step.speaker_role_ref == loop_start_step_ref:
                        return step.id
            # å¦‚æœæ²¡æœ‰æŒ‡å®šå¾ªç¯å¼€å§‹ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ­¥éª¤
            return all_steps[0].id if all_steps else None

    return None  # ç»“æŸä¼šè¯
```

**é‡è¦å‰æ**ï¼š
- **æ¨¡æ¿å‰æ**: æµç¨‹æ¨¡æ¿å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªæ­¥éª¤ï¼Œå¦åˆ™æ— æ³•åˆ›å»ºä¼šè¯
- **é€€å‡ºæ¡ä»¶ä¼˜å…ˆçº§**: è‹¥é…ç½®äº† `exit_condition` ä¸”æ»¡è¶³ï¼Œåˆ™æ— è®ºåé¢æ˜¯å¦è¿˜æœ‰æ­¥éª¤æˆ–å¾ªç¯ï¼Œéƒ½ç›´æ¥ç»“æŸä¼šè¯
- **å¾ªç¯é…ç½®é»˜è®¤å€¼**: `enabled=False`ï¼Œ`max_loops=1` ç¡®ä¿ä¸ä¼šæ— é™å¾ªç¯

#### é€€å‡ºæ¡ä»¶æ£€æŸ¥æœºåˆ¶
```python
@staticmethod
def _check_exit_condition(session: Session, current_step: FlowStep) -> bool:
    """
    æ£€æŸ¥å½“å‰æ­¥éª¤æ˜¯å¦æ»¡è¶³é€€å‡ºæ¡ä»¶

    å½“å‰ä¸»è¦æ”¯æŒåŸºäºLLMç»“æ„åŒ–è¾“å‡ºçš„é€€å‡ºæ¡ä»¶ï¼š
    - type: 'llm_accept_flag'
      è¦æ±‚å½“å‰æ­¥éª¤å¯¹åº”çš„å‘è¨€å†…å®¹æ˜¯JSONï¼Œå¹¶åŒ…å«å¸ƒå°”å­—æ®µ `accept`
      å½“ accept ä¸º True æ—¶è§†ä¸ºæ»¡è¶³é€€å‡ºæ¡ä»¶
    """
    logic_config = current_step.logic_config or {}
    exit_config = logic_config.get('exit_condition') if isinstance(logic_config, dict) else None

    if not exit_config or not isinstance(exit_config, dict):
        return False

    condition_type = exit_config.get('type')

    # åŸºäºLLMè¾“å‡ºçš„æ¥å—æ ‡å¿—
    if condition_type == 'llm_accept_flag':
        speaker_role_ref = current_step.speaker_role_ref
        if not speaker_role_ref:
            return False

        speaker_session_role = SessionService.get_session_role_by_ref(session.id, speaker_role_ref)
        if not speaker_session_role:
            return False

        # è·å–è¯¥è§’è‰²åœ¨æœ¬ä¼šè¯ä¸­æœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯ï¼ˆé€šå¸¸å°±æ˜¯åˆšåˆšç”Ÿæˆçš„è¿™æ¡ï¼‰
        last_message = (
            Message.query
            .filter_by(session_id=session.id, speaker_session_role_id=speaker_session_role.id)
            .order_by(Message.created_at.desc())
            .first()
        )
        if not last_message or not last_message.content:
            return False

        # å°è¯•å°†æ¶ˆæ¯å†…å®¹è§£æä¸ºJSONï¼Œå¹¶è¯»å–acceptå­—æ®µ
        try:
            data = json.loads(last_message.content)
            accept_value = data.get('accept')
            return bool(accept_value is True)
        except (json.JSONDecodeError, TypeError, ValueError):
            # éJSONæˆ–æ²¡æœ‰acceptå­—æ®µï¼Œåˆ™è®¤ä¸ºæœªæ»¡è¶³é€€å‡ºæ¡ä»¶
            return False

    # å…¶ä»–ç±»å‹çš„é€€å‡ºæ¡ä»¶å¯ä»¥åœ¨æ­¤æ‰©å±•
    return False
```

#### çŠ¶æ€æ›´æ–°æœºåˆ¶
```python
@staticmethod
def _update_session_after_step_execution(session: Session, executed_step: FlowStep) -> None:
    # æ›´æ–°æ‰§è¡Œè®¡æ•°
    session.executed_steps_count += 1
    session.updated_at = datetime.utcnow()

    # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›å…¥ä¸‹ä¸€è½®
    if FlowEngineService._should_start_new_round(session, executed_step):
        session.current_round += 1

    # ç¡®å®šä¸‹ä¸€æ­¥éª¤
    next_step_id = FlowEngineService._determine_next_step(session, executed_step)
    if next_step_id:
        session.current_step_id = next_step_id
    else:
        # æ²¡æœ‰ä¸‹ä¸€æ­¥éª¤ï¼Œç»“æŸä¼šè¯
        session.status = 'finished'
        session.ended_at = datetime.utcnow()

@staticmethod
def _should_start_new_round(session: Session, step: FlowStep) -> bool:
    """åˆ¤æ–­æ˜¯å¦åº”è¯¥å¼€å§‹æ–°çš„è½®æ¬¡"""
    # ç®€å•çš„é€»è¾‘ï¼šå½“æ‰§è¡Œåˆ°æ€»ç»“ç±»å‹çš„æ­¥éª¤æ—¶ï¼Œå¼€å§‹æ–°è½®æ¬¡
    return step.task_type in ['summarize', 'conclude']
```

#### å¾ªç¯æ§åˆ¶ç¤ºä¾‹
```python
# å¾ªç¯é…ç½®ç¤ºä¾‹
loop_config = {
    "enabled": True,               # å¯ç”¨å¾ªç¯
    "max_loops": 1,                # æœ€å¤§å¾ªç¯1æ¬¡
    "loop_start_role_ref": "teacher"   # å¾ªç¯å¼€å§‹è§’è‰²ï¼ˆå¯é€‰ï¼‰
}

# ä¼šè¯è½®æ¬¡ç®¡ç†
# è½®æ¬¡è¯­ä¹‰è¯´æ˜ï¼š
# - Session.current_round: 0è¡¨ç¤º"æœªå¼€å§‹"ï¼Œç¬¬ä¸€è½®å¯¹è¯æ—¶è®¾ä¸º1
# - Message.round_index: ä»1å¼€å§‹ï¼Œè¡¨ç¤ºå…·ä½“çš„å¯¹è¯è½®æ¬¡
# - è½®æ¬¡æ¨è¿›ï¼šå½“ç‰¹å®šæ¡ä»¶æ»¡è¶³æ—¶ï¼ˆå¦‚æ€»ç»“ç±»ä»»åŠ¡ï¼‰ï¼Œcurrent_roundé€’å¢
class Session(db.Model):
    current_round = db.Column(db.Integer, default=0)  # å½“å‰è½®æ¬¡ï¼ˆ0=æœªå¼€å§‹ï¼Œ1=ç¬¬ä¸€è½®ï¼‰
    executed_steps_count = db.Column(db.Integer, default=0)  # å·²æ‰§è¡Œæ­¥éª¤æ•°
```

### 2.6 å®Œæ•´çš„æ­¥éª¤æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»æ‰§è¡Œä¸‹ä¸€æ­¥] --> B[è·å–ä¼šè¯å’Œå½“å‰æ­¥éª¤]
    B --> C[éªŒè¯æ­¥éª¤å’Œè§’è‰²å­˜åœ¨æ€§]
    C --> D[è·å–å‘è¨€è§’è‰²ä¿¡æ¯]
    D --> E[æ„å»ºæ‰§è¡Œä¸Šä¸‹æ–‡]
    E --> F[é€‰æ‹©å†å²æ¶ˆæ¯]
    F --> G[æ„å»ºç®€åŒ–æç¤ºè¯]
    G --> H[è°ƒç”¨LLM API]
    H --> I{APIè°ƒç”¨æˆåŠŸ?}
    I -->|å¦| J[ä½¿ç”¨æ¨¡æ‹Ÿå“åº”]
    I -->|æ˜¯| K[è·å–LLMå“åº”å†…å®¹]
    J --> K
    K --> L[åˆ›å»ºæ¶ˆæ¯è®°å½•]
    L --> M[æ›´æ–°ä¼šè¯çŠ¶æ€]
    M --> N[ç¡®å®šä¸‹ä¸€æ­¥éª¤]
    N --> O{æœ‰ä¸‹ä¸€æ­¥éª¤?}
    O -->|æ˜¯| P[æ›´æ–°current_step_id]
    O -->|å¦| Q[æ ‡è®°ä¼šè¯å®Œæˆ]
    P --> R[è¿”å›æ‰§è¡Œç»“æœ]
    Q --> R
```

### 2.7 æ ¸å¿ƒä»£ç å®ç°

#### ä¸»æ‰§è¡Œæ–¹æ³•
**ä½ç½®**: `backend/app/services/flow_engine_service.py:execute_next_step`

```python
@staticmethod
async def execute_next_step(session_id: int) -> Tuple[Message, Dict[str, Any]]:
    """å¼‚æ­¥ç‰ˆæœ¬çš„æ‰§è¡Œä¸‹ä¸€æ­¥éª¤ï¼ˆä¸»è¦å®ç°ï¼‰"""
    # å®é™…çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘åœ¨å¼‚æ­¥æ–¹æ³•ä¸­å®ç°
    # åŒ…æ‹¬ï¼šè·å–ä¼šè¯ã€æ„å»ºä¸Šä¸‹æ–‡ã€è°ƒç”¨LLMã€åˆ›å»ºæ¶ˆæ¯ã€æ›´æ–°çŠ¶æ€ç­‰
```

#### å…¼å®¹æ€§åŒ…è£…æ–¹æ³•
**ä½ç½®**: `backend/app/services/flow_engine_service.py:execute_next_step_sync`

```python
@staticmethod
def execute_next_step_sync(session_id: int) -> Tuple[Message, Dict[str, Any]]:
    """
    åŒæ­¥ç‰ˆæœ¬çš„æ‰§è¡Œä¸‹ä¸€æ­¥éª¤ï¼ˆç”¨äºå‘åå…¼å®¹ï¼‰
    å®é™…ä¸Šæ˜¯å¼‚æ­¥execute_next_stepæ–¹æ³•çš„åŒ…è£…å™¨
    """
    try:
        # æ£€æŸ¥æ˜¯å¦åœ¨äº‹ä»¶å¾ªç¯ä¸­è¿è¡Œ
        try:
            loop = asyncio.get_event_loop()
            if loop.is_running():
                # å¦‚æœå¾ªç¯æ­£åœ¨è¿è¡Œï¼Œåœ¨æ–°çº¿ç¨‹ä¸­è¿è¡Œå¼‚æ­¥æ–¹æ³•
                import concurrent.futures
                with concurrent.futures.ThreadPoolExecutor() as executor:
                    future = executor.submit(asyncio.run, FlowEngineService.execute_next_step(session_id))
                    return future.result()
            else:
                # å¦‚æœå¾ªç¯å­˜åœ¨ä½†æœªè¿è¡Œï¼Œç›´æ¥ä½¿ç”¨
                return loop.run_until_complete(FlowEngineService.execute_next_step(session_id))
        except RuntimeError:
            # æ²¡æœ‰äº‹ä»¶å¾ªç¯ï¼Œåˆ›å»ºæ–°çš„
            return asyncio.run(FlowEngineService.execute_next_step(session_id))

    except Exception as e:
        if isinstance(e, (SessionError, FlowExecutionError)):
            raise
        raise FlowExecutionError(f"æ‰§è¡Œæ­¥éª¤å¤±è´¥: {str(e)}")
```

**é‡è¦æ¶æ„è¯´æ˜**ï¼š
- **ä¸»è¦æ–¹æ³•**: `execute_next_step` æ˜¯åŒ…å«å®Œæ•´ä¸šåŠ¡é€»è¾‘çš„å¼‚æ­¥ä¸»æ–¹æ³•
- **åŒ…è£…æ–¹æ³•**: `execute_next_step_sync` ä»…æ˜¯å‘åå…¼å®¹çš„åŒæ­¥åŒ…è£…å™¨
- **è°ƒç”¨æ–¹å¼**: APIå±‚è°ƒç”¨çš„æ˜¯ `execute_next_step(session_id)` å¼‚æ­¥æ–¹æ³•

---

## ğŸš€ 2. æ— éœ€è§’è‰²æ˜ å°„çš„ç®€åŒ–æµç¨‹

### 2.1 åŠŸèƒ½æ¦‚è¿°
**æ— éœ€è§’è‰²æ˜ å°„æ¨¡å¼**æ˜¯å¯¹ä¼ ç»Ÿå¤šè§’è‰²å¯¹è¯ç³»ç»Ÿçš„é‡å¤§ç®€åŒ–ï¼Œå…è®¸ç”¨æˆ·ç›´æ¥ä½¿ç”¨é¢„å®šä¹‰è§’è‰²è¿›è¡Œå¯¹è¯ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®å¤æ‚çš„è§’è‰²æ˜ å°„å…³ç³»ã€‚

#### æ ¸å¿ƒç‰¹æ€§
- **æ™ºèƒ½è¯†åˆ«**: ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«æµç¨‹ç±»å‹ï¼ˆ`business_discussion`ã€`simple`ç­‰ï¼‰
- **è‡ªåŠ¨é…ç½®**: æ— éœ€æ‰‹åŠ¨é€‰æ‹©è§’è‰²å®ä¾‹ï¼Œç³»ç»Ÿè‡ªåŠ¨åŒ¹é…
- **ç®€åŒ–UI**: ç”¨æˆ·åªéœ€é€‰æ‹©æµç¨‹æ¨¡æ¿å’Œè¾“å…¥è®®é¢˜
- **ä¸€é”®å¯åŠ¨**: åˆ›å»ºä¼šè¯åè‡ªåŠ¨è¿›å…¥å¯æ‰§è¡ŒçŠ¶æ€

### 2.2 å‰ç«¯æ™ºèƒ½æ£€æµ‹
**ä½ç½®**: `fronted/src/MultiRoleDialogSystem.tsx:1200-1220`

```typescript
// æ™ºèƒ½æ£€æµ‹æµç¨‹ç±»å‹
useEffect(() => {
  if (formData.flow_template_id && flows.length > 0) {
    const flow = flows.find(f => f.id === Number(formData.flow_template_id));
    if (flow) {
      const refs = Array.from(new Set((flow.steps || []).map(s => s.speaker_role_ref).filter(Boolean)));
      setRequiredRoles(refs);
      if (flow.topic) setFormData(prev => ({ ...prev, topic: flow.topic || '' }));

      // æ£€æŸ¥æ˜¯å¦æ˜¯æ— éœ€è§’è‰²æ˜ å°„çš„æµç¨‹
      const needsMapping = !flow.type?.includes('simple') &&
                         !flow.type?.includes('business_discussion') &&
                         refs.length > 0;
      setNeedsRoleMapping(needsMapping);

      if (needsMapping) {
        // ä¼ ç»Ÿæ¨¡å¼ï¼šéœ€è¦æ‰‹åŠ¨è§’è‰²æ˜ å°„
        setFormData(prev => ({
          ...prev,
          role_mappings: refs.map(ref => {
            const matchedRole = roles.find(r => r.name === ref);
            return { role_ref: ref, role_id: matchedRole ? matchedRole.id : '' };
          })
        }));
      } else {
        // ç®€åŒ–æ¨¡å¼ï¼šè‡ªåŠ¨è§’è‰²é…ç½®
        setFormData(prev => ({ ...prev, role_mappings: [] }));
      }
    }
  }
}, [formData.flow_template_id, flows, roles]);
```

### 2.3 åç«¯è‡ªåŠ¨å¤„ç†

#### è§’è‰²æŸ¥æ‰¾æœåŠ¡
**ä½ç½®**: `backend/app/services/session_service.py:450-475`

```python
@staticmethod
def get_role_for_execution(session_id: int, role_ref: str) -> Optional[Role]:
    """
    è·å–æ‰§è¡Œæ­¥éª¤æ—¶éœ€è¦çš„è§’è‰²å¯¹è±¡
    æ”¯æŒæœ‰è§’è‰²æ˜ å°„å’Œæ— è§’è‰²æ˜ å°„ä¸¤ç§æ¨¡å¼
    """
    # 1. é¦–å…ˆå°è¯•ä»ä¼šè¯è§’è‰²æ˜ å°„ä¸­è·å–
    session_role = SessionService.get_session_role_by_ref(session_id, role_ref)
    if session_role and session_role.role:
        return session_role.role

    # 2. ç›´æ¥é€šè¿‡è§’è‰²åç§°æŸ¥æ‰¾ï¼ˆæ— è§’è‰²æ˜ å°„æ¨¡å¼ï¼‰
    role = Role.query.filter_by(name=role_ref).first()
    if role:
        return role

    # 3. æ¨¡ç³ŠåŒ¹é…ï¼ˆé™çº§å¤„ç†ï¼‰
    role = Role.query.filter(Role.name.contains(role_ref)).first()
    return role
```

#### ä¸´æ—¶SessionRoleåˆ›å»º
**ä½ç½®**: `backend/app/services/flow_engine_service.py:52-63`

```python
# å¦‚æœæ²¡æœ‰session_roleï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„SessionRoleè®°å½•
if not speaker_session_role:
    temp_session_role = SessionRole(
        session_id=session_id,
        role_ref=current_step.speaker_role_ref,
        role_id=role.id
    )
    db.session.add(temp_session_role)
    db.session.flush()  # è·å–ID
    speaker_session_role = temp_session_role
```

### 2.4 æ™ºèƒ½ä¸Šä¸‹æ–‡èŒƒå›´å¤„ç†
**ä½ç½®**: `backend/app/services/flow_engine_service.py:198-296`

#### å¤šç±»å‹ä¸Šä¸‹æ–‡æ”¯æŒ
ç³»ç»Ÿç°åœ¨æ”¯æŒä»¥ä¸‹ä¸Šä¸‹æ–‡èŒƒå›´æ ¼å¼ï¼š

1. **åŸºç¡€èŒƒå›´**ï¼ˆå­—ç¬¦ä¸²ï¼‰
   - `'none'` - æ— å†å²æ¶ˆæ¯
   - `'last_message'` - æœ€åä¸€æ¡æ¶ˆæ¯
   - `'last_round'` - ä¸Šä¸€è½®æ¬¡æ¶ˆæ¯
   - `'last_n_messages'` - æœ€åNæ¡æ¶ˆæ¯
   - `'all'` - æ‰€æœ‰å†å²æ¶ˆæ¯

2. **å¤šè§’è‰²ç­›é€‰**ï¼ˆå­—ç¬¦ä¸²æ•°ç»„/JSONï¼‰
   ```json
   ["Product Manager", "Engineer", "Designer"]
   ```

3. **åˆ—è¡¨ç±»å‹**ï¼ˆç›´æ¥æ•°ç»„ï¼‰
   ```python
   scope = ["Product Manager", "Engineer"]
   ```

4. **å­—å…¸ç±»å‹**ï¼ˆé¢„ç•™æ‰©å±•ï¼‰
   ```python
   scope = {"include": ["PM", "Dev"], "exclude": ["QA"]}
   ```

#### ç±»å‹å®‰å…¨å¤„ç†
```python
# æ™ºèƒ½ç±»å‹æ£€æµ‹å’Œå®‰å…¨å¤„ç†
if isinstance(scope, str):
    # å­—ç¬¦ä¸²å¤„ç†é€»è¾‘
elif isinstance(scope, list):
    # åˆ—è¡¨ç±»å‹ï¼šç¡®ä¿åªä½¿ç”¨å­—ç¬¦ä¸²
    role_names = [
        name for name in scope
        if isinstance(name, str) and name in role_name_to_session_ids
    ]
elif isinstance(scope, dict):
    # å­—å…¸ç±»å‹ï¼šä½¿ç”¨keyä½œä¸ºè§’è‰²ååˆ—è¡¨
    role_names = [
        name for name in scope.keys()
        if isinstance(name, str) and name in role_name_to_session_ids
    ]
```

### 2.5 å‰ç«¯UIé€‚é…

#### è‡ªåŠ¨è§’è‰²é…ç½®ç•Œé¢
```typescript
{/* æ— éœ€è§’è‰²æ˜ å°„æ—¶çš„UI */}
{!needsRoleMapping && requiredRoles.length > 0 && (
  <div className={`p-4 rounded-lg border ${theme.bgSoft} ${theme.border}`}>
    <h3 className={`font-bold ${theme.text} mb-3 flex items-center gap-2`}>
      <CheckCircle size={18}/> è‡ªåŠ¨è§’è‰²é…ç½®
    </h3>
    <div className="space-y-2">
      <p className={`text-sm ${theme.text} opacity-80`}>
        æ­¤æµç¨‹å°†è‡ªåŠ¨ä½¿ç”¨ä»¥ä¸‹è§’è‰²å‚ä¸è®¨è®ºï¼š
      </p>
      <div className="flex flex-wrap gap-2">
        {requiredRoles.map(ref => (
          <span key={ref} className={`px-3 py-1 rounded-full text-xs font-medium ${theme.bgPrimary} ${theme.textPrimary}`}>
            {ref}
          </span>
        ))}
      </div>
      <p className={`text-xs ${theme.text} mt-2 opacity-70`}>
        * ç³»ç»Ÿå°†è‡ªåŠ¨åŒ¹é…å¯¹åº”çš„è§’è‰²é…ç½®
      </p>
    </div>
  </div>
)}
```

---

## ğŸ”§ 3. åç«¯æœåŠ¡æ¶æ„

### 3.1 SessionService
**ä½ç½®**: `backend/app/services/session_service.py`

#### æ ¸å¿ƒèŒè´£
- **ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†**: åˆ›å»ºã€å¯åŠ¨ã€æš‚åœã€æ¢å¤ã€ç»ˆæ­¢ä¼šè¯
- **è§’è‰²æ˜ å°„éªŒè¯**: ç¡®ä¿æ¨¡æ¿è§’è‰²æ­£ç¡®æ˜ å°„åˆ°å®é™…è§’è‰²
- **çŠ¶æ€æŒä¹…åŒ–**: ç»´æŠ¤ä¼šè¯çŠ¶æ€å’Œæ‰§è¡Œè¿›åº¦

#### å…³é”®æ–¹æ³•å®ç°

##### ä¼šè¯åˆ›å»º
```python
@staticmethod
def create_session(session_data: Dict[str, Any]) -> Session:
    """
    åˆ›å»ºæ–°çš„ä¼šè¯

    Args:
        session_data: ä¼šè¯æ•°æ®ï¼ŒåŒ…å«topic, flow_template_id, role_mappingsç­‰

    Returns:
        Session: åˆ›å»ºçš„ä¼šè¯å¯¹è±¡

    Raises:
        SessionNotFoundError: ä¼šè¯ä¸å­˜åœ¨é”™è¯¯
        RoleMappingError: è§’è‰²æ˜ å°„é”™è¯¯
        SessionError: ä¼šè¯åˆ›å»ºå¤±è´¥
    """
    try:
        # éªŒè¯æµç¨‹æ¨¡æ¿æ˜¯å¦å­˜åœ¨
        flow_template = FlowTemplate.query.get(session_data['flow_template_id'])
        if not flow_template:
            raise SessionNotFoundError(f"æµç¨‹æ¨¡æ¿ID {session_data['flow_template_id']} ä¸å­˜åœ¨")

        # éªŒè¯è§’è‰²æ˜ å°„
        role_mappings = session_data['role_mappings']
        SessionService._validate_role_mappings(flow_template, role_mappings)

        # åˆ›å»ºä¼šè¯ï¼ˆæ³¨æ„ï¼šä¸è®¾ç½® current_step_idï¼‰
        session = Session(
            user_id=session_data.get('user_id'),
            topic=session_data['topic'],
            flow_template_id=session_data['flow_template_id'],
            status='not_started',
            current_round=0,
            executed_steps_count=0
            # æ³¨æ„ï¼šåˆ›å»ºæ—¶ä¸è®¾ç½® current_step_id
        )

        # ä¿å­˜æµç¨‹æ¨¡æ¿å¿«ç…§
        session.flow_snapshot_dict = flow_template.to_dict(include_steps=True)

        db.session.add(session)
        db.session.flush()  # è·å–ä¼šè¯ID

        # åˆ›å»ºä¼šè¯è§’è‰²æ˜ å°„
        SessionService._create_session_roles(session.id, role_mappings)

        # ä¿å­˜è§’è‰²å¿«ç…§
        session.roles_snapshot_dict = SessionService._create_roles_snapshot(role_mappings)

        db.session.commit()
        return session

    except Exception as e:
        db.session.rollback()
        if isinstance(e, SessionError):
            raise
        raise SessionError(f"åˆ›å»ºä¼šè¯å¤±è´¥: {str(e)}")
```

##### è§’è‰²æ˜ å°„éªŒè¯
```python
@staticmethod
def _validate_role_mappings(flow_template: FlowTemplate, role_mappings: Dict[str, int]):
    template_roles = set()
    for step in flow_template.steps:
        template_roles.add(step.speaker_role_ref)
        if step.target_role_ref:
            template_roles.add(step.target_role_ref)

    missing_roles = template_roles - set(role_mappings.keys())
    if missing_roles:
        raise SessionError(f"ç¼ºå°‘è§’è‰²æ˜ å°„: {', '.join(missing_roles)}")

    # éªŒè¯è§’è‰²IDæ˜¯å¦å­˜åœ¨
    for role_ref, role_id in role_mappings.items():
        role = Role.query.get(role_id)
        if not role:
            raise SessionError(f"è§’è‰²ID {role_id} ä¸å­˜åœ¨")
```

### 3.2 FlowEngineService
**ä½ç½®**: `backend/app/services/flow_engine_service.py`

#### æ ¸å¿ƒèŒè´£
- **æµç¨‹æ‰§è¡Œå¼•æ“**: æŒ‰æ­¥éª¤æ‰§è¡Œå¯¹è¯æµç¨‹
- **ä¸Šä¸‹æ–‡æ„å»º**: ä¸ºLLMè°ƒç”¨æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ¶ˆæ¯ç”Ÿæˆ**: è°ƒç”¨LLMç”Ÿæˆè§’è‰²å¯¹è¯å†…å®¹
- **çŠ¶æ€æ¨è¿›**: ç®¡ç†ä¼šè¯æ‰§è¡Œè¿›åº¦

#### å…³é”®ä¿®æ”¹ï¼ˆå·²å®ç°HTTP APIæ–¹å¼è°ƒç”¨ï¼‰

##### LLMè°ƒç”¨æ–¹å¼ï¼ˆä¿®æ”¹åï¼‰
```python
@staticmethod
def _generate_llm_response_sync(role: Role, step: FlowStep, context: Dict[str, Any], llm_provider: str = None) -> str:
    try:
        # æ„å»ºç®€å•çš„æç¤ºè¯ï¼Œç±»ä¼¼LLMæµ‹è¯•é¡µé¢
        prompt = FlowEngineService._build_simple_prompt(role, step, context)

        # æ„å»ºå†å²æ¶ˆæ¯
        history_messages = []
        history = context.get('history_messages', [])

        # æ·»åŠ å†å²æ¶ˆæ¯åˆ°historyæ•°ç»„
        for msg in history[-10:]:  # åªå–æœ€è¿‘10æ¡æ¶ˆæ¯é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿
            role_name = msg.get('speaker_role', 'ç”¨æˆ·')
            content = msg.get('content', '')
            if content:
                msg_role = 'assistant' if role_name != 'ç”¨æˆ·' else 'user'
                history_messages.append({
                    'role': msg_role,
                    'content': f"{role_name}: {content}"
                })

        # è°ƒç”¨ç®€å•çš„ /api/llm/chat ç«¯ç‚¹
        api_url = 'http://localhost:5010/api/llm/chat'
        payload = {
            'message': prompt,
            'history': history_messages,
            'provider': llm_provider
        }

        response = requests.post(api_url, json=payload, headers={'Content-Type': 'application/json'}, timeout=30)

        if response.status_code == 200:
            result = response.json()
            if result.get('success') and 'data' in result:
                return result['data']['response']
            else:
                raise FlowExecutionError(f"LLM APIè¿”å›é”™è¯¯: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
        else:
            raise FlowExecutionError(f"LLM APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")

    except requests.exceptions.RequestException as e:
        # ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ¨¡å¼
        logger.warning(f"LLM APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå“åº”: {str(e)}")
        return FlowEngineService._build_simple_prompt(role, step, context)
```

##### ç®€åŒ–æç¤ºè¯æ„å»º
```python
@staticmethod
def _build_simple_prompt(role: Role, step: FlowStep, context: Dict[str, Any]) -> str:
    prompt_parts = []

    # åŸºæœ¬è§’è‰²ä¿¡æ¯
    if role and hasattr(role, 'name'):
        role_desc = f"ä½ æ˜¯{role.name}"
        if hasattr(role, 'prompt') and role.prompt:
            role_desc += f"ã€‚{role.prompt}"
        elif hasattr(role, 'description') and role.description:
            role_desc += f"ã€‚æè¿°ï¼š{role.description}"
        prompt_parts.append(role_desc)

    # ä¼šè¯ä¸»é¢˜
    session_topic = context.get('session_topic', '')
    if session_topic:
        prompt_parts.append(f"ä¼šè¯ä¸»é¢˜ï¼š{session_topic}")

    # å½“å‰ä»»åŠ¡
    if step:
        task_desc = step.description if step.description else step.task_type
        prompt_parts.append(f"ä»»åŠ¡ï¼š{task_desc}")

    # å½“å‰è½®æ¬¡ä¿¡æ¯
    current_round = context.get('current_round', 1)
    step_count = context.get('step_count', 0)
    prompt_parts.append(f"ç¬¬{current_round}è½®å¯¹è¯ï¼Œç¬¬{step_count + 1}ä¸ªæ­¥éª¤")

    # ç®€å•çš„æŒ‡ä»¤
    prompt_parts.append("è¯·ä»¥è¯¥è§’è‰²çš„èº«ä»½è¿›è¡Œå›åº”ã€‚")

    return " ".join(prompt_parts)
```

##### æ­¥éª¤æ‰§è¡Œæµç¨‹
```python
@staticmethod
def execute_next_step_sync(session_id: int) -> Tuple[Message, Dict[str, Any]]:
    try:
        # è·å–ä¼šè¯å’Œå½“å‰æ­¥éª¤
        session = Session.query.get(session_id)
        if not session:
            raise SessionError("ä¼šè¯ä¸å­˜åœ¨")

        current_step = FlowEngineService._get_current_step(session)
        if not current_step:
            raise SessionError("æ²¡æœ‰å¯æ‰§è¡Œçš„æ­¥éª¤")

        # è·å–å‘è¨€è§’è‰²
        speaker_session_role = SessionService.get_session_role_by_ref(session_id, current_step.speaker_role_ref)
        if not speaker_session_role:
            raise SessionError(f"å‘è¨€è§’è‰² {current_step.speaker_role_ref} ä¸å­˜åœ¨")

        role = speaker_session_role.role

        # æ„å»ºä¸Šä¸‹æ–‡
        context = FlowEngineService._build_context(session, current_step)

        # ç”ŸæˆLLMå“åº”
        content = FlowEngineService._generate_llm_response_sync(role, current_step, context)

        # åˆ›å»ºæ¶ˆæ¯
        message = FlowEngineService._create_message(session, current_step, speaker_session_role, content, context)

        # æ›´æ–°ä¼šè¯çŠ¶æ€
        FlowEngineService._update_session_after_step_execution(session, current_step)

        # æ„å»ºæ‰§è¡Œä¿¡æ¯
        execution_info = FlowEngineService._build_execution_info(session, current_step)

        db.session.commit()
        return message, execution_info

    except Exception as e:
        db.session.rollback()
        raise FlowExecutionError(f"æ‰§è¡Œæ­¥éª¤å¤±è´¥: {str(e)}")
```

### 3.3 MessageService
**ä½ç½®**: `backend/app/services/message_service.py`

#### æ ¸å¿ƒèŒè´£
- **æ¶ˆæ¯CRUDæ“ä½œ**: åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤æ¶ˆæ¯
- **æ¶ˆæ¯åˆ†é¡µ**: æ”¯æŒå¤§è§„æ¨¡æ¶ˆæ¯çš„åˆ†é¡µæŸ¥è¯¢
- **æ¶ˆæ¯æœç´¢**: æŒ‰å†…å®¹ã€è§’è‰²ã€æ—¶é—´ç­‰æ¡ä»¶æœç´¢
- **æ¶ˆæ¯ç»Ÿè®¡**: æä¾›æ¶ˆæ¯ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯

---

## ğŸ“Š 4. æ•°æ®æ¨¡å‹è®¾è®¡

### 4.1 Session æ¨¡å‹
**ä½ç½®**: `backend/app/models/session.py`

```python
class Session(db.Model):
    """ä¼šè¯æ¨¡å‹"""
    __tablename__ = 'sessions'

    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer)  # ç”¨æˆ·IDï¼Œæš‚æœªå®ç°ç”¨æˆ·ç³»ç»Ÿï¼ˆæ³¨æ„ï¼šæ˜¯æ™®é€šIntegerå­—æ®µï¼Œéå¤–é”®ï¼‰
    topic = db.Column(db.String(200), nullable=False)  # ä¼šè¯ä¸»é¢˜
    flow_template_id = db.Column(db.Integer, db.ForeignKey('flow_templates.id'), nullable=False)
    flow_snapshot = db.Column(db.Text)  # æµç¨‹æ¨¡æ¿å¿«ç…§ï¼ŒJSONæ ¼å¼
    roles_snapshot = db.Column(db.Text)  # å‚ä¸è§’è‰²å¿«ç…§ï¼ŒJSONæ ¼å¼
    status = db.Column(db.String(20), default='not_started')  # not_started/running/paused/finished/failed
    current_step_id = db.Column(db.Integer)  # å½“å‰æ­¥éª¤ID
    current_round = db.Column(db.Integer, default=0)  # å½“å‰è½®æ¬¡
    executed_steps_count = db.Column(db.Integer, default=0)  # å·²æ‰§è¡Œæ­¥éª¤æ•°
    error_reason = db.Column(db.String(500))  # é”™è¯¯åŸå› 
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    ended_at = db.Column(db.DateTime)

    # å…³ç³»
    flow_template = db.relationship('FlowTemplate', backref='sessions')
    session_roles = db.relationship('SessionRole', backref='session', lazy='dynamic')
    messages = db.relationship('Message', backref='session', lazy='dynamic',
                              order_by='Message.created_at')

    # å±æ€§æ–¹æ³•
    @property
    def flow_snapshot_dict(self):
        """è·å–æµç¨‹å¿«ç…§å­—å…¸"""
        if self.flow_snapshot:
            try:
                return json.loads(self.flow_snapshot)
            except (json.JSONDecodeError, TypeError):
                return {}
        return {}

    @flow_snapshot_dict.setter
    def flow_snapshot_dict(self, value):
        """è®¾ç½®æµç¨‹å¿«ç…§"""
        if isinstance(value, dict):
            self.flow_snapshot = json.dumps(value, ensure_ascii=False)
        else:
            self.flow_snapshot = value

    @property
    def roles_snapshot_dict(self):
        """è·å–è§’è‰²å¿«ç…§å­—å…¸"""
        if self.roles_snapshot:
            try:
                return json.loads(self.roles_snapshot)
            except (json.JSONDecodeError, TypeError):
                return {}
        return {}

    @roles_snapshot_dict.setter
    def roles_snapshot_dict(self, value):
        """è®¾ç½®è§’è‰²å¿«ç…§"""
        if isinstance(value, dict):
            self.roles_snapshot = json.dumps(value, ensure_ascii=False)
        else:
            self.roles_snapshot = value
```

#### çŠ¶æ€æšä¸¾
- `not_started`: å·²åˆ›å»ºä½†æœªå¼€å§‹
- `running`: æ­£åœ¨æ‰§è¡Œ
- `paused`: ä¸´æ—¶æš‚åœ
- `finished`: æˆåŠŸå®Œæˆ
- `failed`: æ‰§è¡Œå¤±è´¥
- `terminated`: å¼ºåˆ¶ç»ˆæ­¢

### 4.2 SessionRole æ¨¡å‹
**ä½ç½®**: `backend/app/models/session.py`

```python
class SessionRole(db.Model):
    """ä¼šè¯è§’è‰²æ¨¡å‹"""
    __tablename__ = 'session_roles'

    id = db.Column(db.Integer, primary_key=True)
    session_id = db.Column(db.Integer, db.ForeignKey('sessions.id'), nullable=False)
    role_ref = db.Column(db.String(50), nullable=False)  # æ¨¡æ¿å†…è§’è‰²å¼•ç”¨
    role_id = db.Column(db.Integer, db.ForeignKey('roles.id'), nullable=False)  # å®é™…è§’è‰²ID
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # å…³ç³»
    role = db.relationship('Role')
    sent_messages = db.relationship('Message', foreign_keys='Message.speaker_session_role_id')
    target_messages = db.relationship('Message', foreign_keys='Message.target_session_role_id')
```

### 4.3 Message æ¨¡å‹
**ä½ç½®**: `backend/app/models/message.py`

```python
class Message(db.Model):
    """æ¶ˆæ¯æ¨¡å‹"""
    __tablename__ = 'messages'

    id = db.Column(db.Integer, primary_key=True)
    session_id = db.Column(db.Integer, db.ForeignKey('sessions.id'), nullable=False)
    speaker_session_role_id = db.Column(db.Integer, db.ForeignKey('session_roles.id'), nullable=False)
    target_session_role_id = db.Column(db.Integer, db.ForeignKey('session_roles.id'))  # ç›®æ ‡è§’è‰²ID
    reply_to_message_id = db.Column(db.Integer, db.ForeignKey('messages.id'))  # å›å¤æ¶ˆæ¯ID
    content = db.Column(db.Text, nullable=False)  # æ¶ˆæ¯å†…å®¹
    content_summary = db.Column(db.String(500))  # å†…å®¹æ‘˜è¦
    round_index = db.Column(db.Integer, default=1)  # è½®æ¬¡ç´¢å¼•
    section = db.Column(db.String(100))  # è¯é¢˜é˜¶æ®µ
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

    # å…³ç³»
    speaker_role = db.relationship('SessionRole', foreign_keys=[speaker_session_role_id])
    target_role = db.relationship('SessionRole', foreign_keys=[target_session_role_id])
    reply_to_message = db.relationship('Message', remote_side=[id])
    reply_messages = db.relationship('Message', remote_side=[reply_to_message_id])
```

---

## ğŸŒ 5. APIç«¯ç‚¹è®¾è®¡

### 5.1 ä¼šè¯ç®¡ç†API
**ä½ç½®**: `backend/app/api/sessions.py`

#### ä¼šè¯åˆ—è¡¨
```python
class SessionList(Resource):
    def get(self):
        params = request.args
        page = int(params.get('page', 1))
        page_size = int(params.get('page_size', 20))
        search = params.get('search')
        status = params.get('status')

        query = Session.query
        if search:
            query = query.filter(Session.topic.contains(search))
        if status:
            query = query.filter(Session.status == status)

        pagination = query.paginate(page=page, per_page=page_size)

        return {
            'success': True,
            'data': {
                'sessions': [session.to_dict() for session in pagination.items],
                'total': pagination.total,
                'page': page,
                'page_size': page_size,
                'pages': pagination.pages
            }
        }
```

#### åˆ›å»ºä¼šè¯
```python
class SessionDetail(Resource):
    def post(self):
        """åˆ›å»ºæ–°ä¼šè¯"""
        try:
            json_data = request.get_json()
            if not json_data:
                return {
                    'success': False,
                    'error_code': 'INVALID_REQUEST',
                    'message': 'è¯·æ±‚ä½“ä¸èƒ½ä¸ºç©º'
                }, 400

            # æ•°æ®éªŒè¯
            create_schema = CreateSessionSchema()
            try:
                data = create_schema.load(json_data)
            except Exception as e:
                return {
                    'success': False,
                    'error_code': 'VALIDATION_ERROR',
                    'message': 'æ•°æ®éªŒè¯å¤±è´¥',
                    'details': str(e)
                }, 400

            # è°ƒç”¨æœåŠ¡å±‚åˆ›å»ºä¼šè¯
            session = SessionService.create_session(json_data)

            # è¿”å›åˆ›å»ºçš„ä¼šè¯ä¿¡æ¯
            session_schema = SessionSchema()
            result = session_schema.dump(session)

            return {
                'success': True,
                'data': result,
                'message': 'ä¼šè¯åˆ›å»ºæˆåŠŸ'
            }, 201

        except SessionError as e:
            return {
                'success': False,
                'error_code': 'SESSION_ERROR',
                'message': str(e)
            }, 400
```

#### æ‰§è¡Œä¸‹ä¸€æ­¥
**å®é™…ç«¯ç‚¹**: `POST /api/sessions/{id}/run-next-step`

```python
class SessionExecution(Resource):
    """ä¼šè¯æ‰§è¡Œèµ„æº"""

    def post(self, session_id):
        """æ‰§è¡Œä¼šè¯ä¸‹ä¸€æ­¥éª¤"""
        try:
            json_data = request.get_json() or {}

            # æ•°æ®éªŒè¯
            execution_schema = SessionExecutionSchema()
            try:
                data = execution_schema.load(json_data, partial=True)
            except Exception as e:
                return {
                    'success': False,
                    'error_code': 'VALIDATION_ERROR',
                    'message': 'æ•°æ®éªŒè¯å¤±è´¥',
                    'details': str(e)
                }, 400

            # æ£€æŸ¥ä¼šè¯æ˜¯å¦å¯æ‰§è¡Œ
            if not SessionService.is_session_executable(session_id):
                return {
                    'success': False,
                    'error_code': 'NOT_EXECUTABLE',
                    'message': 'ä¼šè¯å½“å‰çŠ¶æ€ä¸å…è®¸æ‰§è¡Œæ­¥éª¤'
                }, 400

            # æ‰§è¡Œä¸‹ä¸€æ­¥éª¤ï¼ˆè°ƒç”¨å¼‚æ­¥ä¸»æ–¹æ³•ï¼‰
            message, execution_info = FlowEngineService.execute_next_step(session_id)

            # ä½¿ç”¨Marshmallow Schemaåºåˆ—åŒ–ç»“æœ
            from app.schemas import MessageSchema
            message_schema = MessageSchema()
            message_data = message_schema.dump(message)

            return {
                'success': True,
                'data': {
                    'message': message_data,
                    'execution_info': execution_info
                },
                'message': 'æ­¥éª¤æ‰§è¡ŒæˆåŠŸ'
            }

        except SessionNotFoundError as e:
            return {
                'success': False,
                'error_code': 'NOT_FOUND',
                'message': str(e)
            }, 404

        except FlowExecutionError as e:
            return {
                'success': False,
                'error_code': 'FLOW_EXECUTION_ERROR',
                'message': str(e)
            }, 400

        except Exception as e:
            db.session.rollback()
            return {
                'success': False,
                'error_code': 'INTERNAL_ERROR',
                'message': 'æ‰§è¡Œä¼šè¯æ­¥éª¤å¤±è´¥'
            }, 500
```

**APIè°ƒç”¨è¯´æ˜**ï¼š
- **ç«¯ç‚¹è·¯å¾„**: `POST /api/sessions/{id}/run-next-step`
- **è°ƒç”¨æ–¹æ³•**: `FlowEngineService.execute_next_step(session_id)`ï¼ˆå¼‚æ­¥ä¸»æ–¹æ³•ï¼ŒSyncç‰ˆæœ¬ä»…ä¸ºåŒ…è£…å™¨ï¼‰
- **æ•°æ®éªŒè¯**: ä½¿ç”¨ `SessionExecutionSchema` éªŒè¯è¯·æ±‚ä½“ï¼Œå¹¶é€šè¿‡ `SessionService.is_session_executable` æ ¡éªŒä¼šè¯çŠ¶æ€
- **è¿”å›ç»“æ„**: ä½¿ç”¨ `MessageSchema` åºåˆ—åŒ–æ¶ˆæ¯ï¼ŒåŒæ—¶è¿”å› `execution_info`
- **é”™è¯¯å¤„ç†**: åŒºåˆ† `VALIDATION_ERROR`ã€`NOT_EXECUTABLE`ã€`FLOW_EXECUTION_ERROR`ã€`INTERNAL_ERROR` ç­‰é”™è¯¯ç 

### 5.2 æ¶ˆæ¯ç®¡ç†API
**ä½ç½®**: `backend/app/api/messages.py`

#### è·å–æ¶ˆæ¯åˆ—è¡¨
```python
class MessageListResource(Resource):
    def get(self, session_id):
        params = request.args
        page = int(params.get('page', 1))
        page_size = int(params.get('page_size', 50))
        round_number = params.get('round_number')
        role_ref = params.get('role_ref')

        query = Message.query.filter_by(session_id=session_id)

        if round_number:
            query = query.filter_by(round_index=round_number)
        if role_ref:
            query = query.join(Message.speaker_session_role).filter(SessionRole.role_ref == role_ref)

        pagination = query.order_by(Message.created_at.asc()).paginate(page=page, per_page=page_size)

        return {
            'success': True,
            'data': {
                'messages': [message.to_dict() for message in pagination.items],
                'total': pagination.total,
                'page': page,
                'page_size': page_size,
                'pages': pagination.pages
            }
        }
```

---

## ğŸ”„ 6. å®Œæ•´ä¸šåŠ¡æµç¨‹

### 6.1 ä¼šè¯åˆ›å»ºæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©æµç¨‹æ¨¡æ¿] --> B[ç³»ç»Ÿæå–æ¨¡æ¿è§’è‰²éœ€æ±‚]
    B --> C[ç”¨æˆ·è¿›è¡Œè§’è‰²æ˜ å°„]
    C --> D[éªŒè¯è§’è‰²æ˜ å°„å®Œæ•´æ€§]
    D --> E{éªŒè¯é€šè¿‡?}
    E -->|å¦| F[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    E -->|æ˜¯| G[åˆ›å»ºä¼šè¯è®°å½•]
    G --> H[ä¿å­˜æµç¨‹å¿«ç…§]
    H --> I[åˆ›å»ºä¼šè¯è§’è‰²æ˜ å°„]
    I --> J[ä¼šè¯åˆ›å»ºæˆåŠŸ]
    F --> C
```

#### è¯¦ç»†æ­¥éª¤
1. **æ¨¡æ¿é€‰æ‹©**: ç”¨æˆ·ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©æµç¨‹æ¨¡æ¿
2. **è§’è‰²éœ€æ±‚æå–**: ç³»ç»Ÿåˆ†ææ¨¡æ¿æ­¥éª¤ï¼Œæå–æ‰€æœ‰è§’è‰²å¼•ç”¨
3. **è§’è‰²æ˜ å°„**: ç”¨æˆ·å°†æ¨¡æ¿è§’è‰²æ˜ å°„åˆ°å®é™…è§’è‰²å®ä¾‹
4. **æ˜ å°„éªŒè¯**: ç¡®ä¿æ‰€æœ‰å¿…éœ€è§’è‰²éƒ½æœ‰å¯¹åº”æ˜ å°„
5. **ä¼šè¯åˆ›å»º**: åˆ›å»ºSessionè®°å½•ï¼Œä¿å­˜æµç¨‹å’Œè§’è‰²å¿«ç…§
6. **è§’è‰²å…³è”**: åˆ›å»ºSessionRoleè®°å½•å»ºç«‹æ˜ å°„å…³ç³»

### 6.2 æ­¥éª¤æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»æ‰§è¡Œä¸‹ä¸€æ­¥] --> B[è·å–å½“å‰ä¼šè¯çŠ¶æ€]
    B --> C[ç¡®å®šå½“å‰æ‰§è¡Œæ­¥éª¤]
    C --> D[è·å–å‘è¨€è§’è‰²ä¿¡æ¯]
    D --> E[æ„å»ºæ‰§è¡Œä¸Šä¸‹æ–‡]
    E --> F[è°ƒç”¨LLMç”Ÿæˆå†…å®¹]
    F --> G{è°ƒç”¨æˆåŠŸ?}
    G -->|å¦| H[ä½¿ç”¨æ¨¡æ‹Ÿå“åº”]
    G -->|æ˜¯| I[åˆ›å»ºæ¶ˆæ¯è®°å½•]
    H --> I
    I --> J[æ›´æ–°ä¼šè¯æ‰§è¡ŒçŠ¶æ€]
    J --> K[ç¡®å®šä¸‹ä¸€æ­¥éª¤]
    K --> L{è¿˜æœ‰æ­¥éª¤?}
    L -->|æ˜¯| M[æ›´æ–°å½“å‰æ­¥éª¤ID]
    L -->|å¦| N[æ ‡è®°ä¼šè¯å®Œæˆ]
    M --> O[è¿”å›æ‰§è¡Œç»“æœ]
    N --> O
```

#### å…³é”®å®ç°ç»†èŠ‚

##### ä¸Šä¸‹æ–‡æ„å»º
```python
@staticmethod
def _build_context(session: Session, current_step: FlowStep) -> Dict[str, Any]:
    # è·å–ä¼šè¯è§’è‰²æ˜ å°„
    session_roles = SessionService.get_role_mapping(session.id)

    # è·å–å†å²æ¶ˆæ¯
    history_messages = FlowEngineService._select_context_messages(session, current_step)

    # æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
    context = {
        'session_topic': session.topic,
        'current_round': session.current_round,
        'step_count': session.executed_steps_count,
        'session_roles': session_roles,
        'history_messages': [msg.to_dict() for msg in history_messages],
        'flow_template': {
            'id': session.flow_template_id,
            'name': session.flow_template.name if session.flow_template else None,
            'total_steps': len(session.flow_template.steps.all()) if session.flow_template else 0
        }
    }

    return context
```

##### æ¶ˆæ¯åˆ›å»º
```python
@staticmethod
def _create_message(session: Session, current_step: FlowStep, speaker_session_role: SessionRole, content: str, context: Dict[str, Any]) -> Message:
    # è·å–ç›®æ ‡è§’è‰²
    target_session_role_id = FlowEngineService._get_target_session_role_id(session.id, current_step.target_role_ref)

    # è·å–å›å¤æ¶ˆæ¯ID
    reply_to_message_id = FlowEngineService._get_reply_to_message_id(session, current_step)

    # åˆ›å»ºæ¶ˆæ¯
    message = Message(
        session_id=session.id,
        speaker_session_role_id=speaker_session_role.id,
        target_session_role_id=target_session_role_id,
        reply_to_message_id=reply_to_message_id,
        content=content,
        content_summary=FlowEngineService._generate_content_summary(content),
        round_index=session.current_round,
        section=FlowEngineService._determine_message_section(current_step)
    )

    db.session.add(message)
    return message
```

### 6.3 çŠ¶æ€ç®¡ç†æµç¨‹

#### çŠ¶æ€è½¬æ¢è§„åˆ™
```python
@staticmethod
def _update_session_after_step_execution(session: Session, executed_step: FlowStep) -> None:
    # æ›´æ–°æ‰§è¡Œè®¡æ•°
    session.executed_steps_count += 1
    session.updated_at = datetime.utcnow()

    # æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›å…¥ä¸‹ä¸€è½®
    if FlowEngineService._should_start_new_round(session, executed_step):
        session.current_round += 1

    # ç¡®å®šä¸‹ä¸€æ­¥éª¤
    next_step_id = FlowEngineService._determine_next_step(session, executed_step)
    if next_step_id:
        session.current_step_id = next_step_id
    else:
        # æ²¡æœ‰ä¸‹ä¸€æ­¥éª¤ï¼Œç»“æŸä¼šè¯
        session.status = 'finished'
        session.ended_at = datetime.utcnow()
```


---

## ğŸ”§ 7. æŠ€æœ¯å®ç°ç»†èŠ‚

### 7.1 å‰ç«¯çŠ¶æ€ç®¡ç†

#### æ•°æ®æµè®¾è®¡
```typescript
// ä¼šè¯çŠ¶æ€æ¥å£
interface Session {
  id: number;
  topic: string;
  status: 'not_started' | 'running' | 'paused' | 'finished' | 'failed';
  current_round: number;
  executed_steps_count: number;
  flow_template_id: number;
  // ...å…¶ä»–å­—æ®µ
}

// ç®€åŒ–çš„çŠ¶æ€ç®¡ç† - ä½¿ç”¨React Hooksç›´æ¥ç®¡ç†çŠ¶æ€
const [session, setSession] = useState<Session | null>(null);
const [messages, setMessages] = useState<Message[]>([]);
const [generating, setGenerating] = useState(false);
```

#### æ•°æ®åŠ è½½æœºåˆ¶
```typescript
// åŸºäºsessionIdçš„æ•°æ®åŠ è½½
const loadData = async () => {
  try {
    // åŠ è½½ä¼šè¯è¯¦æƒ…
    const sessionData = await sessionApi.getSession(sessionId);
    setSession(sessionData);

    // åŠ è½½ä¼šè¯æ¶ˆæ¯
    const messagesData = await sessionApi.getMessages(sessionId, { page_size: 100 });
    setMessages(messagesData.items);
  } catch (error) {
    handleError(error);
  }
};

useEffect(() => { loadData(); }, [sessionId]);

// è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
useEffect(() => {
  messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
}, [messages, generating]);
```

### 7.2 åç«¯é”™è¯¯å¤„ç†

#### ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
```python
class APIError(Exception):
    def __init__(self, message: str, error_code: str = 'UNKNOWN_ERROR', status_code: int = 500):
        self.message = message
        self.error_code = error_code
        self.status_code = status_code
        super().__init__(self.message)

@app.errorhandler(APIError)
def handle_api_error(error):
    return {
        'success': False,
        'error_code': error.error_code,
        'message': error.message
    }, error.status_code
```

#### ä¸šåŠ¡å¼‚å¸¸ç±»å‹
```python
class SessionError(Exception):
    """ä¼šè¯ç›¸å…³é”™è¯¯çš„åŸºç±»"""
    pass

class SessionNotFoundError(SessionError):
    """ä¼šè¯ä¸å­˜åœ¨é”™è¯¯"""
    pass

class InvalidSessionStateError(SessionError):
    """ä¼šè¯çŠ¶æ€æ— æ•ˆé”™è¯¯"""
    pass

class FlowExecutionError(SessionError):
    """æµç¨‹æ‰§è¡Œé”™è¯¯"""
    pass

class RoleMappingError(SessionError):
    """è§’è‰²æ˜ å°„é”™è¯¯"""
    pass
```

### 7.3 æ•°æ®åº“ä¼˜åŒ–

> ä¸‹åˆ—å‡½æ•°ä¸º**ç¤ºä¾‹ä¼˜åŒ–å·¥å…·å‡½æ•°**ï¼Œå½“å‰ä»“åº“ä¸­å°šæœªä»¥ç›¸åŒå‡½æ•°åç›´æ¥å®ç°ï¼Œå¯ä½œä¸ºåç»­é‡æ„å‚è€ƒã€‚

#### æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹
```python
# é¢„åŠ è½½å…³è”æ•°æ®é¿å…N+1æŸ¥è¯¢
def get_session_with_relations(session_id: int) -> Session:
    return Session.query.options(
        joinedload(Session.flow_template).joinedload(FlowTemplate.steps),
        joinedload(Session.session_roles).joinedload(SessionRole.role),
        joinedload(Session.messages).joinedload(Message.speaker_session_role)
    ).filter_by(id=session_id).first_or_404()

# åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹
def get_messages_paginated(session_id: int, page: int = 1, page_size: int = 50):
    return Message.query.filter_by(session_id=session_id)\
        .options(joinedload(Message.speaker_session_role))\
        .order_by(Message.created_at.asc())\
        .paginate(page=page, per_page=page_size)
```

---

## ğŸ“ˆ 8. æ€§èƒ½å’Œå®‰å…¨è€ƒè™‘

### 8.1 æ€§èƒ½ä¼˜åŒ–

#### å‰ç«¯ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨**: å¤„ç†å¤§é‡æ¶ˆæ¯æ—¶çš„æ€§èƒ½ä¼˜åŒ–
- **æ¶ˆæ¯åˆ†é¡µ**: é¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ¶ˆæ¯
- **çŠ¶æ€ç¼“å­˜**: ç¼“å­˜ä¼šè¯çŠ¶æ€å‡å°‘é‡å¤è¯·æ±‚

#### åç«¯ä¼˜åŒ–
- **æ•°æ®åº“ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- **æŸ¥è¯¢é¢„åŠ è½½**: ä½¿ç”¨joinedloadé¿å…N+1é—®é¢˜
- **è¿æ¥æ± **: é…ç½®æ•°æ®åº“è¿æ¥æ± æé«˜å¹¶å‘æ€§èƒ½

### 8.2 å®‰å…¨è€ƒè™‘

#### è¾“å…¥éªŒè¯
```python
# ä¼šè¯åˆ›å»ºæ—¶çš„è¾“å…¥éªŒè¯ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼Œå½“å‰é¡¹ç›®ä¸­å¯åœ¨ SessionService å†…éƒ¨æŒ‰éœ€å®ç°ç±»ä¼¼é€»è¾‘ï¼‰
def validate_create_session_input(session_data: Dict[str, Any]) -> None:
    topic = session_data.get('topic', '')

    # åŸºç¡€éªŒè¯
    if not topic or len(topic.strip()) < 3:
        raise SessionError("ä¼šè¯ä¸»é¢˜è‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦")
    if len(topic) > 200:
        raise SessionError("ä¼šè¯ä¸»é¢˜ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦")

    # å…¶ä»–éªŒè¯é€»è¾‘...
    return None
```

#### æƒé™æ§åˆ¶
```python
# ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä¼šè¯ï¼ˆç¤ºä¾‹ï¼Œå½“å‰é¡¹ç›®å°šæœªå¯ç”¨ç”¨æˆ·ä½“ç³»ï¼‰
def check_session_permission(user_id: int, session_id: int):
    session = Session.query.filter_by(id=session_id, user_id=user_id).first()
    if not session:
        raise PermissionError('æ— æƒé™è®¿é—®æ­¤ä¼šè¯')
    return session
```

---

## ğŸ¯ 9. æ ¸å¿ƒåŠŸèƒ½å’Œç‰¹æ€§

### 9.1 å¤šè§’è‰²å¯¹è¯ç®¡ç†
- **åŠ¨æ€è§’è‰²åˆ†é…**: æ”¯æŒæµç¨‹æ¨¡æ¿ä¸­çš„è§’è‰²åŠ¨æ€æ˜ å°„
- **è§’è‰²çŠ¶æ€è·Ÿè¸ª**: è·Ÿè¸ªæ¯ä¸ªè§’è‰²çš„å‚ä¸çŠ¶æ€
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**: åŸºäºè§’è‰²å†å²çš„ä¸Šä¸‹æ–‡æ„å»º

### 9.2 æµç¨‹æ¨¡æ¿é›†æˆ
- **å¿«ç…§æœºåˆ¶**: ä¼šè¯åˆ›å»ºæ—¶ä¿å­˜æ¨¡æ¿å¿«ç…§ç¡®ä¿ä¸€è‡´æ€§
- **å¾ªç¯å’Œæ¡ä»¶**: æ”¯æŒå¤æ‚çš„æµç¨‹é€»è¾‘ï¼ˆå¾ªç¯ã€æ¡ä»¶ã€é€€å‡ºï¼‰
- **æ­¥éª¤æ¨è¿›**: æ™ºèƒ½çš„æ­¥éª¤æ¨è¿›å’ŒçŠ¶æ€ç®¡ç†

### 9.3 å®æ—¶æ‰§è¡Œæ§åˆ¶
- **åˆ†æ­¥æ‰§è¡Œ**: ç”¨æˆ·æ§åˆ¶æ¯ä¸€æ­¥çš„æ‰§è¡Œæ—¶æœº
- **çŠ¶æ€å¯è§†åŒ–**: å®æ—¶æ˜¾ç¤ºä¼šè¯æ‰§è¡ŒçŠ¶æ€å’Œè¿›åº¦
- **é”™è¯¯æ¢å¤**: æ‰§è¡Œå¤±è´¥æ—¶çš„è‡ªåŠ¨å›é€€æœºåˆ¶

### 9.4 æ¶ˆæ¯ threading
- **æ¶ˆæ¯å…³ç³»**: æ”¯æŒæ¶ˆæ¯çš„å›å¤å’Œå…³è”å…³ç³»
- **è½®æ¬¡ç»„ç»‡**: æŒ‰å¯¹è¯è½®æ¬¡ç»„ç»‡æ¶ˆæ¯ç»“æ„
- **å†…å®¹æ‘˜è¦**: è‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯å†…å®¹æ‘˜è¦

---

## ğŸ”® 10. æ‰©å±•æ€§å’Œæœªæ¥æ–¹å‘

### 10.1 åŠŸèƒ½æ‰©å±•ç‚¹
- **ç”¨æˆ·æƒé™ç®¡ç†**: æ·»åŠ å®Œæ•´çš„ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- **æµç¨‹æ¨¡æ¿å¸‚åœº**: æ”¯æŒæ¨¡æ¿çš„åˆ†äº«å’Œå¤ç”¨
- **å®æ—¶åä½œ**: å¤šç”¨æˆ·å®æ—¶å‚ä¸åŒä¸€ä¼šè¯
- **AIè§’è‰²ä¼˜åŒ–**: æ›´æ™ºèƒ½çš„è§’è‰²è¡Œä¸ºå’Œå“åº”

### 10.2 æŠ€æœ¯ä¼˜åŒ–æ–¹å‘
- **å¾®æœåŠ¡æ¶æ„**: æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡
- **æ¶ˆæ¯é˜Ÿåˆ—**: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡
- **ç¼“å­˜ä¼˜åŒ–**: Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- **ç›‘æ§å‘Šè­¦**: å®Œå–„çš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

---

## ğŸ“ 11. æ€»ç»“

ä¼šè¯å‰§åœºæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€è®¾è®¡ç²¾è‰¯çš„å¤šè§’è‰²å¯¹è¯ä»¿çœŸç³»ç»Ÿã€‚å®ƒæˆåŠŸåœ°å°†å¤æ‚çš„æµç¨‹æ¨¡æ¿è½¬æ¢ä¸ºç”ŸåŠ¨çš„è§’è‰²å¯¹è¯ï¼Œæä¾›äº†ä»æ¨¡æ¿è®¾è®¡åˆ°ä¼šè¯æ‰§è¡Œçš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚

### æ ¸å¿ƒä¼˜åŠ¿
1. **å®Œæ•´çš„ä¸šåŠ¡é—­ç¯**: ä»è®¾è®¡åˆ°æ‰§è¡Œçš„å®Œæ•´é“¾è·¯
2. **çµæ´»çš„æµç¨‹æ§åˆ¶**: æ”¯æŒå¤æ‚çš„å¤šæ­¥éª¤ã€å¤šè§’è‰²å¯¹è¯æµç¨‹
3. **ç»Ÿä¸€çš„LLMé›†æˆ**: é€šè¿‡HTTP APIæ–¹å¼ç®€åŒ–äº†LLMæœåŠ¡çš„é›†æˆå’Œéƒ¨ç½²
4. **è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**: ç›´è§‚çš„ç•Œé¢è®¾è®¡å’Œå®æ—¶çš„æ‰§è¡Œåé¦ˆ
5. **å¯æ‰©å±•çš„æ¶æ„**: æ”¯æŒåŠŸèƒ½æ‰©å±•å’Œæ€§èƒ½ä¼˜åŒ–

### æŠ€æœ¯äº®ç‚¹
- **å‰åç«¯åˆ†ç¦»**: React + Flaskçš„ç°ä»£åŒ–æŠ€æœ¯æ ˆ
- **RESTful API**: æ ‡å‡†åŒ–çš„APIè®¾è®¡å’Œé”™è¯¯å¤„ç†
- **æ•°æ®æ¨¡å‹è®¾è®¡**: å®Œå–„çš„æ•°æ®åº“æ¨¡å‹å’Œå…³ç³»è®¾è®¡
- **çŠ¶æ€ç®¡ç†**: æ¸…æ™°çš„çŠ¶æ€æµè½¬å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **é”™è¯¯å¤„ç†**: å¥å…¨çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- **æ™ºèƒ½æ¨¡å¼åˆ‡æ¢**: è‡ªåŠ¨è¯†åˆ«æ— éœ€è§’è‰²æ˜ å°„çš„ç®€åŒ–æµç¨‹
- **å¤šç±»å‹ä¸Šä¸‹æ–‡å¤„ç†**: æ”¯æŒå­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å­—å…¸ç­‰å¤šç§æ ¼å¼
- **é˜²å¾¡æ€§ç¼–ç¨‹**: å®Œæ•´çš„ç±»å‹éªŒè¯å’Œé™çº§å¤„ç†æœºåˆ¶
- **è‡ªåŠ¨åŒ–æµç¨‹**: ä¼šè¯åˆ›å»ºåè‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

ä¼šè¯å‰§åœºç³»ç»Ÿä¸ºå¤šè§’è‰²å¯¹è¯åœºæ™¯æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„ã€å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯ç°ä»£è½¯ä»¶å·¥ç¨‹å®è·µçš„ä¼˜ç§€æ¡ˆä¾‹ã€‚
