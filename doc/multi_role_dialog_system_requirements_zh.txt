多角色对话系统业务需求说明书
================================

一、项目背景与目标
--------------------

1. 背景
- 在许多知识密集、决策复杂的场景中（如教学讨论、法律咨询、政策研讨、学术评审等），往往需要多个不同身份、不同观点的参与者共同对一个主题进行讨论与推演。
- 传统的单一问答或单角色助手，无法很好地模拟“多方对话”的过程，也无法体现角色之间的立场差异与交互关系。
- 因此需要构建一个“多角色对话系统”，让用户可以像导演一样编排不同身份角色围绕某一主题进行多轮、有逻辑的对话与争鸣。

2. 总体目标
- 本系统旨在提供一个“可配置、多角色、可编排、可回放”的对话环境，使用户能够：
  - 预先配置多个具有明确身份和行为风格的“虚拟角色”；
  - 按照自己的需求设计对话顺序、回合数、循环与结束条件；
  - 驱动这些角色围绕某个主题或任务进行有结构的对话；
  - 完整记录对话过程，并支持保存、加载和继续对话。

3. 关键价值
- 帮助用户从多个视角审视同一问题（如老师、学生、专家、官员、律师等不同角色）。
- 通过流程化、多轮的对话，进行系统化思考与方案推敲，而不仅是简单的一问一答。
- 将复杂的协作性思考过程，以可视化、可重放、可修改的形式固化下来，便于复用与分享。


二、系统作用边界与角色
------------------------

1. 系统的主要使用者
- 普通终端用户：
  - 想要快速构造“多角色观点碰撞”的讨论场景，例如让“老师–学生–专家”围绕一个学习主题进行对话。
- 专业用户：
  - 如教师、研究员、产品经理、法律从业者等，使用本系统来模拟课上讨论、方案评审会、庭审辩论等场景。

2. 系统不做的事情（边界）
- 系统本身不直接决定“正确答案”，而是提供多角色观点与讨论过程。
- 系统不负责实际的法律、医疗等决策，仅提供模拟讨论和信息参考。
- 系统不直接管理底层大模型算力与资源池，而是通过已有的模型服务接口进行对话生成（本需求文档仅描述业务逻辑，不涉及具体接口和实现）。


三、核心业务目标拆解
----------------------

围绕“多角色对话”，系统需要满足以下核心业务目标：

1. 角色粒度的身份与行为管理
- 为每个角色定义清晰的人设、立场、风格和说话边界。
- 角色之间可以明确“谁在对谁说”、“以什么态度与目标来回应”。

2. 可编排的对话流程
- 用户可以定义：在一个会话中，多个角色按什么顺序、以何种逻辑（顺序、循环、条件跳转）参与对话。
- 对话流程可视为一个“对话剧本”，系统负责按剧本驱动角色发言。

3. 有上下文关联的发言
- 每一条发言都应有清晰的上下文来源：
  - 由哪个角色发出；
  - 针对谁的哪一条发言；
  - 在整个对话中的位置。

4. 完整可追溯的对话历史
- 所有角色的发言均按时间与顺序记录，可随时回看、导出。
- 对话会话可被保存为“快照”，以后可以加载并从中断位置继续对话。


四、核心业务概念定义
----------------------

1. 角色（Role）
- 定义：
  - 在系统中代表某一类身份或视角的“发言主体”，如“高中物理老师”、“大学教授”、“政府官员”、“学生”、“律师”等。
- 角色的业务属性（示意）：
  - 角色标识：用于区分不同角色的唯一标志。
  - 角色名称：给用户看的角色名称，如“老师A”、“环保官员”、“学生代表”。
  - 身份描述：描述角色的背景、职责、专业领域、立场倾向等。
  - 发言风格：例如严谨、鼓励式、质疑式、官方表述等。
  - 言论边界：哪些内容不应讨论（例如不涉隐私、不给出医疗诊断结论等）。
  - 默认关注点：该角色在对话中更关心的问题维度（安全性、合规性、学习效果、用户体验等）。

2. 消息（Message）
- 定义：
  - 对话中由某个角色输出的一则完整发言。
- 消息的业务属性（示意）：
  - 发言角色：该消息由哪个角色发出。
  - 目标对象：
    - 该消息主要是在回应哪一个角色，或回应哪一条具体消息。
  - 内容摘要：
    - 用于系统内部检索和条件判断的简要摘要（可由系统生成）。
  - 上下文信息：
    - 该消息处于第几轮对话；
    - 所处的小节或话题（如“问题提出”、“方案讨论”、“总结”）。

3. 会话（Session）
- 定义：
  - 一次完整的多角色对话过程，对应用户围绕一个主题或任务发起的一次“项目级”对话。
- 会话的业务属性（示意）：
  - 会话主题：本次讨论围绕的核心问题或项目。
  - 参与角色列表：会话中实际参与发言的角色集合。
  - 对话流程配置：对本次会话适用的“对话剧本”（顺序、循环与条件）。
  - 对话历史：按顺序排列的所有消息记录。
  - 当前执行状态：
    - 已执行到流程的哪个步骤；
    - 当前循环执行次数；
    - 会话是否结束、暂停或等待用户输入。

4. 对话流程 / 剧本（Dialogue Flow / Script）
- 定义：
  - 用于描述“在这个会话中，各个角色如何交替发言”的流程化配置。
- 业务视角的元素示意：
  - 流程步骤：
    - 每一步指定：由哪个角色发言、主要回应的对象是谁、处于什么阶段（如提问、解答、质疑、总结等）。
  - 流程片段：
    - 多个步骤组合成一个片段，可以整体作为循环单元重复执行。
  - 条件逻辑：
    - 根据对话历史或外部输入判断是否进入某个片段、是否结束、是否跳转到另一段流程。


五、主要业务功能需求
----------------------

1. 角色管理
-------------

1.1 角色创建
- 用户可以新建角色，主要流程：
  - 输入角色名称、身份描述、发言风格等基础信息。
  - 选择角色类型（如教师类、专家类、学生类、官员类、律师类等，仅作为分类标签）。
  - 配置角色关注的重点（如更注重“概念解释”、“风险提示”、“法规合规”等）。
  - 保存后，该角色可在多个会话中复用。

1.2 角色编辑与复制
- 用户可对已有角色进行调整：
  - 修改描述和风格，以适应新的使用场景。
  - 支持“基于某角色复制一个新角色”，便于快速创建相似角色。

1.3 角色删除与禁用
- 用户可删除不再需要的自定义角色。
- 对于系统预置的基础角色，可设置为“不可删除，但可复制与扩展”。

1.4 角色列表与搜索
- 提供角色列表视图：
  - 可按角色名称、类型、创建时间进行排序和搜索。
  - 支持查看每个角色的详细配置说明。


2. 会话管理
------------

2.1 新建会话
- 用户选择“新建会话”时：
  - 填写会话主题（如“高中物理课：动量守恒”、“某环保政策讨论”、“某产品立项评审”等）。
  - 从角色库中勾选本会话需要参与的角色。
  - 选择或新建一个对话流程剧本（可以使用模板或从空白开始配置）。
  - 确认后，生成一个新的会话实例。

2.2 会话进度与状态
- 会话在执行过程中应有清晰的状态标识：
  - 未开始：刚创建但尚未进入任何对话步骤。
  - 进行中：对话正在按流程执行。
  - 暂停：执行中途由用户手动暂停。
  - 已结束：满足结束条件或用户主动结束。

2.3 会话保存
- 用户可在任意时刻保存会话：
  - 保存内容包括：
    - 会话基本信息（主题、创建时间等）。
    - 参与角色的快照（以免角色配置后续变动影响历史会话再现）。
    - 当前使用的对话流程定义。
    - 已经产生的所有对话消息及其顺序。
    - 流程执行位置（当前步骤、循环计数等）。

2.4 会话加载与继续
- 用户可从历史记录中选取某个会话，进行：
  - 历史回放：仅浏览已有历史，不再追加新的发言。
  - 继续会话：从保存时的流程位置继续向后执行新的对话。
  - 分支会话：以某一历史时刻为起点，复制出一个“新的分支会话”，在其基础上探索不同的后续对话路径。


3. 对话流程编排
----------------

3.1 流程结构
- 流程由一个或多个“步骤”和“片段”组成：
  - 步骤：最基本的单元，定义一次具体发言：“由哪个角色，在什么上下文下，说什么类型的话”。
  - 片段：由多个连续步骤构成的逻辑单元，可作为循环或条件跳转的目标。

3.2 步骤配置要素
- 每个步骤至少包含：
  - 发言角色：
    - 指定本步骤由哪个角色进行发言。
  - 回应对象：
    - 可以是：
      - 上一步骤的发言者；
      - 某一特定角色的最新发言；
      - 会话历史中的某条指定消息（例如第 3 条信息，或者“用户提问”）。
  - 发言任务类型（可选）：
    - 如“提出问题”、“回答问题”、“质疑与补充”、“总结与归纳”、“给出建议”等。
  - 上下文取用范围：
    - 指定当前角色在发言时需要参考的历史信息范围（例如最近 5 条消息、最近一轮完整问答、所有历史等）。

3.3 流程控制逻辑
- 线性顺序：
  - 简单情况下，流程按 A → B → C → D 的顺序执行，每一步完成后自动进入下一步。
- 循环结构：
  - 支持设定某一片段重复执行：
    - 固定次数：例如“学生↔老师”的问答重复 3 轮。
    - 条件结束：例如“直到教师给出‘总结意见’为止”，或者“直到学生表示已理解”。
  - 为避免死循环，应允许设置最大循环次数上限。
- 条件跳转：
  - 根据对话历史或外部操作，选择不同的后续片段：
    - 如“如果专家认为方案可行，则进入‘细化方案’片段；否则进入‘重新修改方案’片段”。

3.4 流程模板
- 提供一些常用的流程模板：
  - 教学对话模板：老师提出问题→学生尝试回答→老师点评→老师总结。
  - 评审模板：提案人陈述→评审专家提问→提案人答复→评审专家给出结论。
  - 辩论模板：正方陈述→反方质疑→正方回应→裁判总结。
- 用户可以复制模板并进行调整，以快速满足新场景需求。


4. 对话执行与上下文管理
-------------------------

4.1 顺序执行控制
- 在对话执行过程中，系统应保证：
  - 同一时刻只处理一个步骤，即只允许一个角色输出一条消息。
  - 某个步骤的消息生成完成后，才会进入下一步骤或进行条件判断。

4.2 上下文选择与聚焦
- 为保证每个角色的发言有针对性和连贯性，系统在执行步骤时需要：
  - 明确告诉当前角色：
    - 你是谁（角色身份与职责）；
    - 你现在在对话中的位置（第几轮、当前话题）；
    - 你正在回应谁的哪一条发言；
    - 目前整个对话已达成哪些共识，尚存哪些分歧。
  - 控制上下文范围：
    - 避免每次都使用全部历史信息，以提高效率和聚焦程度。

4.3 针对上一个或特定角色的回应
- 在业务上，系统应体现“对话感”和“交互性”：
  - 当前角色在发言时，会明确引用或总结目标对象的意见，再给出自己的看法。
  - 对于教学场景，可强调“针对学生回答进行点评与引导”；
  - 对于评审场景，可强调“专家针对提案人陈述进行质疑和打分”。

4.4 结束条件判断
- 对话在以下情况之一结束：
  - 达到预设的最大步骤/轮数；
  - 流程中定义的某个“结束节点”被触发（如某角色给出最终结论）；
  - 用户在界面中主动点击“结束会话”；
  - 出现异常情况（如底层服务不可用），系统终止执行并提示。


5. 对话历史与可视化
----------------------

5.1 历史记录结构
- 每一次会话应完整记录：
  - 角色参与情况与配置快照；
  - 对话流程剧本版本；
  - 按时间顺序排列的所有消息，包括发言角色、目标对象、内容摘要等。

5.2 历史浏览与检索
- 用户可以在界面中：
  - 按时间顺序浏览对话；
  - 按角色过滤消息，例如只看“老师”的发言或“律师”的评论；
  - 搜索含有某些关键字的发言片段。

5.3 对话导出与分享（可选）
- 支持将会话导出为文本或文档，便于：
  - 教学案例汇编；
  - 方案评审记录归档；
  - 研究或汇报材料整理。


六、非功能性业务考虑
----------------------

1. 使用成本与学习门槛
- 对于普通用户：
  - 需要提供简单的向导式流程配置方式，如“选择角色→选择模板→少量参数配置→开始对话”。
- 对于高级用户：
  - 可以暴露更多高级选项，如复杂条件、嵌套循环、多分支等。

2. 安全与合规
- 角色配置与对话内容应避免鼓励违法或有害行为。
- 对于具有专业属性的角色（如医生、律师等），应在界面中明确提示“结果仅供参考，不构成专业意见”。

3. 可扩展性
- 系统设计应允许后续增加：
  - 新的角色类型；
  - 更复杂的流程控制方式；
  - 外部系统集成（如接入知识库、业务系统等）。


七、总结
----------

本业务需求说明书明确了多角色对话系统的目标：通过可配置的角色及可编排的对话流程，为用户提供一个多视角、多轮次的“对话剧场”，帮助用户在复杂问题上进行系统性思考与推演。后续设计与实现应围绕上述角色管理、会话管理、流程编排、对话执行及历史管理等核心业务能力展开，在此基础上再考虑技术架构与具体实现细节。

