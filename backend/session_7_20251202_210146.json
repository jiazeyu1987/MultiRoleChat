[
  {
    "role": "user",
    "content": "帮我创建一个 Flask 应用"
  },
  {
    "role": "assistant",
    "content": "好的，我们来创建一个功能完整、结构清晰且符合现代开发实践的 Flask 应用。\n\n我将为你创建一个简单的博客应用，它会包含以下内容：\n\n*   **项目结构**: 清晰地分离代码、模板和静态文件。\n*   **路由**: 定义多个 URL 和对应的视图函数。\n*   **模板**: 使用 Jinja2 模板引擎来渲染动态页面。\n*   **静态文件**: 引用 CSS 和 JavaScript 文件。\n*   **表单处理**: 创建和处理表单。\n*   **数据库集成**: 使用 SQLAlchemy 和 Flask-SQLAlchemy 来操作数据库。\n*   **环境变量**: 使用 `python-dotenv` 来管理敏感信息（如密钥）。\n*   **运行说明**: 详细地告诉你如何安装依赖并运行应用。\n\n---\n\n### 第 1 步：项目结构\n\n首先，创建一个名为 `my_flask_app` 的文件夹，并在其中创建如下的文件和目录结构：\n\n```\nmy_flask_app/\n├── app.py              # 应用的主入口文件\n├── config.py           # 配置文件\n├── .env                # 存储环境变量（如密钥）\n├── .flaskenv           # Flask CLI 环境变量\n├── requirements.txt    # 项目依赖\n├── static/             # 存放静态文件\n│   ├── css/\n│   │   └── style.css   # 自定义样式\n│   └── images/         # 存放图片\n│\n└── templates/          # 存放 HTML 模板\n    ├── base.html       # 基础模板\n    ├── index.html      # 首页模板\n    ├── create_post.html # 创建文章页面\n    └── post.html       # 单篇文章详情页\n```\n\n---\n\n### 第 2 步：安装依赖\n\n你需要安装几个必要的库。在项目根目录 (`my_flask_app/`) 下，创建一个名为 `requirements.txt` 的文件，内容如下：\n\n**`requirements.txt`**\n```\nFlask\nFlask-SQLAlchemy\npython-dotenv\n```\n\n然后，打开你的终端或命令提示符，进入该目录，运行以下命令来安装这些依赖：\n\n```bash\npip install -r requirements.txt\n```\n\n---\n\n### 第 3 步：编写代码\n\n现在，我们来填充每个文件的内容。\n\n#### 1. 配置文件\n\n创建 `config.py` 文件，用于集中管理配置。\n\n**`config.py`**\n```python\nimport os\n\n# 从 .env 文件中加载环境变量\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nclass Config:\n    # 一个安全的密钥，用于 session 等。它应该是一个长随机字符串。\n    # 我们将从 .env 文件中读取它。\n    SECRET_KEY = os.environ.get('SECRET_KEY') or 'a-very-secret-key'\n    \n    # 数据库 URI。这里我们使用 SQLite，它会创建一个名为 app.db 的文件。\n    # SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or 'sqlite:///' + os.path.join(basedir, 'app.db')\n    SQLALCHEMY_DATABASE_URI = 'sqlite:///app.db'\n    \n    # 关闭 SQLAlchemy 对对象修改的跟踪，以减少内存消耗。\n    SQLALCHEMY_TRACK_MODIFICATIONS = False\n```\n\n#### 2. 环境变量文件\n\n创建 `.env` 文件来存储你的密钥。**注意：这个文件应该被添加到 `.gitignore` 中，不要提交到版本控制系统！**\n\n**`.env`**\n```\n# 你可以使用 'python -c \"import os; print(os.urandom(24))\"' 来生成一个随机密钥\nSECRET_KEY='a-super-secret-random-string-that-you-should-change'\n```\n\n创建 `.flaskenv` 文件，这样你就不必每次都设置 `FLASK_APP` 环境变量。\n\n**`.flaskenv`**\n```\nFLASK_APP=app.py\nFLASK_ENV=development\n```\n\n#### 3. 主应用文件 (`app.py`)\n\n这是应用的核心，包含了初始化、模型定义、路由和视图函数。\n\n**`app.py`**\n```python\nfrom flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_sqlalchemy import SQLAlchemy\nfrom config import Config\nfrom datetime import datetime\n\n# --- 1. 应用初始化 ---\napp = Flask(__name__)\napp.config.from_object(Config)\n\n# --- 2. 数据库初始化 ---\ndb = SQLAlchemy(app)\n\n# --- 3. 数据库模型定义 ---\nclass Post(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(100), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    author = db.Column(db.String(50), nullable=False, default='Anonymous')\n    date_posted = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n\n    def __repr__(self):\n        return f\"Post('{self.title}', '{self.date_posted}')\"\n\n# --- 4. 路由和视图函数 ---\n\n# 首页：显示所有文章\n@app.route('/')\ndef index():\n    # 从数据库获取所有文章，按日期降序排列\n    posts = Post.query.order_by(Post.date_posted.desc()).all()\n    return render_template('index.html', posts=posts)\n\n# 创建新文章\n@app.route('/create', methods=['GET', 'POST'])\ndef create_post():\n    if request.method == 'POST':\n        title = request.form['title']\n        content = request.form['content']\n        author = request.form['author']\n        \n        # 创建新文章对象\n        new_post = Post(title=title, content=content, author=author)\n        \n        # 将新文章添加到数据库\n        try:\n            db.session.add(new_post)\n            db.session.commit()\n            flash('文章发布成功！', 'success')\n            return redirect(url_for('index'))\n        except:\n            flash('发布文章时出错。', 'danger')\n            \n    return render_template('create_post.html')\n\n# 显示单篇文章\n@app.route('/post/<int:post_id>')\ndef post(post_id):\n    # 根据ID获取文章，如果找不到则返回404错误\n    post = Post.query.get_or_404(post_id)\n    return render_template('post.html', post=post)\n\n# --- 5. 启动应用 ---\nif __name__ == '__main__':\n    # 在运行应用之前，创建数据库表（如果它们还不存在）\n    with app.app_context():\n        db.create_all()\n    app.run(debug=True)\n```\n\n#### 4. 模板文件\n\n这些是 HTML 文件，使用了 Jinja2 语法。\n\n**`templates/base.html`**\n所有其他页面都将继承这个基础模板。\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>我的 Flask 博客</title>\n    <!-- 引入 Bootstrap CSS 以快速美化页面 -->\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n    <!-- 引入自定义 CSS -->\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='css/style.css') }}\">\n</head>\n<body>\n    <nav class=\"navbar navbar-expand-lg navbar-dark bg-dark\">\n        <div class=\"container\">\n            <a class=\"navbar-brand\" href=\"{{ url_for('index') }}\">Flask 博客</a>\n            <div class=\"collapse navbar-collapse\">\n                <ul class=\"navbar-nav ms-auto\">\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"{{ url_for('index') }}\">首页</a>\n                    </li>\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"{{ url_for('create_post') }}\">发布文章</a>\n                    </li>\n                </ul>\n            </div>\n        </div>\n    </nav>\n\n    <main class=\"container mt-4\">\n        <!-- Flash 消息显示 -->\n        {% with messages = get_flashed_messages(with_categories=true) %}\n            {% if messages %}\n                {% for category, message in messages %}\n                    <div class=\"alert alert-{{ category }} alert-dismissible fade show\" role=\"alert\">\n                        {{ message }}\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                    </div>\n                {% endfor %}\n            {% endif %}\n        {% endwith %}\n\n        {% block content %}{% endblock %}\n    </main>\n\n    <!-- 引入 Bootstrap JS -->\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js\"></script>\n</body>\n</html>\n```\n\n**`templates/index.html`**\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <h1 class=\"mb-4\">欢迎来到我的博客</h1>\n\n    {% if posts %}\n        {% for post in posts %}\n            <div class=\"card mb-3\">\n                <div class=\"card-body\">\n                    <h2 class=\"card-title\">\n                        <a href=\"{{ url_for('post', post_id=post.id) }}\" class=\"text-decoration-none\">{{ post.title }}</a>\n                    </h2>\n                    <p class=\"card-text text-muted\">作者: {{ post.author }} | 发布于: {{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</p>\n                    <p class=\"card-text\">{{ post.content[:150] }}...</p>\n                    <a href=\"{{ url_for('post', post_id=post.id) }}\" class=\"btn btn-primary\">阅读全文</a>\n                </div>\n            </div>\n        {% endfor %}\n    {% else %}\n        <p>还没有文章。</p>\n    {% endif %}\n{% endblock %}\n```\n\n**`templates/create_post.html`**\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <h1>发布新文章</h1>\n    <form method=\"POST\" action=\"{{ url_for('create_post') }}\">\n        <div class=\"mb-3\">\n            <label for=\"title\" class=\"form-label\">标题</label>\n            <input type=\"text\" class=\"form-control\" id=\"title\" name=\"title\" required>\n        </div>\n        <div class=\"mb-3\">\n            <label for=\"author\" class=\"form-label\">作者</label>\n            <input type=\"text\" class=\"form-control\" id=\"author\" name=\"author\">\n        </div>\n        <div class=\"mb-3\">\n            <label for=\"content\" class=\"form-label\">内容</label>\n            <textarea class=\"form-control\" id=\"content\" name=\"content\" rows=\"10\" required></textarea>\n        </div>\n        <button type=\"submit\" class=\"btn btn-success\">发布</button>\n    </form>\n{% endblock %}\n```\n\n**`templates/post.html`**\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <article>\n        <header>\n            <h1>{{ post.title }}</h1>\n            <div class=\"text-muted\">\n                <small>作者: {{ post.author }} | 发布于: {{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>\n            </div>\n        </header>\n        <hr>\n        <section class=\"mt-4\">\n            {{ post.content | nl2br }}\n        </section>\n    </article>\n    <a href=\"{{ url_for('index') }}\" class=\"btn btn-secondary mt-4\">返回首页</a>\n{% endblock %}\n```\n*注意：为了在模板中安全地换行，我们可以创建一个简单的 `nl2br` 过滤器。我们可以在 `app.py` 中添加它：*\n\n在 `app.py` 的 `app = Flask(__name__)` 下面添加：\n```python\n# 在 app.py 中添加这个过滤器\n@app.template_filter('nl2br')\ndef nl2br_filter(text):\n    return text.replace('\\n', '<br>\\n')\n```\n\n#### 5. 静态文件\n\n**`static/css/style.css`**\n这里可以放一些自定义样式。\n```css\nbody {\n    background-color: #f8f9fa;\n    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n}\n\n.card {\n    box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n}\n\narticle section {\n    line-height: 1.8;\n    font-size: 1.1em;\n}\n```\n\n---\n\n### 第 4 步：运行应用\n\n现在，所有文件都已就位。按照以下步骤运行你的 Flask 应用：\n\n1.  **打开终端**，并确保你在 `my_flask_app` 目录下。\n\n2.  **设置环境变量**（如果你使用的是 PowerShell 或 Bash）：\n    *   **Windows (CMD)**: `set FLASK_APP=app.py`\n    *   **Windows (PowerShell)**: `$env:FLASK_APP = \"app.py\"`\n    *   **macOS / Linux**: `export FLASK_APP=app.py`\n    *   *(因为我们创建了 `.flaskenv` 文件，这一步可以省略)*\n\n3.  **初始化数据库**。Flask-SQLAlchemy 不会自动创建数据库表。我们需要在 `app.py` 中添加 `db.create_all()` 的逻辑。\n    *   最简单的做法是运行一次 Python shell：\n        ```bash\n        flask shell\n        ```\n        然后在 shell 中输入：\n        ```python\n        >>> from app import db\n        >>> db.create_all()\n        >>> exit()\n        ```\n    *   执行后，你的项目根目录下会出现一个名为 `app.db` 的文件，这就是你的数据库。\n    *   我们已经在 `app.py` 的 `if __name__ == '__main__':` 代码块中加入了 `db.create_all()`，所以你直接运行 `python app.py` 也能自动创建数据库。\n\n4.  **启动开发服务器**：\n    ```bash\n    flask run\n    ```\n    或者直接运行 Python 文件：\n    ```bash\n    python app.py\n    ```\n\n5.  你会看到类似下面的输出：\n    ```\n     * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)\n    ```\n\n现在，打开你的网页浏览器，访问 **http://127.0.0.1:5000/**，你就可以看到你的博客应用了！\n\n*   点击 \"发布文章\" 创建你的第一篇博客。\n*   在首页点击文章标题或 \"阅读全文\" 查看文章详情。\n*   所有数据都会被保存在 `app.db` 文件中。\n\n恭喜！你已经成功创建了一个功能丰富的 Flask 应用。"
  },
  {
    "role": "user",
    "content": "添加用户认证功能"
  },
  {
    "role": "assistant",
    "content": "好的，这是一个非常好的想法！用户认证是大多数 Web 应用的核心功能。我们将使用 `Flask-Login` 来管理用户会话，`Flask-WTF` 来处理表单，并使用 `Werkzeug` 来安全地处理密码哈希。\n\n我们将扩展现有的博客应用，添加以下功能：\n\n*   **用户注册**：新用户可以创建账户。\n*   **用户登录**：已注册用户可以登录。\n*   **用户登出**：登录用户可以安全登出。\n*   **保护路由**：只有登录用户才能发布新文章。\n*   **用户关联**：每篇文章都会关联到其作者。\n\n---\n\n### 第 1 步：更新依赖\n\n首先，我们需要添加新的库到 `requirements.txt` 文件中。\n\n**`requirements.txt`** (添加新的库)\n```\nFlask\nFlask-SQLAlchemy\npython-dotenv\nFlask-Login\nFlask-WTF\nemail-validator\n```\n\n然后，在终端中运行以下命令来安装它们：\n\n```bash\npip install -r requirements.txt\n```\n*   `Flask-Login`: 提供用户会话管理（登录、登出、记住我等）。\n*   `Flask-WTF`: 集成 WTForms，用于创建和验证 Web 表单。\n*   `email-validator`: `Flask-WTF` 在验证邮箱时需要。\n\n---\n\n### 第 2 步：更新项目结构\n\n我们需要为新功能添加一些文件。更新后的结构如下：\n\n```\nmy_flask_app/\n├── app.py\n├── config.py\n├── .env\n├── .flaskenv\n├── requirements.txt\n├── static/\n│   └── css/\n│       └── style.css\n│\n└── templates/\n    ├── base.html          # 更新导航栏\n    ├── index.html\n    ├── create_post.html   # 更新以显示作者信息\n    ├── post.html\n    ├── login.html         # 新增：登录页面\n    ├── register.html      # 新增：注册页面\n    └── errors/\n        └── 404.html       # 新增：404 错误页面\n```\n\n---\n\n### 第 3 步：更新代码\n\n现在，我们来修改和添加代码。\n\n#### 1. 更新 `app.py`\n\n这是改动最大的地方。我们将添加 `User` 模型、表单类、登录/登出逻辑，并保护路由。\n\n**`app.py` (完整更新后的代码)**\n```python\nfrom flask import Flask, render_template, request, redirect, url_for, flash, abort\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, SubmitField, TextAreaField\nfrom wtforms.validators import DataRequired, Length, Email, EqualTo, ValidationError\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom config import Config\nfrom datetime import datetime\nimport os\n\n# --- 1. 应用初始化 ---\napp = Flask(__name__)\napp.config.from_object(Config)\n\n# --- 2. 数据库和登录管理器初始化 ---\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager(app)\n# 告诉 Flask-Login，如果用户未登录，应该重定向到哪个页面\nlogin_manager.login_view = 'login'\nlogin_manager.login_message = '请先登录以访问此页面。'\nlogin_manager.login_message_category = 'info'\n\n# --- 3. 数据库模型定义 ---\n\n# UserMixin 为 User 类提供默认的 is_authenticated, is_active 等实现\nclass User(UserMixin, db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(20), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password_hash = db.Column(db.String(128))\n    # 与 Post 模型建立反向关系\n    posts = db.relationship('Post', backref='author', lazy=True)\n\n    def __repr__(self):\n        return f\"User('{self.username}', '{self.email}')\"\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\nclass Post(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(100), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    date_posted = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    # 外键，关联到 User 模型的 id\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n\n    def __repr__(self):\n        return f\"Post('{self.title}', '{self.date_posted}')\"\n\n# --- 4. Flask-Login 回调函数 ---\n# 这个回调函数用于从会话中重新加载用户对象\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\n# --- 5. 表单类定义 ---\nclass RegistrationForm(FlaskForm):\n    username = StringField('用户名', validators=[DataRequired(), Length(min=4, max=20)])\n    email = StringField('邮箱', validators=[DataRequired(), Email()])\n    password = PasswordField('密码', validators=[DataRequired(), Length(min=8)])\n    confirm_password = PasswordField('确认密码', validators=[DataRequired(), EqualTo('password')])\n    submit = SubmitField('注册')\n\n    def validate_username(self, username):\n        user = User.query.filter_by(username=username.data).first()\n        if user:\n            raise ValidationError('该用户名已被占用，请选择其他用户名。')\n\n    def validate_email(self, email):\n        user = User.query.filter_by(email=email.data).first()\n        if user:\n            raise ValidationError('该邮箱已被注册，请使用其他邮箱。')\n\nclass LoginForm(FlaskForm):\n    email = StringField('邮箱', validators=[DataRequired(), Email()])\n    password = PasswordField('密码', validators=[DataRequired()])\n    submit = SubmitField('登录')\n\nclass PostForm(FlaskForm):\n    title = StringField('标题', validators=[DataRequired()])\n    content = TextAreaField('内容', validators=[DataRequired()])\n    submit = SubmitField('发布')\n\n# --- 6. 路由和视图函数 ---\n\n# 首页\n@app.route('/')\ndef index():\n    posts = Post.query.order_by(Post.date_posted.desc()).all()\n    return render_template('index.html', posts=posts)\n\n# 注册\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    # 如果用户已登录，重定向到首页\n    if current_user.is_authenticated:\n        return redirect(url_for('index'))\n    form = RegistrationForm()\n    if form.validate_on_submit():\n        user = User(username=form.username.data, email=form.email.data)\n        user.set_password(form.password.data)\n        db.session.add(user)\n        db.session.commit()\n        flash('恭喜，注册成功！现在可以登录了。', 'success')\n        return redirect(url_for('login'))\n    return render_template('register.html', title='注册', form=form)\n\n# 登录\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('index'))\n    form = LoginForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        # 检查用户是否存在以及密码是否正确\n        if user and user.check_password(form.password.data):\n            login_user(user, remember=True) # remember=True 可以记住登录状态\n            next_page = request.args.get('next')\n            flash('登录成功！', 'success')\n            return redirect(next_page) if next_page else redirect(url_for('index'))\n        else:\n            flash('登录失败，请检查邮箱和密码。', 'danger')\n    return render_template('login.html', title='登录', form=form)\n\n# 登出\n@app.route('/logout')\ndef logout():\n    logout_user()\n    flash('您已成功登出。', 'info')\n    return redirect(url_for('index'))\n\n# 创建新文章 (使用@login_required装饰器进行保护)\n@app.route('/create', methods=['GET', 'POST'])\n@login_required\ndef create_post():\n    form = PostForm()\n    if form.validate_on_submit():\n        post = Post(title=form.title.data, content=form.content.data, author=current_user)\n        db.session.add(post)\n        db.session.commit()\n        flash('文章发布成功！', 'success')\n        return redirect(url_for('index'))\n    return render_template('create_post.html', title='创建文章', form=form)\n\n# 显示单篇文章\n@app.route('/post/<int:post_id>')\ndef post(post_id):\n    post = Post.query.get_or_404(post_id)\n    return render_template('post.html', title=post.title, post=post)\n\n# 404 错误处理\n@app.errorhandler(404)\ndef page_not_found(error):\n    return render_template('errors/404.html'), 404\n\n# --- 7. 启动应用 ---\nif __name__ == '__main__':\n    with app.app_context():\n        db.create_all()\n    app.run(debug=True)\n```\n\n#### 2. 更新模板\n\n我们需要更新模板以适应新功能。\n\n**`templates/base.html`** (更新导航栏)\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<!-- ... head 部分保持不变 ... -->\n<body>\n    <nav class=\"navbar navbar-expand-lg navbar-dark bg-dark\">\n        <div class=\"container\">\n            <a class=\"navbar-brand\" href=\"{{ url_for('index') }}\">Flask 博客</a>\n            <div class=\"collapse navbar-collapse\">\n                <ul class=\"navbar-nav me-auto\">\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"{{ url_for('index') }}\">首页</a>\n                    </li>\n                    <!-- 只有登录用户才能看到发布文章的链接 -->\n                    {% if current_user.is_authenticated %}\n                    <li class=\"nav-item\">\n                        <a class=\"nav-link\" href=\"{{ url_for('create_post') }}\">发布文章</a>\n                    </li>\n                    {% endif %}\n                </ul>\n                <!-- 根据登录状态显示不同的导航项 -->\n                <ul class=\"navbar-nav ms-auto\">\n                    {% if current_user.is_authenticated %}\n                        <li class=\"nav-item dropdown\">\n                            <a class=\"nav-link dropdown-toggle\" href=\"#\" id=\"navbarDropdown\" role=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                                {{ current_user.username }}\n                            </a>\n                            <ul class=\"dropdown-menu dropdown-menu-end\" aria-labelledby=\"navbarDropdown\">\n                                <li><a class=\"dropdown-item\" href=\"{{ url_for('logout') }}\">登出</a></li>\n                            </ul>\n                        </li>\n                    {% else %}\n                        <li class=\"nav-item\">\n                            <a class=\"nav-link\" href=\"{{ url_for('login') }}\">登录</a>\n                        </li>\n                        <li class=\"nav-item\">\n                            <a class=\"nav-link\" href=\"{{ url_for('register') }}\">注册</a>\n                        </li>\n                    {% endif %}\n                </ul>\n            </div>\n        </div>\n    </nav>\n\n    <main class=\"container mt-4\">\n        <!-- Flash 消息显示 -->\n        {% with messages = get_flashed_messages(with_categories=true) %}\n            {% if messages %}\n                {% for category, message in messages %}\n                    <div class=\"alert alert-{{ category }} alert-dismissible fade show\" role=\"alert\">\n                        {{ message }}\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                    </div>\n                {% endfor %}\n            {% endif %}\n        {% endwith %}\n\n        {% block content %}{% endblock %}\n    </main>\n\n    <!-- ... JS 脚本部分保持不变 ... -->\n</body>\n</html>\n```\n\n**`templates/create_post.html`** (更新表单)\n我们将使用 Flask-WTF 来渲染表单，这样更安全、更简洁。\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <h1>发布新文章</h1>\n    <form method=\"POST\" action=\"\">\n        <!-- 隐藏的CSRF令牌 -->\n        {{ form.hidden_tag() }}\n        <div class=\"mb-3\">\n            {{ form.title.label(class=\"form-label\") }}\n            {{ form.title(class=\"form-control\") }}\n            {% if form.title.errors %}\n                <div class=\"text-danger\">\n                    {% for error in form.title.errors %}\n                        <span>{{ error }}</span>\n                    {% endfor %}\n                </div>\n            {% endif %}\n        </div>\n        <div class=\"mb-3\">\n            {{ form.content.label(class=\"form-label\") }}\n            {{ form.content(class=\"form-control\", rows=\"10\") }}\n            {% if form.content.errors %}\n                <div class=\"text-danger\">\n                    {% for error in form.content.errors %}\n                        <span>{{ error }}</span>\n                    {% endfor %}\n                </div>\n            {% endif %}\n        </div>\n        <div class=\"mb-3\">\n            {{ form.submit(class=\"btn btn-success\") }}\n        </div>\n    </form>\n{% endblock %}\n```\n\n**`templates/login.html`** (新增)\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <div class=\"row justify-content-center\">\n        <div class=\"col-md-6\">\n            <div class=\"card\">\n                <div class=\"card-header\">\n                    <h2>登录</h2>\n                </div>\n                <div class=\"card-body\">\n                    <form method=\"POST\" action=\"\">\n                        {{ form.hidden_tag() }}\n                        <div class=\"mb-3\">\n                            {{ form.email.label(class=\"form-label\") }}\n                            {{ form.email(class=\"form-control\") }}\n                        </div>\n                        <div class=\"mb-3\">\n                            {{ form.password.label(class=\"form-label\") }}\n                            {{ form.password(class=\"form-control\") }}\n                        </div>\n                        <div class=\"d-grid\">\n                            {{ form.submit(class=\"btn btn-primary\") }}\n                        </div>\n                    </form>\n                </div>\n            </div>\n            <p class=\"text-center mt-2\">还没有账户? <a href=\"{{ url_for('register') }}\">立即注册</a></p>\n        </div>\n    </div>\n{% endblock %}\n```\n\n**`templates/register.html`** (新增)\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <div class=\"row justify-content-center\">\n        <div class=\"col-md-6\">\n            <div class=\"card\">\n                <div class=\"card-header\">\n                    <h2>注册</h2>\n                </div>\n                <div class=\"card-body\">\n                    <form method=\"POST\" action=\"\">\n                        {{ form.hidden_tag() }}\n                        <div class=\"mb-3\">\n                            {{ form.username.label(class=\"form-label\") }}\n                            {{ form.username(class=\"form-control\") }}\n                            {% if form.username.errors %}\n                                <div class=\"text-danger\">\n                                    {% for error in form.username.errors %}\n                                        <span>{{ error }}</span>\n                                    {% endfor %}\n                                </div>\n                            {% endif %}\n                        </div>\n                        <div class=\"mb-3\">\n                            {{ form.email.label(class=\"form-label\") }}\n                            {{ form.email(class=\"form-control\") }}\n                            {% if form.email.errors %}\n                                <div class=\"text-danger\">\n                                    {% for error in form.email.errors %}\n                                        <span>{{ error }}</span>\n                                    {% endfor %}\n                                </div>\n                            {% endif %}\n                        </div>\n                        <div class=\"mb-3\">\n                            {{ form.password.label(class=\"form-label\") }}\n                            {{ form.password(class=\"form-control\") }}\n                            {% if form.password.errors %}\n                                <div class=\"text-danger\">\n                                    {% for error in form.password.errors %}\n                                        <span>{{ error }}</span>\n                                    {% endfor %}\n                                </div>\n                            {% endif %}\n                        </div>\n                        <div class=\"mb-3\">\n                            {{ form.confirm_password.label(class=\"form-label\") }}\n                            {{ form.confirm_password(class=\"form-control\") }}\n                            {% if form.confirm_password.errors %}\n                                <div class=\"text-danger\">\n                                    {% for error in form.confirm_password.errors %}\n                                        <span>{{ error }}</span>\n                                    {% endfor %}\n                                </div>\n                            {% endif %}\n                        </div>\n                        <div class=\"d-grid\">\n                            {{ form.submit(class=\"btn btn-success\") }}\n                        </div>\n                    </form>\n                </div>\n            </div>\n            <p class=\"text-center mt-2\">已有账户? <a href=\"{{ url_for('login') }}\">立即登录</a></p>\n        </div>\n    </div>\n{% endblock %}\n```\n\n**`templates/errors/404.html`** (新增)\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <h1 class=\"text-center\">404</h1>\n    <p class=\"text-center\">糟糕！你访问的页面不存在。</p>\n    <p class=\"text-center\"><a href=\"{{ url_for('index') }}\">返回首页</a></p>\n{% endblock %}\n```\n\n**`templates/post.html`** (更新)\n```html\n{% extends \"base.html\" %}\n\n{% block content %}\n    <article>\n        <header>\n            <h1>{{ post.title }}</h1>\n            <div class=\"text-muted\">\n                <small>作者: {{ post.author.username }} | 发布于: {{ post.date_posted.strftime('%Y-%m-%d %H:%M') }}</small>\n            </div>\n        </header>\n        <hr>\n        <section class=\"mt-4\">\n            {{ post.content | nl2br }}\n        </section>\n    </article>\n    <a href=\"{{ url_for('index') }}\" class=\"btn btn-secondary mt-4\">返回首页</a>\n{% endblock %}\n```\n\n---\n\n### 第 4 步：重新初始化数据库并运行应用\n\n因为我们添加了新的 `User` 模型，并更改了 `Post` 模型（添加了 `user_id` 外键），旧的 `app.db` 文件已经不兼容了。\n\n1.  **删除旧的数据库文件**：在你的项目根目录下，找到并删除 `app.db` 文件。\n\n2.  **运行应用**：\n    ```bash\n    flask run\n    ```\n    或者\n    ```bash\n    python app.py\n    ```\n    当你启动应用时，`app.py` 中的 `db.create_all()` 会自动检测到模型变化，并创建一个新的、包含 `user` 和 `post` 表（以及它们之间的外键关系）的 `app.db` 文件。\n\n3.  **测试功能**：\n    *   访问 http://127.0.0.1:5000/。\n    *   点击导航栏的 \"注册\"，创建一个新用户。\n    *   注册成功后，会被重定向到 \"登录\" 页面。\n    *   使用你刚注册的账户登录。\n    *   登录成功后，你会发现导航栏右侧显示了你的用户名，并且 \"发布"
  },
  {
    "role": "user",
    "content": "使用 JWT 做 token 认证"
  },
  {
    "role": "assistant",
    "content": "好的！我们将把应用从前端渲染的会话认证（Session-based Authentication）转换为后端 API 风格的 JWT (JSON Web Token) 认证。这种模式非常适合构建前后端分离的应用或为移动应用提供 API。\n\n在这种模式下：\n*   **Flask 后端** 将不再渲染 HTML 页面，而是提供 JSON 格式的 API 端点。\n*   **前端** (我们将使用一个简单的 HTML/JavaScript 页面来模拟) 将负责调用这些 API，并根据 API 的响应来更新界面。\n\nJWT 认证的流程如下：\n1.  **用户登录**：用户通过 `/login` API 提供凭据（用户名和密码）。\n2.  **服务器验证**：服务器验证凭据。如果正确，它会生成一个包含用户 ID 和过期时间的 JWT，并将其返回给客户端。\n3.  **客户端存储 Token**：客户端（如浏览器）将这个 JWT 存储起来（例如，在 `localStorage` 或 `sessionStorage` 中）。\n4.  **客户端请求受保护资源**：当客户端请求一个受保护的 API (如 `/posts`) 时，它必须在 HTTP 请求的 `Authorization` 头中附带这个 JWT，格式为 `Bearer <token>`。\n5.  **服务器验证 Token**：服务器接收到请求后，会验证 `Authorization` 头中的 JWT。如果 token 有效，服务器处理请求并返回数据；如果无效或过期，则返回 401 未授权错误。\n\n---\n\n### 第 1 步：更新依赖和项目结构\n\n我们需要一个库来处理 JWT。\n\n**1. 更新 `requirements.txt`**\n```\nFlask\nFlask-SQLAlchemy\npython-dotenv\nFlask-Login\nFlask-WTF\nPyJWT  # 新增：用于处理 JWT\ncryptography # PyJWT 的一个依赖，用于更好的加密算法\n```\n\n然后安装新依赖：\n```bash\npip install -r requirements.txt\n```\n\n**2. 更新项目结构**\n我们将创建一个新的目录 `static` 来存放我们的前端模拟页面和 JavaScript。\n\n```\nmy_flask_app/\n├── app.py             # 将成为 API 服务器\n├── config.py\n├── .env\n├── .flaskenv\n├── requirements.txt\n├── static/            # 存放前端文件\n│   ├── index.html     # 单页应用入口\n│   ├── login.html     # 登录页面\n│   └── js/\n│       └── app.js     # 核心 JavaScript 逻辑\n│\n└── templates/         # 将不再使用，可以删除或忽略\n```\n\n---\n\n### 第 2 步：重写后端 API (`app.py`)\n\n我们将把 `app.py` 彻底改造成一个 REST API 服务器。\n\n**`app.py` (完整更新后的 API 代码)**\n```python\nimport os\nfrom datetime import datetime, timedelta\nfrom functools import wraps\nimport jwt\n\nfrom flask import Flask, request, jsonify, make_response\nfrom flask_sqlalchemy import SQLAlchemy\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom config import Config\n\n# --- 1. 应用和数据库初始化 ---\napp = Flask(__name__)\napp.config.from_object(Config)\n\ndb = SQLAlchemy(app)\n\n# --- 2. JWT 配置 ---\n# 从环境变量或配置文件中获取密钥\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY') or 'a-very-secret-key'\n# Token 过期时间设置为30分钟\nTOKEN_EXPIRATION_DELTA = timedelta(minutes=30)\n\n# --- 3. 数据库模型定义 ---\nclass User(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(50), unique=True, nullable=False)\n    password_hash = db.Column(db.String(128), nullable=False)\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n    def to_dict(self):\n        return {'id': self.id, 'username': self.username}\n\nclass Post(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(100), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    date_posted = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)\n    author = db.relationship('User', backref=db.backref('posts', lazy=True))\n\n    def to_dict(self):\n        return {\n            'id': self.id,\n            'title': self.title,\n            'content': self.content,\n            'date_posted': self.date_posted.isoformat(),\n            'author': self.author.to_dict()\n        }\n\n# --- 4. Token 验证装饰器 ---\ndef token_required(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        token = None\n        # 从请求头中获取 token\n        if 'Authorization' in request.headers:\n            auth_header = request.headers['Authorization']\n            try:\n                token = auth_header.split(\" \")[1] # Bearer <token>\n            except IndexError:\n                return jsonify({'message': 'Bearer token 格式错误！'}), 401\n\n        if not token:\n            return jsonify({'message': '缺少访问令牌！'}), 401\n\n        try:\n            # 解码 token\n            data = jwt.decode(token, app.config['SECRET_KEY'], algorithms=[\"HS256\"])\n            current_user = User.query.get(data['user_id'])\n            if not current_user:\n                return jsonify({'message': '令牌无效！'}), 401\n        except jwt.ExpiredSignatureError:\n            return jsonify({'message': '令牌已过期！'}), 401\n        except jwt.InvalidTokenError:\n            return jsonify({'message': '令牌无效！'}), 401\n\n        # 将当前用户对象传递给视图函数\n        return f(current_user, *args, **kwargs)\n\n    return decorated\n\n# --- 5. API 路由定义 ---\n\n@app.route('/api/register', methods=['POST'])\ndef register():\n    data = request.get_json()\n    if not data or not data.get('username') or not data.get('password'):\n        return make_response(jsonify({'message': '用户名和密码不能为空！'}), 400)\n\n    if User.query.filter_by(username=data['username']).first():\n        return make_response(jsonify({'message': '该用户名已被注册！'}), 409)\n\n    user = User(username=data['username'])\n    user.set_password(data['password'])\n    db.session.add(user)\n    db.session.commit()\n\n    return jsonify({'message': '新用户创建成功！'}), 201\n\n@app.route('/api/login', methods=['POST'])\ndef login():\n    auth = request.get_json()\n    if not auth or not auth.get('username') or not auth.get('password'):\n        return make_response('缺少登录凭据', 401, {'WWW-Authenticate': 'Basic realm=\"Login required!\"'})\n\n    user = User.query.filter_by(username=auth['username']).first()\n    if not user or not user.check_password(auth['password']):\n        return make_response('验证失败', 403, {'WWW-Authenticate': 'Basic realm=\"Wrong Password!\"'})\n\n    # 生成 token\n    token = jwt.encode({\n        'user_id': user.id,\n        'exp': datetime.utcnow() + TOKEN_EXPIRATION_DELTA\n    }, app.config['SECRET_KEY'], algorithm=\"HS256\")\n\n    return jsonify({'token': token})\n\n\n@app.route('/api/posts', methods=['GET'])\ndef get_all_posts():\n    posts = Post.query.order_by(Post.date_posted.desc()).all()\n    return jsonify([post.to_dict() for post in posts])\n\n@app.route('/api/posts', methods=['POST'])\n@token_required\ndef create_post(current_user):\n    data = request.get_json()\n    if not data or not data.get('title') or not data.get('content'):\n        return jsonify({'message': '标题和内容不能为空！'}), 400\n\n    post = Post(title=data['title'], content=data['content'], author=current_user)\n    db.session.add(post)\n    db.session.commit()\n\n    return jsonify({'message': '文章创建成功！', 'post': post.to_dict()}), 201\n\n# --- 6. 启动应用 ---\nif __name__ == '__main__':\n    with app.app_context():\n        db.create_all()\n    app.run(debug=True)\n\n```\n\n---\n\n### 第 3 步：创建前端客户端\n\n现在，我们创建前端文件来与这个 API 交互。\n\n**`static/index.html` (应用主页面)**\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>JWT 博客客户端</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n</head>\n<body>\n    <nav class=\"navbar navbar-expand-lg navbar-dark bg-dark\">\n        <div class=\"container\">\n            <a class=\"navbar-brand\" href=\"#\">JWT 博客</a>\n            <div class=\"collapse navbar-collapse\">\n                <ul class=\"navbar-nav ms-auto\" id=\"nav-links\">\n                    <!-- 导航链接将由 JavaScript 动态生成 -->\n                </ul>\n            </div>\n        </div>\n    </nav>\n\n    <main class=\"container mt-4\">\n        <div id=\"app-content\">\n            <!-- 内容将由 JavaScript 动态加载 -->\n        </div>\n    </main>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js\"></script>\n    <script src=\"js/app.js\"></script>\n</body>\n</html>\n```\n\n**`static/login.html` (登录页面)**\n这个页面现在只负责提供登录表单。\n```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>登录</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n</head>\n<body>\n    <div class=\"container mt-5\">\n        <div class=\"row justify-content-center\">\n            <div class=\"col-md-6\">\n                <div class=\"card\">\n                    <div class=\"card-header\">\n                        <h2>登录</h2>\n                    </div>\n                    <div class=\"card-body\">\n                        <form id=\"login-form\">\n                            <div class=\"mb-3\">\n                                <label for=\"username\" class=\"form-label\">用户名</label>\n                                <input type=\"text\" class=\"form-control\" id=\"username\" required>\n                            </div>\n                            <div class=\"mb-3\">\n                                <label for=\"password\" class=\"form-label\">密码</label>\n                                <input type=\"password\" class=\"form-control\" id=\"password\" required>\n                            </div>\n                            <button type=\"submit\" class=\"btn btn-primary w-100\">登录</button>\n                        </form>\n                        <div id=\"login-error\" class=\"alert alert-danger mt-3\" style=\"display: none;\"></div>\n                    </div>\n                </div>\n                <p class=\"text-center mt-2\">还没有账户? <a href=\"register.html\">立即注册</a></p>\n            </div>\n        </div>\n    </div>\n    <script src=\"js/app.js\"></script>\n</body>\n</html>\n```\n**注意**：为了简化，我们让登录和注册是独立的页面。你也可以将它们做成弹窗。\n\n**`static/js/app.js` (核心 JavaScript 逻辑)**\n这是连接前后端的桥梁。\n```javascript\nconst API_URL = 'http://127.0.0.1:5000/api';\n\n// 检查 localStorage 中是否有 token\nlet currentToken = localStorage.getItem('jwtToken');\nlet currentUser = JSON.parse(localStorage.getItem('currentUser'));\n\n// Axios 拦截器：自动为所有请求添加 Authorization header\nif (currentToken) {\n    axios.defaults.headers.common['Authorization'] = `Bearer ${currentToken}`;\n}\n\n// 页面加载完成后执行\ndocument.addEventListener('DOMContentLoaded', () => {\n    // 如果在登录页面\n    if (document.getElementById('login-form')) {\n        const loginForm = document.getElementById('login-form');\n        loginForm.addEventListener('submit', handleLogin);\n    } \n    // 如果在主页面\n    else if (document.getElementById('app-content')) {\n        if (currentToken) {\n            loadContent();\n        } else {\n            showLoginForm();\n        }\n    }\n});\n\n// 处理登录\nasync function handleLogin(event) {\n    event.preventDefault();\n    const username = document.getElementById('username').value;\n    const password = document.getElementById('password').value;\n    const errorDiv = document.getElementById('login-error');\n\n    try {\n        const response = await axios.post(`${API_URL}/login`, { username, password });\n        \n        // 保存认证信息\n        currentToken = response.data.token;\n        localStorage.setItem('jwtToken', currentToken);\n        \n        // 获取并保存用户信息（如果API返回了）\n        // 这里为了简化，我们直接用用户名\n        currentUser = { username: username };\n        localStorage.setItem('currentUser', JSON.stringify(currentUser));\n\n        // 设置 axios 默认 header\n        axios.defaults.headers.common['Authorization'] = `Bearer ${currentToken}`;\n\n        // 登录成功后跳转到主页\n        window.location.href = '/index.html';\n\n    } catch (error) {\n        errorDiv.textContent = '登录失败: ' + (error.response.data.message || error.message);\n        errorDiv.style.display = 'block';\n    }\n}\n\n// 在主页面加载内容\nasync function loadContent() {\n    updateNavigation(true);\n    const appContent = document.getElementById('app-content');\n\n    try {\n        const response = await axios.get(`${API_URL}/posts`);\n        const posts = response.data;\n        \n        let postsHtml = '<h1>所有文章</h1>';\n        postsHtml += '<button id=\"create-post-btn\" class=\"btn btn-primary mb-3\">创建新文章</button>';\n        postsHtml += '<div id=\"post-list\">';\n        posts.forEach(post => {\n            postsHtml += `\n                <div class=\"card mb-3\">\n                    <div class=\"card-body\">\n                        <h5 class=\"card-title\">${post.title}</h5>\n                        <p class=\"card-text text-muted\">作者: ${post.author.username} | 发布于: ${new Date(post.date_posted).toLocaleString()}</p>\n                        <p class=\"card-text\">${post.content.substring(0, 150)}...</p>\n                    </div>\n                </div>\n            `;\n        });\n        postsHtml += '</div>';\n        appContent.innerHTML = postsHtml;\n\n        // 绑定创建文章按钮事件\n        document.getElementById('create-post-btn').addEventListener('click', showCreatePostForm);\n\n    } catch (error) {\n        if (error.response && error.response.status === 401) {\n            logout(); // Token 无效，执行登出\n        } else {\n            appContent.innerHTML = '<p class=\"text-danger\">加载文章失败。</p>';\n        }\n    }\n}\n\nfunction updateNavigation(isLoggedIn) {\n    const navLinks = document.getElementById('nav-links');\n    if (isLoggedIn) {\n        navLinks.innerHTML = `\n            <li class=\"nav-item dropdown\">\n                <a class=\"nav-link dropdown-toggle\" href=\"#\" id=\"navbarDropdown\" role=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\">\n                    ${currentUser.username}\n                </a>\n                <ul class=\"dropdown-menu dropdown-menu-end\" aria-labelledby=\"navbarDropdown\">\n                    <li><a class=\"dropdown-item\" href=\"#\" onclick=\"logout()\">登出</a></li>\n                </ul>\n            </li>\n        `;\n    } else {\n        navLinks.innerHTML = `\n            <li class=\"nav-item\"><a class=\"nav-link\" href=\"/login.html\">登录</a></li>\n            <li class=\"nav-item\"><a class=\"nav-link\" href=\"/register.html\">注册</a></li>\n        `;\n    }\n}\n\nfunction logout() {\n    localStorage.removeItem('jwtToken');\n    localStorage.removeItem('currentUser');\n    currentToken = null;\n    currentUser = null;\n    delete axios.defaults.headers.common['Authorization'];\n    window.location.href = '/login.html';\n}\n\n// 显示创建文章表单\nfunction showCreatePostForm() {\n    const appContent = document.getElementById('app-content');\n    appContent.innerHTML = `\n        <h1>创建新文章</h1>\n        <form id=\"create-post-form\">\n            <div class=\"mb-3\">\n                <label for=\"post-title\" class=\"form-label\">标题</label>\n                <input type=\"text\" class=\"form-control\" id=\"post-title\" required>\n            </div>\n            <div class=\"mb-3\">\n                <label for=\"post-content\" class=\"form-label\">内容</label>\n                <textarea class=\"form-control\" id=\"post-content\" rows=\"10\" required></textarea>\n            </div>\n            <button type=\"submit\" class=\"btn btn-success\">发布</button>\n            <button type=\"button\" class=\"btn btn-secondary\" onclick=\"loadContent()\">取消</button>\n        </form>\n    `;\n    document.getElementById('create-post-form').addEventListener('submit', handleCreatePost);\n}\n\n// 处理创建文章\nasync function handleCreatePost(event) {\n    event.preventDefault();\n    const title = document.getElementById('post-title').value;\n    const content = document.getElementById('post-content').value;\n    \n    try {\n        await axios.post(`${API_URL}/posts`, { title, content });\n        alert('文章发布成功！');\n        loadContent(); // 重新加载文章列表\n    } catch (error) {\n        alert('发布失败: ' + (error.response.data.message || error.message));\n    }\n}\n```\n\n---\n\n### 第 4 步：运行和测试\n\n1.  **删除旧的 `app.db`**：因为 `User` 模型改变了，需要重建数据库。\n\n2.  **启动 Flask 后端**：\n    ```bash\n    python app.py\n    ```\n    API 服务器将在 `http://127.0.0.1:5000` 运行。\n\n3.  **访问前端客户端**：\n    *   **直接打开 `index.html`**：由于我们使用 `axios` 发起请求，存在跨域问题。最简单的解决方式是使用一个简单的 HTTP 服务器来提供静态文件。\n        *   进入 `static` 目录。\n        *   运行 `python -m http.server 8080` (Python 3)。\n        *   现在在浏览器中访问 `http://127.0.0.1:8080/index.html`。\n    *   **或者使用 VSCode 的 Live Server 插件**，这是最方便的方式。\n\n4.  **测试流程**：\n    *   访问 `http://127.0.0.1:8080/index.html`，你会看到提示登录。\n    *   点击链接跳转到 `http://"
  }
]