[
  {
    "role": "user",
    "content": "帮我创建一个 Flask 应用"
  },
  {
    "role": "assistant",
    "content": "好的，我们来创建一个简单但功能齐全的 Flask 应用。这个例子会涵盖：\n\n1.  **项目结构**：如何组织你的文件。\n2.  **基本路由**：创建网页和API接口。\n3.  **使用模板**：动态生成HTML。\n4.  **处理表单**：接收用户输入。\n\n---\n\n### 第一步：创建项目文件夹和文件\n\n首先，在你的电脑上创建一个新的项目文件夹，我们称之为 `my_flask_app`。在这个文件夹里，按照以下结构创建文件和目录：\n\n```\nmy_flask_app/\n├── app.py              # 我们的主要 Flask 应用文件\n├── templates/          # 存放 HTML 模板\n│   ├── index.html      # 主页模板\n│   └── greeting.html   # 一个动态页面模板\n└── static/             # 存放 CSS, JavaScript, 图片等静态文件\n    └── style.css       # 一个简单的 CSS 文件\n```\n\n### 第二步：安装 Flask\n\n打开你的终端或命令提示符，进入到你刚刚创建的 `my_flask_app` 文件夹，然后运行以下命令来安装 Flask。建议在虚拟环境中操作，以避免污染全局 Python 环境。\n\n```bash\n# 创建并激活虚拟环境 (推荐)\n# Windows\npython -m venv venv\n.\\venv\\Scripts\\activate\n\n# macOS / Linux\npython3 -m venv venv\nsource venv/bin/activate\n\n# 安装 Flask\npip install Flask\n```\n\n### 第三步：编写代码\n\n现在我们来填充这些文件的内容。\n\n#### 1. `app.py` - 应用的核心\n\n这是我们的主应用文件。它包含了所有的路由逻辑。\n\n```python\n# my_flask_app/app.py\n\nfrom flask import Flask, render_template, request, redirect, url_for\n\n# 创建 Flask 应用实例\napp = Flask(__name__)\n\n# 定义路由和视图函数\n@app.route('/')\ndef index():\n    \"\"\"渲染主页，主页包含一个表单\"\"\"\n    # render_template 会自动在 'templates' 文件夹中寻找 HTML 文件\n    return render_template('index.html')\n\n@app.route('/greet', methods=['POST'])\ndef greet():\n    \"\"\"处理来自表单的 POST 请求\"\"\"\n    if request.method == 'POST':\n        # 从表单中获取 'name' 字段的值\n        name = request.form.get('name')\n        if name:\n            # 如果用户输入了名字，就重定向到 /hello/<name>\n            # url_for('hello', name=name) 会生成 /hello/<用户输入的名字> 这样的URL\n            return redirect(url_for('hello', name=name))\n        else:\n            # 如果没有输入名字，就重定向回主页\n            return redirect(url_for('index'))\n\n@app.route('/hello/<name>')\ndef hello(name):\n    \"\"\"动态路由，根据 URL 中的名字显示问候语\"\"\"\n    # 将名字传递给模板\n    return render_template('greeting.html', name=name)\n\n@app.route('/api/data')\ndef get_data():\n    \"\"\"一个简单的 API 端点，返回 JSON 数据\"\"\"\n    # 这是一个字典，Flask 会自动将其转换为 JSON 响应\n    data = {\n        'message': 'This is some data from the API.',\n        'status': 'success'\n    }\n    return data\n\n# 运行应用\nif __name__ == '__main__':\n    # debug=True 会在代码更改后自动重启服务，并提供详细的错误信息\n    # 生产环境中请勿使用 debug=True\n    app.run(debug=True)\n```\n\n#### 2. `templates/index.html` - 主页模板\n\n这个文件包含一个简单的表单，让用户输入他们的名字。\n\n```html\n<!-- my_flask_app/templates/index.html -->\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>Flask 应用</title>\n    <!-- 引入 CSS 文件 -->\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n</head>\n<body>\n    <div class=\"container\">\n        <h1>欢迎来到我的 Flask 应用！</h1>\n        <p>请在下方输入你的名字：</p>\n        \n        <!-- 表单会向 /greet 路由发送 POST 请求 -->\n        <form action=\"{{ url_for('greet') }}\" method=\"post\">\n            <label for=\"name\">名字:</label>\n            <input type=\"text\" id=\"name\" name=\"name\">\n            <button type=\"submit\">提交</button>\n        </form>\n        \n        <p>你也可以直接访问 <a href=\"/api/data\">这个 API 接口</a> 获取一些数据。</p>\n    </div>\n</body>\n</html>\n```\n\n#### 3. `templates/greeting.html` - 问候页面模板\n\n这个页面会显示对用户的个性化问候。\n\n```html\n<!-- my_flask_app/templates/greeting.html -->\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>问候</title>\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n</head>\n<body>\n    <div class=\"container\">\n        <!-- 这里使用了从 app.py 传递过来的 'name' 变量 -->\n        <h1>你好, {{ name }}!</h1>\n        <p>很高兴见到你。</p>\n        <a href=\"{{ url_for('index') }}\">返回主页</a>\n    </div>\n</body>\n</html>\n```\n\n#### 4. `static/style.css` - 样式文件\n\n一点简单的 CSS 让页面更好看。\n\n```css\n/* my_flask_app/static/style.css */\n\nbody {\n    font-family: Arial, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    height: 100vh;\n    margin: 0;\n}\n\n.container {\n    background-color: white;\n    padding: 2em;\n    border-radius: 8px;\n    box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n    text-align: center;\n}\n\nh1 {\n    color: #4a90e2;\n}\n\nform {\n    margin-top: 1.5em;\n}\n\nlabel {\n    margin-right: 0.5em;\n}\n\ninput[type=\"text\"] {\n    padding: 0.5em;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n}\n\nbutton {\n    padding: 0.5em 1em;\n    background-color: #4a90e2;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n}\n\nbutton:hover {\n    background-color: #357abd;\n}\n```\n\n### 第四步：运行应用\n\n现在所有文件都准备好了。确保你在终端中位于 `my_flask_app` 文件夹的根目录，并且虚拟环境已经激活。\n\n运行以下命令启动你的 Flask 应用：\n\n```bash\nflask run\n```\n\n你应该会看到类似以下的输出：\n\n```\n * Serving Flask app 'app'\n * Debug mode: on\n * Running on http://127.0.0.1:5000\nPress CTRL+C to quit\n * Restarting with stat\n * Debugger is active!\n * Debugger PIN: ...\n```\n\n### 第五步：测试你的应用\n\n1.  打开你的网页浏览器。\n2.  访问 `http://127.0.0.1:5000`。\n3.  你会看到一个欢迎页面，上面有一个表单。\n4.  在表单中输入你的名字并点击“提交”。\n5.  页面会跳转到 `http://127.0.0.1:5000/hello/你的名字`，并显示个性化的问候语。\n6.  点击“返回主页”可以回到首页。\n7.  你也可以直接访问 `http://127.0.0.1:5000/api/data`，浏览器会显示一个 JSON 格式的数据。\n\n恭喜！你已经成功创建并运行了你的第一个 Flask 应用。你可以基于这个简单的框架继续扩展功能，比如连接数据库、添加用户认证等。"
  },
  {
    "role": "user",
    "content": "添加用户认证功能"
  },
  {
    "role": "assistant",
    "content": "好的！我们来为之前的 Flask 应用添加一个完整的用户认证功能。这个功能将包括：\n\n*   **用户注册**：新用户可以创建账户。\n*   **用户登录**：已注册用户可以登录。\n*   **会话管理**：登录后，用户的状态会被记住。\n*   **受保护的路由**：某些页面（如仪表盘）只对已登录的用户开放。\n*   **用户登出**：用户可以安全地退出登录。\n\n我们将使用 **Flask-Login** 库来简化用户会话管理，使用 **Werkzeug**（Flask 依赖的一部分）来安全地处理密码哈希。\n\n### 第一步：更新项目结构和文件\n\n我们需要对项目结构做一些调整，以更好地组织代码。\n\n1.  **安装新的库**：\n    ```bash\n    pip install Flask-Login\n    ```\n\n2.  **创建新的文件**：\n    你的 `my_flask_app` 文件夹现在看起来应该是这样的：\n\n    ```\n    my_flask_app/\n    ├── app.py              # 主应用文件，现在会更复杂\n    ├── templates/          # 存放 HTML 模板\n    │   ├── base.html       # 新增：一个基础模板，其他模板将继承它\n    │   ├── index.html      # 修改：使用基础模板\n    │   ├── login.html      # 新增：登录页面\n    │   ├── register.html   # 新增：注册页面\n    │   ├── dashboard.html  # 新增：登录后才能看到的仪表盘\n    │   └── greeting.html   # 保留：问候页面\n    └── static/             # 存放 CSS, JS 等静态文件\n        └── style.css       # 保留并更新样式\n    ```\n\n### 第二步：编写代码\n\n我们将逐步填充和更新这些文件。\n\n#### 1. `app.py` - 应用的核心 (已更新)\n\n这是更新最多的文件。它将包含用户模型、登录管理、注册和登录逻辑。\n\n```python\n# my_flask_app/app.py\n\nfrom flask import Flask, render_template, request, redirect, url_for, flash\nfrom flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user\nfrom werkzeug.security import generate_password_hash, check_password_hash\n\napp = Flask(__name__)\n\n# 设置一个密钥，这对于session安全至关重要\napp.config['SECRET_KEY'] = 'a_very_secret_key_that_should_be_changed'\n\n# --- 初始化 Flask-Login ---\nlogin_manager = LoginManager()\nlogin_manager.init_app(app)\nlogin_manager.login_view = 'login' # 如果用户未登录，将被重定向到 'login' 页面\n\n# --- 模拟数据库 ---\n# 在真实的应用中，你会使用数据库（如 SQLite, PostgreSQL）来存储用户信息\n# 这里我们用一个简单的 Python 字典来模拟\nusers = {}\n\n# --- 用户模型 ---\nclass User(UserMixin):\n    def __init__(self, id, username, password_hash):\n        self.id = id\n        self.username = username\n        self.password_hash = password_hash\n\n    def set_password(self, password):\n        self.password_hash = generate_password_hash(password)\n\n    def check_password(self, password):\n        return check_password_hash(self.password_hash, password)\n\n# --- Flask-Login 回调函数 ---\n@login_manager.user_loader\ndef load_user(user_id):\n    # 这个回调函数用于从 user_id 加载用户对象\n    return users.get(int(user_id))\n\n# --- 路由 ---\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n@app.route('/register', methods=['GET', 'POST'])\ndef register():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        \n        # 简单的验证\n        if not username or not password:\n            flash('用户名和密码不能为空。', 'error')\n            return redirect(url_for('register'))\n            \n        if any(user.username == username for user in users.values()):\n            flash('用户名已存在。', 'error')\n            return redirect(url_for('register'))\n            \n        # 创建新用户并保存到“数据库”\n        user_id = len(users) + 1\n        new_user = User(id=user_id, username=username, password_hash='')\n        new_user.set_password(password)\n        users[user_id] = new_user\n        \n        flash('注册成功！请登录。', 'success')\n        return redirect(url_for('login'))\n        \n    return render_template('register.html')\n\n@app.route('/login', methods=['GET', 'POST'])\ndef login():\n    if request.method == 'POST':\n        username = request.form.get('username')\n        password = request.form.get('password')\n        \n        user = next((user for user in users.values() if user.username == username), None)\n        \n        if user and user.check_password(password):\n            login_user(user)\n            flash('登录成功！', 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash('用户名或密码错误。', 'error')\n            \n    return render_template('login.html')\n\n@app.route('/dashboard')\n@login_required # 这个装饰器保护路由，只有登录用户才能访问\ndef dashboard():\n    return render_template('dashboard.html', name=current_user.username)\n\n@app.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('你已成功登出。', 'success')\n    return redirect(url_for('index'))\n    \n# --- 之前的路由 ---\n@app.route('/greet', methods=['POST'])\ndef greet():\n    if request.method == 'POST':\n        name = request.form.get('name')\n        if name:\n            return redirect(url_for('hello', name=name))\n        else:\n            return redirect(url_for('index'))\n\n@app.route('/hello/<name>')\ndef hello(name):\n    return render_template('greeting.html', name=name)\n\n@app.route('/api/data')\ndef get_data():\n    data = {'message': 'This is some data from the API.', 'status': 'success'}\n    return data\n\nif __name__ == '__main__':\n    app.run(debug=True)\n```\n\n#### 2. `templates/base.html` - 基础模板\n\n这个模板包含了所有页面共有的部分，如导航栏和页脚，其他模板可以继承它。\n\n```html\n<!-- my_flask_app/templates/base.html -->\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>{% block title %}Flask Auth App{% endblock %}</title>\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n</head>\n<body>\n    <nav>\n        <a href=\"{{ url_for('index') }}\">主页</a>\n        \n        {% if current_user.is_authenticated %}\n            <a href=\"{{ url_for('dashboard') }}\">仪表盘</a>\n            <a href=\"{{ url_for('logout') }}\">登出</a>\n        {% else %}\n            <a href=\"{{ url_for('login') }}\">登录</a>\n            <a href=\"{{ url_for('register') }}\">注册</a>\n        {% endif %}\n    </nav>\n\n    <div class=\"container\">\n        {% with messages = get_flashed_messages(with_categories=true) %}\n            {% if messages %}\n                {% for category, message in messages %}\n                    <div class=\"flash {{ category }}\">{{ message }}</div>\n                {% endfor %}\n            {% endif %}\n        {% endwith %}\n        \n        {% block content %}{% endblock %}\n    </div>\n</body>\n</html>\n```\n\n#### 3. `templates/login.html` - 登录页面\n\n```html\n<!-- my_flask_app/templates/login.html -->\n{% extends \"base.html\" %}\n\n{% block title %}登录{% endblock %}\n\n{% block content %}\n    <h1>登录</h1>\n    <form method=\"post\">\n        <label for=\"username\">用户名:</label>\n        <input type=\"text\" id=\"username\" name=\"username\" required>\n        <br>\n        <label for=\"password\">密码:</label>\n        <input type=\"password\" id=\"password\" name=\"password\" required>\n        <br>\n        <button type=\"submit\">登录</button>\n    </form>\n{% endblock %}\n```\n\n#### 4. `templates/register.html` - 注册页面\n\n```html\n<!-- my_flask_app/templates/register.html -->\n{% extends \"base.html\" %}\n\n{% block title %}注册{% endblock %}\n\n{% block content %}\n    <h1>注册新账户</h1>\n    <form method=\"post\">\n        <label for=\"username\">用户名:</label>\n        <input type=\"text\" id=\"username\" name=\"username\" required>\n        <br>\n        <label for=\"password\">密码:</label>\n        <input type=\"password\" id=\"password\" name=\"password\" required>\n        <br>\n        <button type=\"submit\">注册</button>\n    </form>\n{% endblock %}\n```\n\n#### 5. `templates/dashboard.html` - 仪表盘 (受保护)\n\n这个页面只有登录用户才能看到。\n\n```html\n<!-- my_flask_app/templates/dashboard.html -->\n{% extends \"base.html\" %}\n\n{% block title %}仪表盘{% endblock %}\n\n{% block content %}\n    <h1>你好, {{ name }}!</h1>\n    <p>欢迎来到你的个人仪表盘。这个页面只有登录后才能访问。</p>\n    <a href=\"{{ url_for('logout') }}\">点击这里登出</a>\n{% endblock %}\n```\n\n#### 6. `templates/index.html` - 主页 (已更新)\n\n我们现在让主页继承 `base.html`。\n\n```html\n<!-- my_flask_app/templates/index.html -->\n{% extends \"base.html\" %}\n\n{% block content %}\n    <h1>欢迎来到我的带认证功能的 Flask 应用！</h1>\n    \n    {% if current_user.is_authenticated %}\n        <p>你已经以 <strong>{{ current_user.username }}</strong> 的身份登录了。</p>\n        <p>去你的 <a href=\"{{ url_for('dashboard') }}\">仪表盘</a> 看看吧。</p>\n    {% else %}\n        <p>请先 <a href=\"{{ url_for('login') }}\">登录</a> 或 <a href=\"{{ url_for('register') }}\">注册</a> 一个新账户。</p>\n    {% endif %}\n    \n    <hr>\n    \n    <h3>测试旧的表单功能：</h3>\n    <form action=\"{{ url_for('greet') }}\" method=\"post\">\n        <label for=\"name\">名字:</label>\n        <input type=\"text\" id=\"name\" name=\"name\">\n        <button type=\"submit\">提交</button>\n    </form>\n{% endblock %}\n```\n\n#### 7. `static/style.css` - 样式 (已更新)\n\n添加一些新的样式，特别是为导航栏和消息提示。\n\n```css\n/* my_flask_app/static/style.css */\n\n/* --- 之前的样式 --- */\nbody {\n    font-family: Arial, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    margin: 0;\n    padding: 0;\n}\n\n.container {\n    max-width: 800px;\n    margin: 2em auto;\n    padding: 2em;\n    background-color: white;\n    border-radius: 8px;\n    box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n    text-align: center;\n}\n\nh1, h2 {\n    color: #4a90e2;\n}\n\nform {\n    margin-top: 1.5em;\n}\n\nlabel {\n    display: block; /* 让标签和输入框分行 */\n    margin-top: 1em;\n    margin-bottom: 0.5em;\n    text-align: left;\n}\n\ninput[type=\"text\"], input[type=\"password\"] {\n    width: calc(100% - 22px); /* 100% 减去 padding 和 border */\n    padding: 10px;\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    box-sizing: border-box; /* 保证 padding 不会增加总宽度 */\n}\n\nbutton {\n    margin-top: 1.5em;\n    padding: 10px 20px;\n    background-color: #4a90e2;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 1em;\n}\n\nbutton:hover {\n    background-color: #357abd;\n}\n\n/* --- 新增的样式 --- */\n\nnav {\n    background-color: #333;\n    padding: 1em;\n    text-align: center;\n}\n\nnav a {\n    color: white;\n    text-decoration: none;\n    margin: 0 15px;\n    font-size: 1.1em;\n}\n\nnav a:hover {\n    text-decoration: underline;\n}\n\n.flash {\n    padding: 1em;\n    margin-bottom: 1em;\n    border-radius: 4px;\n    border: 1px solid;\n}\n\n.flash.success {\n    background-color: #d4edda;\n    color: #155724;\n    border-color: #c3e6cb;\n}\n\n.flash.error {\n    background-color: #f8d7da;\n    color: #721c24;\n    border-color: #f5c6cb;\n}\n```\n\n### 第三步：运行和测试\n\n1.  确保你在终端中位于 `my_flask_app` 文件夹的根目录。\n2.  运行应用：\n    ```bash\n    flask run\n    ```\n3.  打开浏览器访问 `http://127.0.0.1:5000`。\n\n**测试流程**：\n*   **注册**：点击导航栏的“注册”链接，填写用户名和密码进行注册。\n*   **登录**：注册成功后，跳转到登录页面，用你刚注册的账户登录。\n*   **访问仪表盘**：登录成功后，你会被重定向到仪表盘。试试直接在地址栏输入 `http://127.0.0.1:5000/dashboard`，你会发现能正常访问。\n*   **登出**：点击“登出”链接，退出登录。\n*   **测试受保护的路由**：登出后，再次尝试访问 `http://127.0.0.1:5000/dashboard`。这次，Flask-Login 会自动将你重定向到登录页面，因为这个路由需要认证。\n\n现在你的 Flask 应用已经具备了完整的用户认证功能！"
  },
  {
    "role": "user",
    "content": "使用 JWT 做 token 认证"
  },
  {
    "role": "assistant",
    "content": "好的，我们来将应用从基于 Session 的认证（Flask-Login）改为基于 **JWT (JSON Web Token)** 的认证。这种方式非常适合构建 API 和前后端分离的应用。\n\n我们将使用 `PyJWT` 库来处理 JWT 的创建和验证。\n\n### JWT 认证流程简介\n\n1.  **用户登录**：用户提供用户名和密码。\n2.  **服务器验证**：服务器验证凭据是否正确。\n3.  **创建 Token**：如果凭据正确，服务器会创建一个包含用户信息（如 `user_id`）和过期时间的 JWT，并使用一个**密钥** 对其进行签名。\n4.  **返回 Token**：服务器将这个签名的 Token 返回给客户端。\n5.  **客户端存储 Token**：客户端（例如，前端 JavaScript 应用）会存储这个 Token（通常在 `localStorage` 或 `Authorization` header 中）。\n6.  **发起受保护请求**：当客户端需要访问受保护的 API 路由时，它必须在请求的 Header 中附带这个 Token，通常是 `Authorization: Bearer <token>`。\n7.  **服务器验证 Token**：服务器在每次收到受保护请求时，都会验证 Token 的签名和过期时间。如果验证通过，则处理请求；如果失败，则返回 `401 Unauthorized` 错误。\n\n---\n\n### 第一步：更新项目文件\n\n我们将完全改变应用的逻辑，专注于提供 API 端点，而不是渲染 HTML 页面。\n\n1.  **安装 PyJWT**：\n    ```bash\n    pip install PyJWT\n    ```\n\n2.  **更新项目结构**：\n    为了演示，我们不再需要 `templates` 文件夹和之前的 HTML 文件。我们将创建一个简单的 `frontend.html` 文件来模拟客户端如何与我们的 API 交互。\n\n    ```\n    my_flask_app/\n    ├── app.py              # 主应用文件，现在是一个 API 服务器\n    ├── frontend.html       # 新增：一个简单的静态HTML文件，用于测试API\n    └── static/             # 存放 CSS 等静态文件\n        └── style.css       # 保留，为 frontend.html 提供样式\n    ```\n\n### 第二步：编写代码\n\n#### 1. `app.py` - JWT API 服务器\n\n这是核心改动。我们将移除所有 Flask-Login 相关的代码，并引入 JWT 的逻辑。\n\n```python\n# my_flask_app/app.py\n\nfrom flask import Flask, request, jsonify, make_response\nimport jwt\nimport datetime\nfrom functools import wraps\nfrom werkzeug.security import generate_password_hash, check_password_hash\n\napp = Flask(__name__)\n\n# 设置一个密钥，用于签名 JWT\n# 在生产环境中，这个密钥应该非常复杂且保密\napp.config['SECRET_KEY'] = 'your_very_secret_and_long_key_for_jwt'\n\n# --- 模拟数据库 ---\n# 我们继续使用字典来模拟用户数据库\n# 密码已经预先哈希，哈希值来自 'password123'\nusers_db = {\n    1: {\"id\": 1, \"username\": \"user1\", \"password\": generate_password_hash(\"password123\")},\n    2: {\"id\": 2, \"username\": \"testuser\", \"password\": generate_password_hash(\"abc\")}\n}\n\n# --- 装饰器：用于保护需要 Token 的路由 ---\ndef token_required(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        token = None\n        \n        # 从 Header 中获取 Token\n        if 'Authorization' in request.headers:\n            auth_header = request.headers['Authorization']\n            try:\n                token = auth_header.split(\" \")[1] # Bearer <token>\n            except IndexError:\n                return jsonify({'message': 'Bearer token malformed'}), 401\n\n        if not token:\n            return jsonify({'message': 'Token is missing!'}), 401\n\n        try:\n            # 解码 Token\n            data = jwt.decode(token, app.config['SECRET_KEY'], algorithms=[\"HS256\"])\n            current_user_id = data['user_id']\n            # 从数据库中查找用户\n            current_user = users_db.get(current_user_id)\n            if not current_user:\n                return jsonify({'message': 'User not found'}), 401\n\n        except jwt.ExpiredSignatureError:\n            return jsonify({'message': 'Token has expired!'}), 401\n        except jwt.InvalidTokenError:\n            return jsonify({'message': 'Token is invalid!'}), 401\n\n        # 将当前用户对象传递给路由函数\n        return f(current_user, *args, **kwargs)\n\n    return decorated\n\n# --- 路由 ---\n\n@app.route('/login', methods=['POST'])\ndef login():\n    \"\"\"用户登录，验证成功后返回 JWT\"\"\"\n    auth = request.get_json()\n\n    if not auth or not auth.get('username') or not auth.get('password'):\n        return make_response(\n            'Could not verify',\n            401,\n            {'WWW-Authenticate': 'Basic realm=\"Login required!\"'}\n        )\n\n    user = next((user for user in users_db.values() if user['username'] == auth['username']), None)\n\n    if not user:\n        return make_response('User not found', 401, {'WWW-Authenticate': 'Basic realm=\"Login required!\"'})\n\n    if check_password_hash(user['password'], auth['password']):\n        # 生成 Token\n        token = jwt.encode({\n            'user_id': user['id'],\n            'exp': datetime.datetime.utcnow() + datetime.timedelta(minutes=30) # Token 有效期30分钟\n        }, app.config['SECRET_KEY'], algorithm=\"HS256\")\n\n        return jsonify({'token': token})\n\n    return make_response('Could not verify', 403, {'WWW-Authenticate': 'Basic realm=\"Login required!\"'})\n\n\n@app.route('/dashboard', methods=['GET'])\n@token_required\ndef dashboard(current_user):\n    \"\"\"受保护的 API 端点，需要有效的 Token 才能访问\"\"\"\n    return jsonify({\n        'message': f'欢迎来到你的仪表盘, {current_user[\"username\"]}!',\n        'user_data': current_user\n    })\n\n# 一个公开的 API 端点，无需 Token\n@app.route('/')\ndef index():\n    return jsonify({'message': '欢迎使用 JWT 认证的 API！'})\n\n\nif __name__ == '__main__':\n    app.run(debug=True)\n```\n\n#### 2. `frontend.html` - 模拟客户端\n\n这个文件不是由 Flask 提供的，它只是一个独立的工具，用来测试我们的 API。你可以用浏览器直接打开它。它使用 JavaScript 的 `fetch` API 来与后端交互。\n\n```html\n<!-- my_flask_app/frontend.html -->\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>JWT 认证测试</title>\n    <link rel=\"stylesheet\" href=\"static/style.css\">\n</head>\n<body>\n    <div class=\"container\">\n        <h1>JWT API 测试</h1>\n\n        <div class=\"form-section\">\n            <h2>1. 登录</h2>\n            <p>使用用户名 <strong>user1</strong> 和密码 <strong>password123</strong> 登录。</p>\n            <button onclick=\"login()\">登录并获取 Token</button>\n            <div id=\"token-display\"></div>\n        </div>\n\n        <hr>\n\n        <div class=\"form-section\">\n            <h2>2. 访问受保护的路由</h2>\n            <p>点击下面的按钮，使用获取到的 Token 访问 /dashboard API。</p>\n            <button onclick=\"fetchDashboard()\">访问仪表盘 API</button>\n            <pre id=\"dashboard-response\">响应将显示在这里...</pre>\n        </div>\n    </div>\n\n    <script>\n        let storedToken = null;\n\n        async function login() {\n            const username = 'user1'; // 可以改为用户输入\n            const password = 'password123'; // 可以改为用户输入\n\n            try {\n                const response = await fetch('http://127.0.0.1:5000/login', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({ username, password })\n                });\n                \n                const data = await response.json();\n\n                if (response.ok) {\n                    storedToken = data.token;\n                    document.getElementById('token-display').innerHTML = `\n                        <p><strong>登录成功！</strong></p>\n                        <p><strong>Token:</strong> ${storedToken.substring(0, 50)}...</p>\n                    `;\n                } else {\n                    document.getElementById('token-display').innerHTML = `<p style=\"color: red;\"><strong>错误:</strong> ${data.message || '未知错误'}</p>`;\n                }\n            } catch (error) {\n                document.getElementById('token-display').innerHTML = `<p style=\"color: red;\">请求失败: ${error.message}</p>`;\n            }\n        }\n\n        async function fetchDashboard() {\n            if (!storedToken) {\n                alert('请先登录获取 Token！');\n                return;\n            }\n\n            try {\n                const response = await fetch('http://127.0.0.1:5000/dashboard', {\n                    method: 'GET',\n                    headers: {\n                        'Authorization': `Bearer ${storedToken}`\n                    }\n                });\n\n                const data = await response.json();\n                document.getElementById('dashboard-response').textContent = JSON.stringify(data, null, 2);\n\n            } catch (error) {\n                document.getElementById('dashboard-response').textContent = `请求失败: ${error.message}`;\n            }\n        }\n    </script>\n</body>\n</html>\n```\n\n#### 3. `static/style.css` - 更新样式\n\n为我们的新前端页面添加一些样式。\n\n```css\n/* my_flask_app/static/style.css */\nbody {\n    font-family: Arial, sans-serif;\n    background-color: #f4f4f9;\n    color: #333;\n    margin: 0;\n    padding: 2em;\n}\n\n.container {\n    max-width: 700px;\n    margin: 0 auto;\n    padding: 2em;\n    background-color: white;\n    border-radius: 8px;\n    box-shadow: 0 4px 8px rgba(0,0,0,0.1);\n    text-align: center;\n}\n\nh1, h2 {\n    color: #4a90e2;\n}\n\nbutton {\n    display: block;\n    width: 100%;\n    padding: 12px;\n    margin-top: 1em;\n    background-color: #4a90e2;\n    color: white;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    font-size: 1em;\n    box-sizing: border-box;\n}\n\nbutton:hover {\n    background-color: #357abd;\n}\n\nhr {\n    border: 0;\n    border-top: 1px solid #eee;\n    margin: 2em 0;\n}\n\n#token-display {\n    margin-top: 1em;\n    padding: 1em;\n    background-color: #e9f7ef;\n    border: 1px solid #c3e6cb;\n    border-radius: 4px;\n    text-align: left;\n    word-break: break-all;\n}\n\n#dashboard-response {\n    margin-top: 1em;\n    text-align: left;\n    background-color: #2d2d2d;\n    color: #f8f8f2;\n    padding: 1.5em;\n    border-radius: 4px;\n    white-space: pre-wrap;\n    font-family: 'Courier New', Courier, monospace;\n    min-height: 100px;\n}\n```\n\n### 第三步：运行和测试\n\n1.  **启动后端 API 服务器**：\n    在终端中，确保你位于 `my_flask_app` 文件夹，然后运行：\n    ```bash\n    flask run\n    ```\n    你的 API 服务器现在在 `http://127.0.0.1:5000` 上运行。\n\n2.  **打开前端测试页面**：\n    **不要**在浏览器中访问 `http://127.0.0.1:5000/frontend.html`，因为我们没有配置 Flask 来提供这个文件。\n    相反，直接在你的文件浏览器中**双击** `frontend.html` 文件，它会在浏览器中打开。\n\n**测试流程**：\n1.  在打开的 `frontend.html` 页面上，点击 **\"登录并获取 Token\"** 按钮。\n2.  按钮下方会显示一个成功消息和获取到的 JWT。\n3.  接下来，点击 **\"访问仪表盘 API\"** 按钮。\n4.  下方的文本框会显示来自 `/dashboard` 端点的成功 JSON 响应，其中包含你的用户数据。\n5.  **测试未授权访问**：清除浏览器缓存或重新打开 `frontend.html`，不登录直接点击 \"访问仪表盘 API\"。你会看到 `{\"message\": \"Token is missing!\"}` 的错误消息。\n\n现在，你已经成功地将你的 Flask 应用转换为一个使用 JWT 进行认证的无状态 API 服务器！"
  }
]